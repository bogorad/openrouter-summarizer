/*! For license information please see pageInteraction.bundle.js.LICENSE.txt */
(()=>{"use strict";var e={d:(n,t)=>{for(var o in t)e.o(t,o)&&!e.o(n,o)&&Object.defineProperty(n,o,{enumerable:!0,get:t[o]})},o:(e,n)=>Object.prototype.hasOwnProperty.call(e,n),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},n={};e.r(n),e.d(n,{cleanupHighlighter:()=>pe,getSelectedElement:()=>se,initializeHighlighter:()=>ue,removeSelectionHighlight:()=>ce,resetHighlightState:()=>le});var t={};e.r(t),e.d(t,{cleanup:()=>Ce,createFloatingIcon:()=>Te,initializeFloatingIcon:()=>Me,removeFloatingIcon:()=>ke});var o={};e.r(o),e.d(o,{cleanup:()=>on,enableButtons:()=>nn,hidePopup:()=>Ze,initializePopupManager:()=>tn,showPopup:()=>Qe,updatePopupContent:()=>en});var r={};function i(e,n){return Array(n+1).join(e)}function a(e){return e.replace(/^\n*/,"")}function l(e){for(var n=e.length;n>0&&"\n"===e[n-1];)n--;return e.substring(0,n)}function c(e){return l(a(e))}e.r(r),e.d(r,{CHAT_SYSTEM_PROMPT_TEMPLATE:()=>On,CHAT_TRANSLATION_REQUEST_TEMPLATE:()=>_n,CHAT_USER_CONTEXT_TEMPLATE:()=>Nn,CONTROLLER_CLEANUP_INTERVAL_MS:()=>Zn,CONTROLLER_TIMEOUT_MS:()=>Qn,DEBOUNCE_DELAY:()=>Yn,DEFAULT_BULLET_COUNT_NUM:()=>Un,DEFAULT_CACHE_EXPIRY_DAYS:()=>qn,DEFAULT_CHAT_QUICK_PROMPTS:()=>Rn,DEFAULT_DEBUG_MODE:()=>Bn,DEFAULT_MAX_REQUEST_PRICE:()=>Jn,DEFAULT_MODEL_OPTIONS:()=>Pn,DEFAULT_PREPOPULATE_LANGUAGES:()=>In,DEFAULT_SELECTED_CHAT_MODEL_ID:()=>jn,DEFAULT_SELECTED_SUMMARY_MODEL_ID:()=>Fn,DEFAULT_SUMMARY_HISTORY_COUNT:()=>Gn,DEFAULT_XML_PROMPT_TEMPLATE:()=>xn,ERROR_API_KEY_INVALID:()=>ut,ERROR_BAD_REQUEST:()=>ft,ERROR_CONTENT_FILTERED:()=>pt,ERROR_NETWORK:()=>lt,ERROR_NO_API_KEY:()=>it,ERROR_NO_MODEL:()=>at,ERROR_RATE_LIMIT:()=>st,ERROR_SERVER_ERROR:()=>mt,ERROR_TIMEOUT:()=>ct,ERROR_UNKNOWN:()=>dt,FALLBACK_SVG_PATH:()=>zn,JOPLIN_API_BASE_URL:()=>Mn,JOPLIN_API_FOLDERS_ENDPOINT:()=>Cn,JOPLIN_API_NOTES_ENDPOINT:()=>Sn,LANGUAGES_JSON_PATH:()=>Dn,LANGUAGE_DETECTION_MODELS:()=>vt,MAX_ACTIVE_CONTROLLERS:()=>Vn,MAX_ERROR_LOG_ENTRIES:()=>rt,MAX_RETRIES:()=>Wn,MIN_MARKDOWN_LENGTH:()=>gt,NOTIFICATION_TIMEOUT_CRITICAL_MS:()=>tt,NOTIFICATION_TIMEOUT_MINOR_MS:()=>et,NOTIFICATION_TIMEOUT_SUCCESS_MS:()=>nt,OPENROUTER_API_URL:()=>Kn,REQUEST_TIMEOUT:()=>Xn,RETRY_DELAY:()=>$n,SNIPPET_TRUNCATION_LIMIT:()=>ot,STORAGE_KEY_ALSO_SEND_TO_JOPLIN:()=>hn,STORAGE_KEY_ALWAYS_USE_US_ENGLISH:()=>yn,STORAGE_KEY_API_KEY:()=>rn,STORAGE_KEY_API_KEY_LOCAL:()=>wn,STORAGE_KEY_BULLET_COUNT:()=>un,STORAGE_KEY_CHAT_MODEL_ID:()=>cn,STORAGE_KEY_CHAT_QUICK_PROMPTS:()=>vn,STORAGE_KEY_DEBUG:()=>sn,STORAGE_KEY_JOPLIN_TOKEN:()=>gn,STORAGE_KEY_JOPLIN_TOKEN_LOCAL:()=>kn,STORAGE_KEY_KNOWN_MODELS_AND_PRICES:()=>fn,STORAGE_KEY_LANGUAGE_INFO:()=>dn,STORAGE_KEY_MAX_REQUEST_PRICE:()=>pn,STORAGE_KEY_MODELS:()=>an,STORAGE_KEY_NEWSBLUR_TOKEN:()=>mn,STORAGE_KEY_NEWSBLUR_TOKEN_LOCAL:()=>Tn,STORAGE_KEY_PROMPT_TEMPLATE:()=>An,STORAGE_KEY_SUMMARY_MODEL_ID:()=>ln,SVG_PATH_PREFIX:()=>Hn,TOKENS_PER_CHAR:()=>ht,TOKENS_PER_KB:()=>yt,VALID_LANGUAGE_CODES:()=>bn,isValidLanguageCode:()=>Ln,sanitizeLanguageCode:()=>En});var s=["ADDRESS","ARTICLE","ASIDE","AUDIO","BLOCKQUOTE","BODY","CANVAS","CENTER","DD","DIR","DIV","DL","DT","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","FRAMESET","H1","H2","H3","H4","H5","H6","HEADER","HGROUP","HR","HTML","ISINDEX","LI","MAIN","MENU","NAV","NOFRAMES","NOSCRIPT","OL","OUTPUT","P","PRE","SECTION","TABLE","TBODY","TD","TFOOT","TH","THEAD","TR","UL"];function u(e){return m(e,s)}var d=["AREA","BASE","BR","COL","COMMAND","EMBED","HR","IMG","INPUT","KEYGEN","LINK","META","PARAM","SOURCE","TRACK","WBR"];function p(e){return m(e,d)}var f=["A","TABLE","THEAD","TBODY","TFOOT","TH","TD","IFRAME","SCRIPT","AUDIO","VIDEO"];function m(e,n){return n.indexOf(e.nodeName)>=0}function g(e,n){return e.getElementsByTagName&&n.some(function(n){return e.getElementsByTagName(n).length})}var h={};function y(e){return e?e.replace(/(\n+\s*)+/g,"\n"):""}function v(e){for(var n in this.options=e,this._keep=[],this._remove=[],this.blankRule={replacement:e.blankReplacement},this.keepReplacement=e.keepReplacement,this.defaultRule={replacement:e.defaultReplacement},this.array=[],e.rules)this.array.push(e.rules[n])}function b(e,n,t){for(var o=0;o<e.length;o++){var r=e[o];if(L(r,n,t))return r}}function L(e,n,t){var o=e.filter;if("string"==typeof o){if(o===n.nodeName.toLowerCase())return!0}else if(Array.isArray(o)){if(o.indexOf(n.nodeName.toLowerCase())>-1)return!0}else{if("function"!=typeof o)throw new TypeError("`filter` needs to be a string, array, or function");if(o.call(e,n,t))return!0}}function E(e){var n=e.nextSibling||e.parentNode;return e.parentNode.removeChild(e),n}function w(e,n,t){return e&&e.parentNode===n||t(n)?n.nextSibling||n.parentNode:n.firstChild||n.nextSibling||n.parentNode}h.paragraph={filter:"p",replacement:function(e){return"\n\n"+e+"\n\n"}},h.lineBreak={filter:"br",replacement:function(e,n,t){return t.br+"\n"}},h.heading={filter:["h1","h2","h3","h4","h5","h6"],replacement:function(e,n,t){var o=Number(n.nodeName.charAt(1));return"setext"===t.headingStyle&&o<3?"\n\n"+e+"\n"+i(1===o?"=":"-",e.length)+"\n\n":"\n\n"+i("#",o)+" "+e+"\n\n"}},h.blockquote={filter:"blockquote",replacement:function(e){return"\n\n"+(e=c(e).replace(/^/gm,"> "))+"\n\n"}},h.list={filter:["ul","ol"],replacement:function(e,n){var t=n.parentNode;return"LI"===t.nodeName&&t.lastElementChild===n?"\n"+e:"\n\n"+e+"\n\n"}},h.listItem={filter:"li",replacement:function(e,n,t){var o=t.bulletListMarker+"   ",r=n.parentNode;if("OL"===r.nodeName){var i=r.getAttribute("start"),a=Array.prototype.indexOf.call(r.children,n);o=(i?Number(i)+a:a+1)+".  "}var l=/\n$/.test(e);return o+(e=(e=c(e)+(l?"\n":"")).replace(/\n/gm,"\n"+" ".repeat(o.length)))+(n.nextSibling?"\n":"")}},h.indentedCodeBlock={filter:function(e,n){return"indented"===n.codeBlockStyle&&"PRE"===e.nodeName&&e.firstChild&&"CODE"===e.firstChild.nodeName},replacement:function(e,n,t){return"\n\n    "+n.firstChild.textContent.replace(/\n/g,"\n    ")+"\n\n"}},h.fencedCodeBlock={filter:function(e,n){return"fenced"===n.codeBlockStyle&&"PRE"===e.nodeName&&e.firstChild&&"CODE"===e.firstChild.nodeName},replacement:function(e,n,t){for(var o,r=((n.firstChild.getAttribute("class")||"").match(/language-(\S+)/)||[null,""])[1],a=n.firstChild.textContent,l=t.fence.charAt(0),c=3,s=new RegExp("^"+l+"{3,}","gm");o=s.exec(a);)o[0].length>=c&&(c=o[0].length+1);var u=i(l,c);return"\n\n"+u+r+"\n"+a.replace(/\n$/,"")+"\n"+u+"\n\n"}},h.horizontalRule={filter:"hr",replacement:function(e,n,t){return"\n\n"+t.hr+"\n\n"}},h.inlineLink={filter:function(e,n){return"inlined"===n.linkStyle&&"A"===e.nodeName&&e.getAttribute("href")},replacement:function(e,n){var t=n.getAttribute("href");t&&(t=t.replace(/([()])/g,"\\$1"));var o=y(n.getAttribute("title"));return o&&(o=' "'+o.replace(/"/g,'\\"')+'"'),"["+e+"]("+t+o+")"}},h.referenceLink={filter:function(e,n){return"referenced"===n.linkStyle&&"A"===e.nodeName&&e.getAttribute("href")},replacement:function(e,n,t){var o,r,i=n.getAttribute("href"),a=y(n.getAttribute("title"));switch(a&&(a=' "'+a+'"'),t.linkReferenceStyle){case"collapsed":o="["+e+"][]",r="["+e+"]: "+i+a;break;case"shortcut":o="["+e+"]",r="["+e+"]: "+i+a;break;default:var l=this.references.length+1;o="["+e+"]["+l+"]",r="["+l+"]: "+i+a}return this.references.push(r),o},references:[],append:function(e){var n="";return this.references.length&&(n="\n\n"+this.references.join("\n")+"\n\n",this.references=[]),n}},h.emphasis={filter:["em","i"],replacement:function(e,n,t){return e.trim()?t.emDelimiter+e+t.emDelimiter:""}},h.strong={filter:["strong","b"],replacement:function(e,n,t){return e.trim()?t.strongDelimiter+e+t.strongDelimiter:""}},h.code={filter:function(e){var n=e.previousSibling||e.nextSibling,t="PRE"===e.parentNode.nodeName&&!n;return"CODE"===e.nodeName&&!t},replacement:function(e){if(!e)return"";e=e.replace(/\r?\n|\r/g," ");for(var n=/^`|^ .*?[^ ].* $|`$/.test(e)?" ":"",t="`",o=e.match(/`+/gm)||[];-1!==o.indexOf(t);)t+="`";return t+n+e+n+t}},h.image={filter:"img",replacement:function(e,n){var t=y(n.getAttribute("alt")),o=n.getAttribute("src")||"",r=y(n.getAttribute("title"));return o?"!["+t+"]("+o+(r?' "'+r+'"':"")+")":""}},v.prototype={add:function(e,n){this.array.unshift(n)},keep:function(e){this._keep.unshift({filter:e,replacement:this.keepReplacement})},remove:function(e){this._remove.unshift({filter:e,replacement:function(){return""}})},forNode:function(e){return e.isBlank?this.blankRule:(n=b(this.array,e,this.options))||(n=b(this._keep,e,this.options))||(n=b(this._remove,e,this.options))?n:this.defaultRule;var n},forEach:function(e){for(var n=0;n<this.array.length;n++)e(this.array[n],n)}};var T,k,M="undefined"!=typeof window?window:{},C=function(){var e=M.DOMParser,n=!1;try{(new e).parseFromString("","text/html")&&(n=!0)}catch(e){}return n}()?M.DOMParser:(T=function(){},function(){var e=!1;try{document.implementation.createHTMLDocument("").open()}catch(n){M.ActiveXObject&&(e=!0)}return e}()?T.prototype.parseFromString=function(e){var n=new window.ActiveXObject("htmlfile");return n.designMode="on",n.open(),n.write(e),n.close(),n}:T.prototype.parseFromString=function(e){var n=document.implementation.createHTMLDocument("");return n.open(),n.write(e),n.close(),n},T);function S(e,n){var t;return function(e){var n=e.element,t=e.isBlock,o=e.isVoid,r=e.isPre||function(e){return"PRE"===e.nodeName};if(n.firstChild&&!r(n)){for(var i=null,a=!1,l=null,c=w(l,n,r);c!==n;){if(3===c.nodeType||4===c.nodeType){var s=c.data.replace(/[ \r\n\t]+/g," ");if(i&&!/ $/.test(i.data)||a||" "!==s[0]||(s=s.substr(1)),!s){c=E(c);continue}c.data=s,i=c}else{if(1!==c.nodeType){c=E(c);continue}t(c)||"BR"===c.nodeName?(i&&(i.data=i.data.replace(/ $/,"")),i=null,a=!1):o(c)||r(c)?(i=null,a=!0):i&&(a=!1)}var u=w(l,c,r);l=c,c=u}i&&(i.data=i.data.replace(/ $/,""),i.data||E(i))}}({element:t="string"==typeof e?(k=k||new C).parseFromString('<x-turndown id="turndown-root">'+e+"</x-turndown>","text/html").getElementById("turndown-root"):e.cloneNode(!0),isBlock:u,isVoid:p,isPre:n.preformattedCode?A:null}),t}function A(e){return"PRE"===e.nodeName||"CODE"===e.nodeName}function x(e,n){return e.isBlock=u(e),e.isCode="CODE"===e.nodeName||e.parentNode.isCode,e.isBlank=function(e){return!p(e)&&!function(e){return m(e,f)}(e)&&/^\s*$/i.test(e.textContent)&&!function(e){return g(e,d)}(e)&&!function(e){return g(e,f)}(e)}(e),e.flankingWhitespace=function(e,n){if(e.isBlock||n.preformattedCode&&e.isCode)return{leading:"",trailing:""};var t,o={leading:(t=e.textContent.match(/^(([ \t\r\n]*)(\s*))(?:(?=\S)[\s\S]*\S)?((\s*?)([ \t\r\n]*))$/))[1],leadingAscii:t[2],leadingNonAscii:t[3],trailing:t[4],trailingNonAscii:t[5],trailingAscii:t[6]};return o.leadingAscii&&O("left",e,n)&&(o.leading=o.leadingNonAscii),o.trailingAscii&&O("right",e,n)&&(o.trailing=o.trailingNonAscii),{leading:o.leading,trailing:o.trailing}}(e,n),e}function O(e,n,t){var o,r,i;return"left"===e?(o=n.previousSibling,r=/ $/):(o=n.nextSibling,r=/^ /),o&&(3===o.nodeType?i=r.test(o.nodeValue):t.preformattedCode&&"CODE"===o.nodeName?i=!1:1!==o.nodeType||u(o)||(i=r.test(o.textContent))),i}var N=Array.prototype.reduce,_=[[/\\/g,"\\\\"],[/\*/g,"\\*"],[/^-/g,"\\-"],[/^\+ /g,"\\+ "],[/^(=+)/g,"\\$1"],[/^(#{1,6}) /g,"\\$1 "],[/`/g,"\\`"],[/^~~~/g,"\\~~~"],[/\[/g,"\\["],[/\]/g,"\\]"],[/^>/g,"\\>"],[/_/g,"\\_"],[/^(\d+)\. /g,"$1\\. "]];function R(e){if(!(this instanceof R))return new R(e);var n={rules:h,headingStyle:"setext",hr:"* * *",bulletListMarker:"*",codeBlockStyle:"indented",fence:"```",emDelimiter:"_",strongDelimiter:"**",linkStyle:"inlined",linkReferenceStyle:"full",br:"  ",preformattedCode:!1,blankReplacement:function(e,n){return n.isBlock?"\n\n":""},keepReplacement:function(e,n){return n.isBlock?"\n\n"+n.outerHTML+"\n\n":n.outerHTML},defaultReplacement:function(e,n){return n.isBlock?"\n\n"+e+"\n\n":e}};this.options=function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])}return e}({},n,e),this.rules=new v(this.options)}function P(e){var n=this;return N.call(e.childNodes,function(e,t){var o="";return 3===(t=new x(t,n.options)).nodeType?o=t.isCode?t.nodeValue:n.escape(t.nodeValue):1===t.nodeType&&(o=D.call(n,t)),H(e,o)},"")}function I(e){var n=this;return this.rules.forEach(function(t){"function"==typeof t.append&&(e=H(e,t.append(n.options)))}),e.replace(/^[\t\r\n]+/,"").replace(/[\t\r\n\s]+$/,"")}function D(e){var n=this.rules.forNode(e),t=P.call(this,e),o=e.flankingWhitespace;return(o.leading||o.trailing)&&(t=t.trim()),o.leading+n.replacement(t,e,this.options)+o.trailing}function H(e,n){var t=l(e),o=a(n),r=Math.max(e.length-t.length,n.length-o.length);return t+"\n\n".substring(0,r)+o}R.prototype={turndown:function(e){if(!function(e){return null!=e&&("string"==typeof e||e.nodeType&&(1===e.nodeType||9===e.nodeType||11===e.nodeType))}(e))throw new TypeError(e+" is not a string, or an element/document/fragment node.");if(""===e)return"";var n=P.call(this,new S(e,this.options));return I.call(this,n)},use:function(e){if(Array.isArray(e))for(var n=0;n<e.length;n++)this.use(e[n]);else{if("function"!=typeof e)throw new TypeError("plugin must be a Function or an Array of Functions");e(this)}return this},addRule:function(e,n){return this.rules.add(e,n),this},keep:function(e){return this.rules.keep(e),this},remove:function(e){return this.rules.remove(e),this},escape:function(e){return _.reduce(function(e,n){return e.replace(n[0],n[1])},e)}};const z=R;var F=function(e){for(var n,t=arguments.length,o=new Array(t>1?t-1:0),r=1;r<t;r++)o[r-1]=arguments[r];(n=console).log.apply(n,[e].concat(o))},j=function(e){for(var n,t=arguments.length,o=new Array(t>1?t-1:0),r=1;r<t;r++)o[r-1]=arguments[r];(n=console).warn.apply(n,[e].concat(o))},U=function(e){for(var n,t=arguments.length,o=new Array(t>1?t-1:0),r=1;r<t;r++)o[r-1]=arguments[r];(n=console).error.apply(n,[e].concat(o))};F("[LLM Utils]","Loaded");var B=null;function G(e){var n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=document.getElementById("llm-notification-container");if(o){o.innerHTML="";var r=document.createElement("div");r.className="llm-notification-message",r.textContent=e,o.appendChild(r),t>0&&setTimeout(function(){r&&o.contains(r)&&o.removeChild(r)},t)}else{var i=document.getElementById("errorDisplay");if(!i)return void U("[LLM Utils]","No error display element found on this page. Cannot show error:",e);i.textContent=e,i.style.display="block",B&&clearTimeout(B),t>0&&(B=setTimeout(function(){i.textContent="",i.style.display="none"},t))}if(n){var a=document.getElementById("chatInput"),l=document.querySelector('#chatForm button[type="submit"]');a&&(a.disabled=!0),l&&(l.disabled=!0)}}console.log("[LLM Highlighter] Script Loaded (v3.0.3)");var J="llm-highlight-preview",q="llm-highlight",K=!1,Y=null,W=null,$=null,X=null,V=!1,Q=[],Z=function(e,n,t,o){e.addEventListener(n,t,o),Q.push({element:e,event:n,handler:t,options:o})};function ee(e){return e.altKey&&!e.shiftKey&&!e.ctrlKey}function ne(e){if("Alt"===e.key&&!K){var n=document.activeElement;if(n&&("INPUT"===n.tagName||"TEXTAREA"===n.tagName||n.isContentEditable))return void(V&&console.log("[LLM Highlighter] Ignoring Alt down in input/editable element."));K=!0,V&&console.log("[LLM Highlighter] Alt key down.")}}function te(e){"Alt"===e.key&&(V&&console.log("[LLM Highlighter] Alt key up."),W||le())}function oe(e){if(K){var n=document.elementFromPoint(e.clientX,e.clientY);if(!n||n.closest(".summarizer-popup")||n.closest(".llm-floating-icon"))ae();else{if((n===document.body||n===document.documentElement)&&document.elementsFromPoint(e.clientX,e.clientY).length>1){var t=document.elementsFromPoint(e.clientX,e.clientY)[1];if(!t||t.closest(".summarizer-popup")||t.closest(".llm-floating-icon"))return void ae();n=t}n!==W?(Y||ee(e))&&Y!==n&&(ae(),(Y=n)&&Y.classList.add(J)):ae()}}else ae()}function re(e){!e.relatedTarget&&Y&&(V&&console.log("[LLM Highlighter] Mouse left window."),ae())}function ie(e){if(e.target.closest('[data-extension-ui="true"]'))V&&console.log("[LLM Highlighter] Mousedown ignored on extension UI.");else{if(0===e.button&&ee(e)){e.preventDefault(),e.stopPropagation();var n=e.target;return ae(),void(W===n?(V&&console.log("[LLM Highlighter] Deselecting element."),ce(),le(),X&&X()):n?(V&&console.log("[LLM Highlighter] Selecting element:",n),ce(),(W=n).classList.add(q),le(),$&&$(W,e.pageX,e.pageY)):(V&&console.warn("[LLM Highlighter] Alt+Click target invalid."),ce(),le()))}e.altKey||0!==e.button||W&&!W.contains(e.target)&&(V&&console.log("[LLM Highlighter] Click outside detected. Deselecting."),ce(),le(),X&&X())}}function ae(){Y&&(document.body.contains(Y)&&Y.classList.remove(J),Y=null)}function le(){V&&console.log("[LLM Highlighter] Resetting highlight state."),K=!1,ae()}function ce(){W&&(document.body.contains(W)&&W.classList.remove(q),V&&console.log("[LLM Highlighter] Selection highlight removed."),W=null)}function se(){return W}function ue(e){e&&"function"==typeof e.onElementSelected&&"function"==typeof e.onElementDeselected?($=e.onElementSelected,X=e.onElementDeselected,V=!!e.initialDebugState,Z(window,"keydown",ne,!0),Z(window,"keyup",te,!0),Z(window,"blur",le),Z(document,"visibilitychange",de),Z(document,"mousemove",oe,!0),Z(window,"mouseout",re),Z(document,"mousedown",ie,!0),V&&console.log("[LLM Highlighter] Initialized.")):console.error("[LLM Highlighter] Initialization failed: Required callbacks missing.")}var de=function(){"hidden"===document.visibilityState&&le()},pe=function(){Q.forEach(function(e){var n=e.element,t=e.event,o=e.handler,r=e.options;try{n.removeEventListener(t,o,r)}catch(e){}}),Q=[],K=!1,ae(),ce(),W=null,$=null,X=null,V&&console.log("[LLM Highlighter] Cleaned up.")};console.log("[LLM FloatingIcon] Script Loaded (v2.41.0 - ShadowDOM)");var fe="llm-floating-icon",me="llm-fallback-icon",ge=null,he=null,ye=null,ve=null,be=null,Le=!1;function Ee(e){e.stopPropagation(),e.preventDefault(),Le&&console.log("[LLM FloatingIcon] Icon clicked."),ve&&ve()}function we(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),Le&&console.log("[LLM FloatingIcon] Icon activated via keyboard."),ve&&ve()),"Escape"===e.key&&(e.preventDefault(),e.stopPropagation(),Le&&console.log("[LLM FloatingIcon] Icon dismissed via Escape."),ke(),be&&be())}function Te(e,n,t,o,r,i,a,l){if(ke(),"function"==typeof t&&"function"==typeof o&&"function"==typeof r&&"function"==typeof a){ve=t,be=o,(ge=document.createElement("div")).id="summarizer-floating-host",ge.setAttribute("data-extension-ui","true"),ge.style.cssText="\n    position: absolute;\n    top: 0;\n    left: 0;\n    width: 0;\n    height: 0;\n    overflow: visible;\n    z-index: 2147483646;\n  ",he=ge.attachShadow({mode:"open"}),(ye=document.createElement("div")).className=fe,ye.setAttribute("aria-label","Summarize this element"),ye.setAttribute("role","button"),ye.setAttribute("tabindex","0"),ye.title="Summarize this element (Click or press Enter)",ye.style.display="flex",ye.style.alignItems="center",ye.style.backgroundColor="rgba(255, 255, 255, 0.9)",ye.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)";var c=1+(i?1:0)+(l?1:0);c>1?(ye.style.gap="8px",ye.style.borderRadius="30px",ye.style.padding="8px 16px"):(ye.style.gap="0px",ye.style.borderRadius="50%",ye.style.padding="8px");var s="";try{if("undefined"==typeof chrome||!chrome.runtime||"function"!=typeof chrome.runtime.getURL)throw new Error("chrome.runtime API not available");s=chrome.runtime.getURL("icons/icon32.png")}catch(e){console.warn("[LLM FloatingIcon] Could not get icon URL",e),s=""}var u=document.createElement("img");u.src=s,u.alt="Summarize",u.style.pointerEvents="none",u.style.width="32px",u.style.height="32px",u.onerror=function(){if(u.style.display="none",ye&&!ye.querySelector(".".concat(me))){var e=document.createElement("span");e.className=me,e.textContent="ðŸ’¡",e.style.pointerEvents="none",ye.appendChild(e),Le&&console.warn("[LLM FloatingIcon] Failed to load icon image, using fallback.")}},s||u.onerror();var d=document.createElement("div");if(d.style.display="flex",d.style.alignItems="center",d.appendChild(u),ye.appendChild(d),i){var p=document.createElement("div");p.id="llm-joplin-icon-wrapper",p.className="llm-floating-icon-item",p.setAttribute("role","button"),p.setAttribute("tabindex","0"),p.title="Send to Joplin",p.style.cursor="pointer",p.style.backgroundColor="transparent",p.style.borderRadius="50%",p.style.width="32px",p.style.height="32px",p.style.display="flex",p.style.justifyContent="center",p.style.alignItems="center",p.style.boxShadow="none";var f=document.createElement("img");f.src=chrome.runtime.getURL("icons/scissors.svg"),f.alt="Joplin",f.style.width="24px",f.style.height="24px",f.style.pointerEvents="none",p.onclick=function(e){e.stopPropagation(),e.preventDefault(),Le&&console.log("[LLM FloatingIcon] Joplin icon clicked."),r&&r()},p.onkeydown=function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),Le&&console.log("[LLM FloatingIcon] Joplin icon activated via keyboard."),r&&r())},p.appendChild(f),ye.appendChild(p)}if(l){var m=document.createElement("div");m.id="llm-copy-html-icon-wrapper",m.className="llm-floating-icon-item",m.setAttribute("role","button"),m.setAttribute("tabindex","0"),m.title="Copy element HTML",m.style.cursor="pointer",m.style.backgroundColor="transparent",m.style.borderRadius="50%",m.style.width="32px",m.style.height="32px",m.style.display="flex",m.style.justifyContent="center",m.style.alignItems="center",m.style.boxShadow="none";var g=document.createElement("img");g.src=chrome.runtime.getURL("icons/copy-html.svg"),g.alt="Copy HTML",g.style.width="24px",g.style.height="24px",g.style.pointerEvents="none",m.onclick=function(e){e.stopPropagation(),e.preventDefault(),Le&&console.log("[LLM FloatingIcon] Copy HTML icon clicked."),a&&a()},m.onkeydown=function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),Le&&console.log("[LLM FloatingIcon] Copy HTML icon activated via keyboard."),a&&a())},m.appendChild(g),ye.appendChild(m)}ye.style.whiteSpace="nowrap";var h=48;c>1&&(h=32*c+8*(c-1)+32),ye.style.width="".concat(h,"px"),ye.style.height="".concat(48,"px"),he.appendChild(ye),document.body.appendChild(ge);var y=ye.getBoundingClientRect(),v=y.width,b=y.height,L=e-v/2,E=n-b/2;L=Math.max(window.scrollX+5,Math.min(L,window.scrollX+window.innerWidth-v-5)),E=Math.max(window.scrollY+5,Math.min(E,window.scrollY+window.innerHeight-b-5)),ge.style.left="".concat(L,"px"),ge.style.top="".concat(E,"px"),ye.addEventListener("click",Ee),ye.addEventListener("keydown",we),Le&&console.log("[LLM FloatingIcon] Icon created at",L,E);var w=ye;requestAnimationFrame(function(){if(w&&w.isConnected)try{w.focus({preventScroll:!0})}catch(e){}})}else console.error("[LLM FloatingIcon] createFloatingIcon failed: Required callbacks missing.")}function ke(){ge&&(ye&&(ye.removeEventListener("click",Ee),ye.removeEventListener("keydown",we)),ge.parentNode&&ge.parentNode.removeChild(ge),ge=null,he=null,ye=null,Le&&console.log("[LLM FloatingIcon] Icon removed.")),ve=null,be=null}function Me(e){(Le=!(null==e||!e.initialDebugState))&&console.log("[LLM FloatingIcon] Initialized.")}function Ce(){ke()}function Se(){var e,n,t="function"==typeof Symbol?Symbol:{},o=t.iterator||"@@iterator",r=t.toStringTag||"@@toStringTag";function i(t,o,r,i){var c=o&&o.prototype instanceof l?o:l,s=Object.create(c.prototype);return Ae(s,"_invoke",function(t,o,r){var i,l,c,s=0,u=r||[],d=!1,p={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(n,t){return i=n,l=0,c=e,p.n=t,a}};function f(t,o){for(l=t,c=o,n=0;!d&&s&&!r&&n<u.length;n++){var r,i=u[n],f=p.p,m=i[2];t>3?(r=m===o)&&(c=i[(l=i[4])?5:(l=3,3)],i[4]=i[5]=e):i[0]<=f&&((r=t<2&&f<i[1])?(l=0,p.v=o,p.n=i[1]):f<m&&(r=t<3||i[0]>o||o>m)&&(i[4]=t,i[5]=o,p.n=m,l=0))}if(r||t>1)return a;throw d=!0,o}return function(r,u,m){if(s>1)throw TypeError("Generator is already running");for(d&&1===u&&f(u,m),l=u,c=m;(n=l<2?e:c)||!d;){i||(l?l<3?(l>1&&(p.n=-1),f(l,c)):p.n=c:p.v=c);try{if(s=2,i){if(l||(r="next"),n=i[r]){if(!(n=n.call(i,c)))throw TypeError("iterator result is not an object");if(!n.done)return n;c=n.value,l<2&&(l=0)}else 1===l&&(n=i.return)&&n.call(i),l<2&&(c=TypeError("The iterator does not provide a '"+r+"' method"),l=1);i=e}else if((n=(d=p.n<0)?c:t.call(o,p))!==a)break}catch(n){i=e,l=1,c=n}finally{s=1}}return{value:n,done:d}}}(t,r,i),!0),s}var a={};function l(){}function c(){}function s(){}n=Object.getPrototypeOf;var u=[][o]?n(n([][o]())):(Ae(n={},o,function(){return this}),n),d=s.prototype=l.prototype=Object.create(u);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,s):(e.__proto__=s,Ae(e,r,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=s,Ae(d,"constructor",s),Ae(s,"constructor",c),c.displayName="GeneratorFunction",Ae(s,r,"GeneratorFunction"),Ae(d),Ae(d,r,"Generator"),Ae(d,o,function(){return this}),Ae(d,"toString",function(){return"[object Generator]"}),(Se=function(){return{w:i,m:p}})()}function Ae(e,n,t,o){var r=Object.defineProperty;try{r({},"",{})}catch(e){r=0}Ae=function(e,n,t,o){function i(n,t){Ae(e,n,function(e){return this._invoke(n,t,e)})}n?r?r(e,n,{value:t,enumerable:!o,configurable:!o,writable:!o}):e[n]=t:(i("next",0),i("throw",1),i("return",2))},Ae(e,n,t,o)}function xe(e,n,t,o,r,i,a){try{var l=e[i](a),c=l.value}catch(e){return void t(e)}l.done?n(c):Promise.resolve(c).then(o,r)}var Oe='\n  /* --- Globals --- */\n  :host {\n    all: initial; /* Reset all inherited styles */\n    display: block;\n    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", "Segoe UI Emoji", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", "Noto Color Emoji", sans-serif !important;\n  }\n\n  /* --- Main Popup Container --- */\n  .summarizer-popup {\n    position: fixed;\n    top: 10vh;\n    left: 50%;\n    transform: translateX(-50%);\n    z-index: 2147483647;\n    display: flex;\n    flex-direction: column;\n    width: auto;\n    max-width: 750px;\n    min-width: 320px;\n    height: min-content;\n    background-color: #ffffff;\n    border: 1.5px solid #2196F3;\n    border-radius: 14px;\n    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);\n    color: #333;\n    font-size: 16px;\n    overflow: hidden;\n    opacity: 0;\n    transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;\n    transform: translateX(-50%) translateY(-10px);\n  }\n\n  .summarizer-popup.visible {\n    opacity: 1;\n    transform: translateX(-50%) translateY(0);\n  }\n\n  /* --- Popup Header Container --- */\n  .summarizer-header-container {\n    padding: 14px 20px;\n    background-color: #2196F3;\n    color: #ffffff;\n    flex-shrink: 0;\n    margin: 0;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    position: relative;\n  }\n\n  /* --- Popup Header (Summary Title) --- */\n  .summarizer-header {\n    font-size: 1.1em;\n    font-weight: 600;\n    margin: 0;\n    text-align: center;\n  }\n\n  /* --- Popup Body (Main Content Area) --- */\n  .summarizer-body {\n    padding: 18px 20px;\n    background-color: #f7faff;\n    color: #1e2333;\n    font-size: 1em;\n    line-height: 1.6;\n    min-height: 50px;\n    max-height: 65vh;\n    overflow-y: auto;\n    word-wrap: break-word;\n    border-radius: 0;\n    margin: 0;\n  }\n\n  .summarizer-body ul {\n    padding-left: 20px;\n    margin: 0.5em 0;\n  }\n  .summarizer-body li {\n    margin-bottom: 0.6em;\n  }\n  .summarizer-body b,\n  .summarizer-body strong {\n    font-weight: 600;\n  }\n  .summarizer-body i,\n  .summarizer-body em {\n    font-style: italic;\n  }\n\n  /* --- Popup Actions (Footer with Buttons) --- */\n  .summarizer-actions {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    gap: 12px;\n    padding: 15px 20px;\n    background-color: #f7faff;\n    border-top: 1px solid #e0e8f0;\n    flex-shrink: 0;\n    margin: 0;\n  }\n\n  /* --- Buttons (Base Style) --- */\n  .summarizer-btn {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    padding: 8px 16px;\n    border: none;\n    border-radius: 6px;\n    font-size: 0.95em;\n    font-weight: 500;\n    font-family: inherit;\n    cursor: pointer;\n    text-align: center;\n    white-space: nowrap;\n    transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;\n    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);\n    vertical-align: middle;\n    height: 36px;\n    min-width: 40px;\n  }\n  .summarizer-btn:hover {\n    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);\n    transform: translateY(-1px);\n  }\n  .summarizer-btn:active {\n    transform: translateY(0px);\n    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);\n  }\n  .summarizer-btn:disabled {\n    background-color: #bdbdbd !important;\n    color: #757575 !important;\n    cursor: not-allowed;\n    box-shadow: none;\n    transform: none;\n    opacity: 0.7;\n  }\n  .summarizer-btn img {\n    height: 1.2em;\n    width: auto;\n    display: block;\n    max-width: 100%;\n  }\n\n  /* Specific Button Colors */\n  .summarizer-btn.copy-btn { background-color: #1976D2; color: #ffffff; padding: 8px 20px; }\n  .summarizer-btn.copy-btn:hover:not(:disabled) { background-color: #1565C0; }\n  .summarizer-btn.chat-btn { background-color: #28a745; color: #ffffff; padding: 8px 20px; }\n  .summarizer-btn.chat-btn:hover:not(:disabled) { background-color: #218838; }\n  .summarizer-btn.close-btn { background-color: #e53935; color: #ffffff; padding: 8px 20px; }\n  .summarizer-btn.close-btn:hover:not(:disabled) { background-color: #d32f2f; }\n  .summarizer-btn.newsblur-btn { background-color: #8B4513; color: #ffffff; padding: 8px 20px; }\n  .summarizer-btn.newsblur-btn:hover:not(:disabled) { background-color: #652a0d; }\n\n  /* --- Responsive Adjustments --- */\n  @media (max-width: 780px) {\n    .summarizer-popup {\n      width: 95vw;\n      max-width: 95vw;\n      min-width: 95vw;\n      top: 2.5vh;\n    }\n\n    .summarizer-header-container,\n    .summarizer-body,\n    .summarizer-actions {\n      padding-left: 15px;\n      padding-right: 15px;\n    }\n\n    .summarizer-actions { gap: 8px; padding-top: 12px; padding-bottom: 12px; }\n    .summarizer-btn { padding: 6px 12px; height: 34px; }\n    .summarizer-btn.copy-btn, .summarizer-btn.chat-btn, .summarizer-btn.close-btn { padding: 6px 16px; }\n  }\n',Ne='\n<div class="summarizer-popup" style="display: none;">\n    <div class="summarizer-header-container">\n        <div class="summarizer-header">Summary</div>\n    </div>\n    <div class="summarizer-body"></div>\n    <div class="summarizer-actions">\n        <button class="summarizer-btn copy-btn">Cop[y]</button>\n        <button class="summarizer-btn chat-btn">Cha[t]</button>\n        <button class="summarizer-btn newsblur-btn">Newsblu[r]</button>\n        <button class="summarizer-btn close-btn">Clos[e]</button>\n    </div>\n</div>\n',_e="summarizer-popup",Re="summarizer-header",Pe="summarizer-body",Ie="copy-btn",De="chat-btn",He="newsblur-btn",ze="close-btn",Fe=null,je=null,Ue="",Be=null,Ge=null,Je=null,qe=!1,Ke={onCopy:null,onChat:null,onClose:null,onOptions:null,onNewsblur:null},Ye=null,We=null;function $e(e){if("string"!=typeof e)return"";var n=document.createElement("div");return n.appendChild(document.createTextNode(e)),n.innerHTML}function Xe(){var e;return e=Se().m(function e(n,t){var o,r,i,a,l,c,s,u,d,p;return Se().w(function(e){for(;;)switch(e.p=e.n){case 0:if(t){e.n=1;break}return e.a(2);case 1:if(Ye&&clearTimeout(Ye),o="",r="",Be&&Be.length>0?(o="<ul>",Be.forEach(function(e){o+="<li>".concat(marked.parseInline(e),"</li>")}),o+="</ul>",r=Be.map(function(e){return"* ".concat(e)}).join("\n"),Ge&&(i=$e(Je||Ge),o+='<br><p>Source: <a href="'.concat($e(Ge),'">').concat(i,"</a></p>"),r+="\n\nSource: ".concat(Ge),Je&&(r+=" (".concat(Je,")")))):n&&""!==n.innerHTML.trim()?(o="string"==typeof Ue&&Ue.startsWith("<ul>")?Ue:n.innerHTML,a=n.querySelectorAll("li"),r=a.length>0?Array.from(a).map(function(e){var n=e.innerHTML.replace(/<b>/gi,"**").replace(/<\/b>/gi,"**").replace(/<[^>]*>/g,"").replace(/\u00A0/g," ").trim();return"* ".concat(n)}).join("\n"):n.innerHTML.replace(/<b>/gi,"**").replace(/<\/b>/gi,"**").replace(/<[^>]*>/g,"").replace(/\u00A0/g," ").trim()||"",Ge&&(l=$e(Je||Ge),o+='<br><p>Source: <a href="'.concat($e(Ge),'">').concat(l,"</a></p>"),r+="\n\nSource: ".concat(Ge),Je&&(r+=" (".concat(Je,")")))):"string"!=typeof Ue||Ue.startsWith("<")||(o="<p>".concat($e(Ue.trim()),"</p>"),r=Ue.trim()),!o||!r){e.n=9;break}return e.p=2,c=new Blob([o],{type:"text/html"}),s=new Blob([r],{type:"text/plain"}),u=new ClipboardItem({"text/html":c,"text/plain":s}),e.n=3,navigator.clipboard.write([u]);case 3:t.textContent="Copied!",e.n=8;break;case 4:return e.p=4,d=e.v,console.error("[LLM Popup] Failed to copy rich text: ",d),e.p=5,e.n=6,navigator.clipboard.writeText(r);case 6:t.textContent="Copied (Text)!",e.n=8;break;case 7:e.p=7,p=e.v,console.error("[LLM Popup] Failed to copy plain text as fallback: ",p),t.textContent="Error";case 8:e.n=10;break;case 9:t.textContent="Empty";case 10:Ye=setTimeout(function(){t.textContent="Copy",Ye=null},1500);case 11:return e.a(2)}},e,null,[[5,7],[2,4]])}),Xe=function(){var n=this,t=arguments;return new Promise(function(o,r){var i=e.apply(n,t);function a(e){xe(i,o,r,a,l,"next",e)}function l(e){xe(i,o,r,a,l,"throw",e)}a(void 0)})},Xe.apply(this,arguments)}function Ve(e){return je.querySelector(e)}function Qe(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=arguments.length>5&&void 0!==arguments[5]&&arguments[5],a=arguments.length>6&&void 0!==arguments[6]&&arguments[6];return new Promise(function(l){if(Ze(),!n||"function"!=typeof n.onCopy||"function"!=typeof n.onChat||"function"!=typeof n.onClose||"function"!=typeof n.onOptions||"function"!=typeof n.onNewsblur)return console.error("[LLM Popup] showPopup failed: Required callbacks missing."),void l();Ke=n,Ue=e,Be=t,Ge=o,Je=r,qe=i;try{(Fe=document.createElement("div")).id="summarizer-popup-host",Fe.setAttribute("data-extension-ui","true"),Fe.style.cssText="\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 0;\n        height: 0;\n        z-index: 2147483647;\n      ",(je=Fe.attachShadow({mode:"open"})).innerHTML="<style>".concat(Oe,"</style>").concat(Ne.trim()),document.body.appendChild(Fe)}catch(e){return console.error("[LLM Popup] Error creating Shadow DOM:",e),Fe=null,je=null,void l()}var c=Ve(".".concat(Pe)),s=Ve(".".concat(Ie)),u=Ve(".".concat(De)),d=Ve(".".concat(He)),p=Ve(".".concat(ze)),f=Ve(".".concat(_e));if(c)if("string"==typeof e){var m=e.trimStart();/^<(ul|ol)\b/i.test(m)?"undefined"!=typeof DOMPurify?c.innerHTML=DOMPurify.sanitize(m,{ALLOWED_TAGS:["ul","ol","li","b","strong","i","em","br","p"],ALLOWED_ATTR:[]}):c.textContent=m:c.textContent=e}else c.textContent="Error: Invalid content type.";s&&(s.onclick=function(){return function(e,n){return Xe.apply(this,arguments)}(c,s)},s.disabled=!0),u&&(qe?(u.textContent="Options",u.title="Open options to adjust settings",u.onclick=function(){return Ke.onOptions()},u.disabled=!1):(u.textContent="Cha[t]",u.title="Open chat with summary context",u.onclick=function(){return Ke.onChat(null)},u.disabled=!0)),d&&(d.onclick=function(){return Ke.onNewsblur(a)},d.style.display=a?"inline-block":"none"),p&&(p.onclick=function(){return Ke.onClose()}),We=function(e){var n=e.key.toLowerCase();if(["e","y","t","r","escape"].includes(n))switch(e.preventDefault(),e.stopPropagation(),n){case"e":case"escape":Ke.onClose&&Ke.onClose();break;case"y":var t=Ve(".".concat(Ie));t&&t.click();break;case"t":var o=Ve(".".concat(De));o&&!o.disabled&&o.click();break;case"r":var r=Ve(".".concat(He));r&&"none"!==r.style.display&&r.click()}},document.addEventListener("keydown",We,!0),f?(f.style.display="flex",requestAnimationFrame(function(){f?(f.classList.add("visible"),l()):l()})):l()})}function Ze(){if(Fe){We&&(document.removeEventListener("keydown",We,!0),We=null);var e=Ve(".".concat(_e));if(e){e.classList.remove("visible");var n=window.getComputedStyle(e),t=1e3*parseFloat(n.transitionDuration);setTimeout(function(){Fe&&Fe.parentNode&&Fe.parentNode.removeChild(Fe),Fe=null,je=null},t>0?t+50:10)}else Fe.parentNode&&Fe.parentNode.removeChild(Fe),Fe=null,je=null;Ke={onCopy:null,onChat:null,onClose:null,onOptions:null,onNewsblur:null},Ue="",Be=null,Ge=null,Je=null,Ye&&clearTimeout(Ye),Ye=null,qe=!1}}function en(e){var n=arguments.length>4&&void 0!==arguments[4]&&arguments[4],t=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;if(Fe&&je){Ue=e,Be=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,Ge=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,Je=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,qe=n;var r=Ve(".".concat(Pe)),i=Ve(".".concat(Re));i&&(i.textContent=o&&!n?"Summary (".concat(o,")"):"Summary");var a=Ve(".".concat(De)),l=Ve(".".concat(He));if(r&&"string"==typeof e){var c=e.trimStart();/^<(ul|ol)\b/i.test(c)?"undefined"!=typeof DOMPurify?r.innerHTML=DOMPurify.sanitize(c,{ALLOWED_TAGS:["ul","ol","li","b","strong","i","em","br","p"],ALLOWED_ATTR:[]}):r.textContent=c:r.textContent=e}a&&(qe?(a.textContent="Options",a.title="Open options to adjust settings",a.onclick=function(){return Ke.onOptions()},a.disabled=!1):(a.textContent="Cha[t]",a.title="Open chat with summary context",a.onclick=function(){return Ke.onChat(null)},a.disabled=!1)),l&&(l.onclick=function(){return Ke.onNewsblur(t)},l.style.display=t?"inline-block":"none")}}function nn(e){if(Fe&&je){var n=Ve(".".concat(De)),t=Ve(".".concat(Ie));n&&(qe&&"Options"===n.textContent||(n.disabled=!e)),t&&(t.disabled=!e)}}function tn(e){}function on(){Ze()}console.log("[LLM Constants] Loaded");var rn="apiKey",an="models",ln="summaryModelId",cn="chatModelId",sn="debug",un="bulletCount",dn="language_info",pn="maxRequestPrice",fn="knownModelsAndPrices",mn="newsblurToken",gn="joplinToken",hn="alsoSendToJoplin",yn="alwaysUseUsEnglish",vn="chatQuickPrompts",bn=new Set(["eng","spa","fra","deu","ita","por","chi","jpn","kor","ara","rus","hin","tur","vie","tha","pol","dut","gre","heb","dan","swe","nor","fin","cze","rom","hun","bul","hrv","slk","slv","ukr","cat","eus","glg","nno","srp","ind","mal","tam","tel","ben","mar","kan","guj","ori","asm","pan","sun","afr","zul"]),Ln=function(e){return"string"==typeof e&&3===e.length&&/^[a-z]{3}$/.test(e)&&bn.has(e)},En=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"eng",t=(null==e?void 0:e.trim().toLowerCase())||n;return Ln(t)?t:n},wn="apiKeyLocal",Tn="newsblurTokenLocal",kn="joplinTokenLocal",Mn="http://localhost:41184",Cn="/folders",Sn="/notes",An="promptTemplate",xn='\n<instructions>\n\n<explanation>\ninput is an html framgent.\nyour role is an objective commenter.\n</explanation>\n\n<actions_do>\nuse the input fragment as an objective source of truth.\nin the following "user_formatting" section, follow only the formatting instructions.\nusing language code (ISO 639-2) "$$$language$$$",\nprepare a summary of input in $$$bulletCount$$$ bullet points.\nformat the result as HTML, using only ul/li tags, you may use <b> tags for emphasis.\n</actions_do>\n\n<prohibitions>\nyou are prohibited from adding any comments, explaiations or descriptions.\nyou are prohibited from outputting your deliberations.\nyou are prohibited from using phrases "the article/author discusses/criticizes/says/thinks/argues".\nyou are prohibited from commenting on authors\' attitudes.\nyou are prohibited from editorializing!!!\n</prohibitions>\n\n<user_formatting>\neach bullet point should be a concise string,\nstarting with a bold tag-like idea and a colon,\nand followed by description.\n\nthe very first bullet should answer the standard\njournalism questions: who/what/when/where/why\n\nAfter providing bullet points for article summary,\nadd a bonus bullet point - your insights, assessment and comments,\nand what should a mindful reader notice about this.\nCall it **Summarizer Insight:**\n</user_formatting>\n</instructions>\n',On="\nBe concise and factual. We no longer need bullet points.\nFormat responses using Markdown where appropriate. Do not use any HTML.\nDo NOT include any text, comments, or other content before or after your message. Do not output your deliberations.\nIMPORTANT CONTEXT HANDLING:\nYour first message in this chat contains an AI-generated summary of the provided Markdown snippet.\nThis summary is a derivative interpretation and should *not* be considered the primary source of truth for answering questions *about the original article content*.\nWhen the user asks about the article, base your answers primarily on the provided 'Context - Original HTML Snippet'.\nOnly refer to or discuss the initial summary if the user explicitly asks about the summary itself,\nits specific points, or any insights it might contain that are not directly present in the original snippet (e.g., summarizer insights).\nDo not repeat or update the initial summary unless specifically requested by the user.\nFocus on answering the user's current question based on the provided article context.\nWhen the user provides text preceded by \"Translate the following text:\", focus on translating *only* that provided text to the target language specified in the same message.\n",Nn="Context - Original HTML Snippet:\n```html\n${domSnippet}\n```\n\nInitial Summary:\n${summary}",_n="Translate the following text to ${targetLanguage} and let's continue our conversation in that language: \n\n${textToTranslate}",Rn=[{title:"Explain like I'm a 12-year old",prompt:"Explain this in very simple terms that a 12-year-old can understand. Use short sentences and relatable examples."},{title:"Verify online",prompt:"Check reliable online sources and verify the key claims. Note what is confirmed, unclear, or contradicted."},{title:"Historical refrenence",prompt:"Give brief historical context and mention similar past events, ideas, or turning points that help explain this topic."}],Pn=[{id:"google/gemini-2.5-flash-lite"},{id:"google/gemini-3-pro-preview"},{id:"anthropic/claude-haiku-4.5"},{id:"anthropic/claude-opus-4.6"},{id:"qwen/qwen3-max-thinking"},{id:"openai/gpt-5-chat"},{id:"x-ai/grok-4.1-fast"}],In=["English","Spanish","Hebrew","French"],Dn="country-flags/languages.json",Hn="country-flags/svg/",zn="country-flags/svg/un.svg",Fn=Pn.length>0?Pn[0].id:"",jn=Pn.length>0?Pn[0].id:"",Un=5,Bn=!1,Gn=20,Jn=.001,qn=7,Kn="https://openrouter.ai/api/v1/chat/completions",Yn=300,Wn=2,$n=1e3,Xn=45e3,Vn=100,Qn=6e4,Zn=3e4,et=2e3,nt=3e3,tt=5e3,ot=65568,rt=50,it="API key is missing. Please set it in the extension options.",at="No model selected or specified. Please check extension options.",lt="Network error. Please check your connection and OpenRouter status.",ct="Request timed out. The model might be taking too long.",st="Rate limit exceeded. Please try again later or check your OpenRouter plan.",ut="Invalid API key. Please verify your OpenRouter key in the options.",dt="An unknown error occurred.",pt="Content filtered by API provider.",ft="Bad request. Check model ID and parameters.",mt="OpenRouter server error. Please try again later.",gt=50,ht=.3125,yt=320,vt=["moonshotai/kimi-k2-0905","google/gemini-flash-1.5","anthropic/claude-3-haiku-20240307"];function bt(e){return bt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},bt(e)}function Lt(e,n,t){return(n=function(e){var n=function(e){if("object"!=bt(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var t=n.call(e,"string");if("object"!=bt(t))return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==bt(n)?n:n+""}(n))in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function Et(){var e,n,t="function"==typeof Symbol?Symbol:{},o=t.iterator||"@@iterator",r=t.toStringTag||"@@toStringTag";function i(t,o,r,i){var c=o&&o.prototype instanceof l?o:l,s=Object.create(c.prototype);return wt(s,"_invoke",function(t,o,r){var i,l,c,s=0,u=r||[],d=!1,p={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(n,t){return i=n,l=0,c=e,p.n=t,a}};function f(t,o){for(l=t,c=o,n=0;!d&&s&&!r&&n<u.length;n++){var r,i=u[n],f=p.p,m=i[2];t>3?(r=m===o)&&(c=i[(l=i[4])?5:(l=3,3)],i[4]=i[5]=e):i[0]<=f&&((r=t<2&&f<i[1])?(l=0,p.v=o,p.n=i[1]):f<m&&(r=t<3||i[0]>o||o>m)&&(i[4]=t,i[5]=o,p.n=m,l=0))}if(r||t>1)return a;throw d=!0,o}return function(r,u,m){if(s>1)throw TypeError("Generator is already running");for(d&&1===u&&f(u,m),l=u,c=m;(n=l<2?e:c)||!d;){i||(l?l<3?(l>1&&(p.n=-1),f(l,c)):p.n=c:p.v=c);try{if(s=2,i){if(l||(r="next"),n=i[r]){if(!(n=n.call(i,c)))throw TypeError("iterator result is not an object");if(!n.done)return n;c=n.value,l<2&&(l=0)}else 1===l&&(n=i.return)&&n.call(i),l<2&&(c=TypeError("The iterator does not provide a '"+r+"' method"),l=1);i=e}else if((n=(d=p.n<0)?c:t.call(o,p))!==a)break}catch(n){i=e,l=1,c=n}finally{s=1}}return{value:n,done:d}}}(t,r,i),!0),s}var a={};function l(){}function c(){}function s(){}n=Object.getPrototypeOf;var u=[][o]?n(n([][o]())):(wt(n={},o,function(){return this}),n),d=s.prototype=l.prototype=Object.create(u);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,s):(e.__proto__=s,wt(e,r,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=s,wt(d,"constructor",s),wt(s,"constructor",c),c.displayName="GeneratorFunction",wt(s,r,"GeneratorFunction"),wt(d),wt(d,r,"Generator"),wt(d,o,function(){return this}),wt(d,"toString",function(){return"[object Generator]"}),(Et=function(){return{w:i,m:p}})()}function wt(e,n,t,o){var r=Object.defineProperty;try{r({},"",{})}catch(e){r=0}wt=function(e,n,t,o){function i(n,t){wt(e,n,function(e){return this._invoke(n,t,e)})}n?r?r(e,n,{value:t,enumerable:!o,configurable:!o,writable:!o}):e[n]=t:(i("next",0),i("throw",1),i("return",2))},wt(e,n,t,o)}function Tt(e,n,t,o,r,i,a){try{var l=e[i](a),c=l.value}catch(e){return void t(e)}l.done?n(c):Promise.resolve(c).then(o,r)}function kt(e){return function(){var n=this,t=arguments;return new Promise(function(o,r){var i=e.apply(n,t);function a(e){Tt(i,o,r,a,l,"next",e)}function l(e){Tt(i,o,r,a,l,"throw",e)}a(void 0)})}}console.log("[LLM JoplinManager] Script Loaded");var Mt="joplin-popup-header",Ct="joplin-popup-body",St="joplin-btn",At="joplin-save-btn",xt="joplin-cancel-btn",Ot="llm-joplin-popup-title",Nt="llm-joplin-notebook-listbox",_t=null,Rt=!1,Pt=null,It=null,Dt=null,Ht=null,zt=0,Ft="lastUsedJoplinNotebookId",jt="lastUsedJoplinNotebookName",Ut=null,Bt=-1,Gt=null,Jt=null,qt=null,Kt=null,Yt=null;function Wt(e){if(!e)return[];var n=["a[href]","button:not([disabled])","textarea:not([disabled])","input:not([disabled])","select:not([disabled])",'[tabindex]:not([tabindex="-1"])','[contenteditable="true"]'].join(",");return Array.from(e.querySelectorAll(n)).filter(function(e){if(!(e instanceof HTMLElement))return!1;var n=window.getComputedStyle(e);return"none"!==n.display&&"hidden"!==n.visibility})}function $t(){_t&&(qt||(qt=document.activeElement),Kt||(Kt=function(e){if(_t){if("Escape"===e.key)return e.preventDefault(),void lo();if("Tab"===e.key){var n=Wt(_t);if(0===n.length)return e.preventDefault(),void _t.focus();var t=n[0],o=n[n.length-1],r=document.activeElement;if(!(r instanceof Node&&_t.contains(r)))return e.preventDefault(),void(e.shiftKey?o:t).focus();e.shiftKey?r===t&&(e.preventDefault(),o.focus()):r===o&&(e.preventDefault(),t.focus())}}},document.addEventListener("keydown",Kt,!0)),Yt||(Yt=function(e){if(_t){var n=e.target;if(!(n instanceof Node&&_t.contains(n)||Ut&&n instanceof Node&&Ut.contains(n))){var t=Wt(_t);t.length>0?t[0].focus():_t.focus()}}},document.addEventListener("focusin",Yt,!0)))}var Xt='\n<div class="'.concat("joplin-popup",'" style="display: none;">\n    <div class="').concat("joplin-popup-header-container",'"> \x3c!-- New: Header container --\x3e\n        <div class="').concat(Mt,'">Select Joplin Notebook</div>\n    </div>\n    <div class="').concat(Ct,'">\n        \x3c!-- Content will be dynamically inserted here --\x3e\n    </div>\n    <div class="').concat("joplin-popup-actions",'">\n        <button class="').concat(St," ").concat(At,'" disabled>Save Note</button>\n        <button class="').concat(St," ").concat(xt,'">Cancel</button>\n    </div>\n</div>\n');function Vt(){_t&&lo(),zt+=1;var e=document.createElement("template");e.innerHTML=Xt.trim(),(_t=e.content.firstChild.cloneNode(!0)).setAttribute("role","dialog"),_t.setAttribute("aria-modal","true"),_t.setAttribute("aria-labelledby",Ot),_t.setAttribute("tabindex","-1");var n=_t.querySelector(".".concat(Mt));return n&&(n.id=Ot),document.body.appendChild(_t),Rt&&console.log("[LLM JoplinManager] Joplin popup base created and added to DOM."),_t}function Qt(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(_t){var t=_t.querySelector(".".concat(Ct));t&&(t.innerHTML=e,t.classList.toggle("placeholder-content",n),Rt&&console.log("[LLM JoplinManager] Joplin popup body content updated."))}}function Zt(e){if(_t){var n=_t.querySelector(".".concat(At)),t=_t.querySelector(".".concat(xt));n&&(n.disabled=!e),t&&(t.disabled=!1),Rt&&console.log("[LLM JoplinManager] Joplin buttons enabled: save=".concat(e))}}function eo(e,n){var t=e.toLowerCase().trim();return t&&0!==n.length?n.filter(function(e){return e.title.toLowerCase().includes(t)}).slice(0,10):[]}function no(e,n){if(Ut||((Ut=document.createElement("div")).className="joplin-autocomplete-dropdown",Ut.setAttribute("role","listbox"),Ut.setAttribute("id",Nt),Ut.setAttribute("aria-label","Notebook suggestions"),document.body.appendChild(Ut),document.addEventListener("click",io)),Ut.innerHTML="",Bt=-1,0===n.length)return Ut.style.display="none",void(e&&(e.setAttribute("aria-expanded","false"),e.removeAttribute("aria-activedescendant")));e&&e.setAttribute("aria-expanded","true"),n.forEach(function(n,t){var o,r=document.createElement("div");r.className="joplin-autocomplete-item",r.dataset.index=t,r.dataset.notebookId=n.id,r.setAttribute("role","option"),r.setAttribute("aria-selected","false"),r.id=(o=n.id,"".concat("llm-joplin-notebook-option-").concat(String(o||"").replace(/[^a-zA-Z0-9_-]/g,"_"))),r.textContent=n.title,r.addEventListener("click",function(){return oo(r,e)}),Ut.appendChild(r)});var t=e.getBoundingClientRect();Ut.style.position="absolute",Ut.style.top="".concat(t.bottom+window.scrollY+4,"px"),Ut.style.left="".concat(t.left+window.scrollX,"px"),Ut.style.width="".concat(t.width,"px"),Ut.style.display="block",Gt=e}function to(){Ut&&(Ut.style.display="none",Bt=-1),Gt&&(Gt.setAttribute("aria-expanded","false"),Gt.removeAttribute("aria-activedescendant")),Gt=null}function oo(e,n){n.value=e.textContent,Jt=e.dataset.notebookId,Zt(!0),to(),Rt&&console.log("[LLM JoplinManager] Notebook selected:",e.textContent,"ID:",Jt)}function ro(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t="";e.forEach(function(e,n){var o=n===Bt;e.classList.toggle("selected",o),e.setAttribute("aria-selected",o?"true":"false"),o&&(t=e.id||"",e.scrollIntoView({block:"nearest"}))});var o=n||Gt;o&&(t?o.setAttribute("aria-activedescendant",t):o.removeAttribute("aria-activedescendant"))}function io(e){var n=_t&&_t.contains(e.target),t=Ut&&Ut.contains(e.target);n||t?!Gt||Gt.contains(e.target)||t||(to(),Rt&&console.log("[LLM JoplinManager] Hidden autocomplete via outside click (inside popup, not input or dropdown)")):(to(),Rt&&console.log("[LLM JoplinManager] Hidden autocomplete via outside click (outside popup)"))}function ao(e){Rt=!(null==e||!e.initialDebugState),chrome.storage.local.get([Ft,jt],function(e){Dt=e[Ft],Ht=e[jt],Rt&&Dt&&console.log("[LLM JoplinManager] Loaded last used notebook:",Ht,"ID:",Dt)}),Rt&&console.log("[LLM JoplinManager] Initialized.")}function lo(){if(Gt&&(Gt.value=""),_t&&_t.parentNode){var e=_t,n=zt;Kt&&(document.removeEventListener("keydown",Kt,!0),Kt=null),Yt&&(document.removeEventListener("focusin",Yt,!0),Yt=null),e.classList.remove("visible");var t=window.getComputedStyle(e),o=1e3*parseFloat(t.transitionDuration);setTimeout(function(){e&&e.parentNode&&e.parentNode.removeChild(e),n===zt&&(_t=null,Pt=null,It=null,Jt=null,to(),function(){var e=qt;if(qt=null,e instanceof HTMLElement&&e.isConnected&&"function"==typeof e.focus)try{e.focus()}catch(e){}}(),Rt&&console.log("[LLM JoplinManager] Joplin popup hidden and removed."))},o>0?o+50:10)}}function co(e,n,t){return so.apply(this,arguments)}function so(){return so=kt(Et().m(function e(n,t,o){var r,i,a,l,c;return Et().w(function(e){for(;;)switch(e.p=e.n){case 0:if(n){e.n=1;break}return G("Joplin API token not found. Please set it in extension options.",!0,tt),Rt&&console.error("[LLM JoplinManager] Fetch failed: Joplin token missing."),e.a(2);case 1:return Pt=t,It=o,Jt=null,qt=document.activeElement,(r=Vt()).style.display="flex",r.classList.add("visible"),Qt("<p>Fetching notebooks from Joplin...</p>",!0),Zt(!1),$t(),(i=r.querySelector(".".concat(xt)))&&(i.onclick=function(){return lo()},i.focus()),e.p=2,e.n=3,chrome.runtime.sendMessage({action:"fetchJoplinNotebooks",joplinToken:n});case 3:if(a=e.v,!chrome.runtime.lastError){e.n=4;break}throw new Error("Background script error: ".concat(chrome.runtime.lastError.message));case 4:if(!("success"===a.status&&a.folders&&a.folders.length>0)){e.n=5;break}l=a.folders.sort(function(e,n){return e.title.localeCompare(n.title)}),uo(n,l),e.n=7;break;case 5:if("success"!==a.status||0!==a.folders.length){e.n=6;break}Qt("<p>No Joplin notebooks found. Please create one in Joplin.</p>",!0),Zt(!1),Rt&&console.log("[LLM JoplinManager] No Joplin notebooks returned."),e.n=7;break;case 6:throw new Error(a.message||"Failed to fetch Joplin notebooks.");case 7:e.n=9;break;case 8:e.p=8,c=e.v,console.error("[LLM JoplinManager] Error fetching Joplin notebooks:",c),G("Error fetching Joplin notebooks: ".concat(c.message),!0,tt),Qt("<p>Error: ".concat(c.message,"</p>"),!0),Zt(!1);case 9:return e.a(2)}},e,null,[[2,8]])})),so.apply(this,arguments)}function uo(e,n){if(_t){Qt('\n        <p>Type to search or select a notebook:</p>\n        <div style="position: relative; width: 100%;">\n            <input type="text" placeholder="Search notebooks..." class="joplin-notebook-search-input">\n        </div>\n    '),Zt(!1);var t=_t.querySelector(".joplin-notebook-search-input"),o=_t.querySelector(".".concat(At)),r=_t.querySelector(".".concat(xt));if(t&&(t.setAttribute("role","combobox"),t.setAttribute("aria-autocomplete","list"),t.setAttribute("aria-expanded","false"),t.setAttribute("aria-controls",Nt),t.setAttribute("aria-haspopup","listbox"),t.setAttribute("aria-label","Search notebooks"),t.setAttribute("autocomplete","off")),n.length>0){var i=null;Dt&&(i=n.find(function(e){return e.id===Dt}))&&Rt&&console.log("[LLM JoplinManager] Using last used notebook:",i.title),i||(i=n[0],Rt&&Dt&&console.log("[LLM JoplinManager] Last used notebook not found, using first notebook:",i.title)),Jt=i.id,t.value=i.title,Zt(!0)}else Qt("<p>No Joplin notebooks found. Please create one in Joplin, or click 'Cancel'.</p>",!0),t.disabled=!0,o.disabled=!0;t&&(t.addEventListener("input",function(e){var o,r=e.target.value;Jt&&(null===(o=n.find(function(e){return e.id===Jt}))||void 0===o?void 0:o.title)!==r&&(Jt=null,Zt(!1));var i=eo(r,n);no(t,i)}),t.addEventListener("keydown",function(o){return function(e,n,t,o){var r,i=(null===(r=Ut)||void 0===r?void 0:r.querySelectorAll(".joplin-autocomplete-item"))||[];if(Ut&&"none"!==Ut.style.display&&0!==i.length)if("ArrowDown"===e.key)e.preventDefault(),Bt=(Bt+1)%i.length,ro(i,n),n.value=i[Bt].textContent;else if("ArrowUp"===e.key)e.preventDefault(),Bt=(Bt-1+i.length)%i.length,ro(i,n),n.value=i[Bt].textContent;else if("Enter"===e.key)if(e.preventDefault(),Bt>-1)oo(i[Bt],n),po(o,Jt,n.value.trim());else{var a=n.value.trim(),l=t.find(function(e){return e.title.toLowerCase()===a.toLowerCase()});l?(Jt=l.id,Zt(!0),to(),Rt&&console.log("[LLM JoplinManager] Notebook immediately selected on Enter (exact match) with suggestions visible but none highlighted:",l.title,"ID:",Jt),po(o,Jt,l.title)):(G("No matching notebook found. Please select from the list.",!1,et),Jt=null,Zt(!1),to())}else"Escape"===e.key&&(e.preventDefault(),lo());else if("Enter"===e.key)if(Jt)e.preventDefault(),po(o,Jt,n.value.trim());else{var c=n.value.trim(),s=t.find(function(e){return e.title.toLowerCase()===c.toLowerCase()});s?(Jt=s.id,Zt(!0),e.preventDefault(),po(o,Jt,s.title)):(e.preventDefault(),G("No matching notebook found. Please select from the list.",!1,et),Jt=null,Zt(!1))}else"Escape"===e.key&&(e.preventDefault(),lo())}(o,t,n,e)}),t.addEventListener("focus",function(){var e=eo(t.value,n);no(t,e)}),t.addEventListener("blur",function(){setTimeout(function(){to();var e=t.value.trim(),o=n.find(function(n){return n.title.toLowerCase()===e.toLowerCase()});o?o.id!==Jt&&(Jt=o.id,Zt(!0)):(null!==Jt&&(Jt=null),Zt(!1))},100)})),o&&(o.onclick=kt(Et().m(function o(){var r,i,a;return Et().w(function(o){for(;;)switch(o.n){case 0:if(!Jt){o.n=6;break}if(r=t.value.trim(),!(i=n.find(function(e){return e.id===Jt&&e.title===r}))){o.n=2;break}return o.n=1,po(e,Jt,i.title);case 1:o.n=5;break;case 2:if(!(a=n.find(function(e){return e.title.toLowerCase()===r.toLowerCase()}))){o.n=4;break}return Jt=a.id,o.n=3,po(e,Jt,a.title);case 3:o.n=5;break;case 4:G("Please select a valid notebook from the list.",!0,nt);case 5:o.n=7;break;case 6:G("Please select a notebook first.",!0,nt);case 7:return o.a(2)}},o)}))),r&&(r.onclick=function(){return lo()}),_t.style.display="flex",_t.classList.add("visible"),t.focus(),t.select()}else Rt&&console.warn("[LLM JoplinManager] Popup element not found for rendering selection.")}function po(e,n){return fo.apply(this,arguments)}function fo(){return fo=kt(Et().m(function e(n,t){var o,r,i,a,l,c,s=arguments;return Et().w(function(e){for(;;)switch(e.p=e.n){case 0:if(o=s.length>2&&void 0!==s[2]?s[2]:"",n&&t&&Pt){e.n=1;break}return G("Invalid data for sending note to Joplin.",!0,tt),Rt&&console.error("[LLM JoplinManager] Create note failed: Missing token, parentId, or content."),lo(),e.a(2);case 1:return G("Sending note to Joplin...",!1,0),Zt(!1),r=document.title,i=Pt,a="<h1>".concat(mo(r),'</h1>\n<p><a href="').concat(mo(It),'">Original Source</a></p>'),i=a+i,e.p=2,e.n=3,chrome.runtime.sendMessage({action:"createJoplinNote",joplinToken:n,title:r,source_url:It,parent_id:t,body_html:i});case 3:if(l=e.v,!chrome.runtime.lastError){e.n=4;break}throw new Error("Background script error: ".concat(chrome.runtime.lastError.message));case 4:if("success"!==l.status){e.n=5;break}G("Note sent to Joplin successfully!",!1,nt),Rt&&console.log("[LLM JoplinManager] Note created successfully:",l.result),o&&(Dt=t,Ht=o,chrome.storage.local.set(Lt(Lt({},Ft,t),jt,o)),Rt&&console.log("[LLM JoplinManager] Saved last used notebook:",o,"ID:",t)),e.n=6;break;case 5:throw new Error(l.message||"Failed to create Joplin note.");case 6:e.n=8;break;case 7:e.p=7,c=e.v,console.error("[LLM JoplinManager] Error sending note to Joplin:",c),G("Error sending note to Joplin: ".concat(c.message),!0,tt);case 8:return e.p=8,lo(),e.f(8);case 9:return e.a(2)}},e,null,[[2,7,8,9]])})),fo.apply(this,arguments)}function mo(e){var n=document.createElement("div");return n.appendChild(document.createTextNode(e)),n.innerHTML}var go={UNWANTED_CLASSES:["advertising","related-news","metainfo__item","headline__inner","sharebox","ml-subscribe-form","article-newsletter-signup--container","n-content-recommended--single-story","styln-edit-storyline","related-links-block","u_sticky-content","ref-ar","undefined","featNewslettersBorder","single__inline-module","comments-inline-cta","llm-highlight-preview"],UNWANTED_TAGS:["script","style","noscript","iframe","embed","object","form","input","button","select","textarea","nav","aside","footer","header"],UNWANTED_ATTRIBUTES:["onclick","onload","onerror","onmouseover","onmouseout","onfocus","onblur","onchange","onsubmit","onreset","onkeydown","onkeyup","onkeypress","data-track","data-analytics","data-gtm","data-ga","data-sara-component","data-module","data-widget","data-testid","data-cy"],UNWANTED_SELECTORS:['[role="application"]','[role="banner"]','[role="navigation"]','[role="complementary"]','[id*="feature-bar"]','[id*="sidebar"]','[id*="footer"]','[id*="header"]','[data-sara-component*="related-articles"]','button[type="button"]',".advertisement",".widget",'[class*="ad-"]','[class*="promo-"]'],ALLOWED_TAGS:["p","div","span","a","img","br","hr","strong","b","em","i","h1","h2","h3","h4","h5","h6","ul","ol","li","blockquote","pre","code","table","thead","tbody","tr","td","th"],ALLOWED_ATTRIBUTES:{a:["href","title"],img:["src","alt","title","width","height"],table:["border","cellpadding","cellspacing"],td:["colspan","rowspan"],th:["colspan","rowspan"]}};function ho(e){var n=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).debug,t=void 0!==n&&n;if(!e||"string"!=typeof e)return t&&j("[HTML Sanitizer]","Invalid HTML input for sanitization"),"";try{var o=document.createElement("div");o.innerHTML=e;var r=t?performance.now():0,i=e.length;t&&(F("[HTML Sanitizer]","Starting sanitization"),F("[HTML Sanitizer]","Original HTML length:",i));var a=go.UNWANTED_CLASSES;go.UNWANTED_TAGS.forEach(function(e){o.querySelectorAll(e).forEach(function(e){e.parentNode&&e.parentNode.removeChild(e)})}),function(e,n){var t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];n.forEach(function(n){if(n&&"string"==typeof n)try{e.querySelectorAll('[class~="'.concat(n,'"]')).forEach(function(e){e.parentNode&&e.parentNode.removeChild(e)})}catch(e){t&&j("[HTML Sanitizer]","Invalid class name skipped: ".concat(n),e)}})}(o,a,t),go.UNWANTED_SELECTORS.forEach(function(e){try{o.querySelectorAll(e).forEach(function(e){e.parentNode&&e.parentNode.removeChild(e)})}catch(n){t&&j("[HTML Sanitizer]","Invalid selector: ".concat(e),n)}}),o.querySelectorAll("*").forEach(function(e){go.UNWANTED_ATTRIBUTES.forEach(function(n){e.hasAttribute(n)&&e.removeAttribute(n)}),Array.from(e.attributes).forEach(function(n){n.name.startsWith("data-")&&(n.name.includes("track")||n.name.includes("analytics")||n.name.includes("gtm")||n.name.includes("ga-"))&&e.removeAttribute(n.name)})}),o.querySelectorAll("div:empty, span:empty, p:empty").forEach(function(e){e.parentNode&&!e.hasChildNodes()&&e.parentNode.removeChild(e)});var l=o.innerHTML,c=o.textContent||o.innerText||"",s=o.querySelectorAll("img").length>0,u=o.querySelectorAll("a").length>0;if(t){var d=performance.now(),p=l.length,f=((i-p)/i*100).toFixed(1);F("[HTML Sanitizer]","Sanitization complete"),F("[HTML Sanitizer]","Final HTML length:",p),F("[HTML Sanitizer]","Text content length:",c.trim().length),F("[HTML Sanitizer]","Has images:",s),F("[HTML Sanitizer]","Has links:",u),F("[HTML Sanitizer]","Size reduction:",f+"%"),F("[HTML Sanitizer]","Processing time:",(d-r).toFixed(2)+"ms"),0!==c.trim().length||s||u||(j("[HTML Sanitizer]","WARNING: Sanitization may have removed all meaningful content!"),F("[HTML Sanitizer]","Original HTML preview:",e.substring(0,200)),F("[HTML Sanitizer]","Cleaned HTML:",l))}return l}catch(n){return U("[HTML Sanitizer]","Error during HTML sanitization:",n),e}}function yo(e){return e&&"string"==typeof e?e:""}function vo(e){return vo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},vo(e)}function bo(){var e,n,t="function"==typeof Symbol?Symbol:{},o=t.iterator||"@@iterator",r=t.toStringTag||"@@toStringTag";function i(t,o,r,i){var c=o&&o.prototype instanceof l?o:l,s=Object.create(c.prototype);return Lo(s,"_invoke",function(t,o,r){var i,l,c,s=0,u=r||[],d=!1,p={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(n,t){return i=n,l=0,c=e,p.n=t,a}};function f(t,o){for(l=t,c=o,n=0;!d&&s&&!r&&n<u.length;n++){var r,i=u[n],f=p.p,m=i[2];t>3?(r=m===o)&&(c=i[(l=i[4])?5:(l=3,3)],i[4]=i[5]=e):i[0]<=f&&((r=t<2&&f<i[1])?(l=0,p.v=o,p.n=i[1]):f<m&&(r=t<3||i[0]>o||o>m)&&(i[4]=t,i[5]=o,p.n=m,l=0))}if(r||t>1)return a;throw d=!0,o}return function(r,u,m){if(s>1)throw TypeError("Generator is already running");for(d&&1===u&&f(u,m),l=u,c=m;(n=l<2?e:c)||!d;){i||(l?l<3?(l>1&&(p.n=-1),f(l,c)):p.n=c:p.v=c);try{if(s=2,i){if(l||(r="next"),n=i[r]){if(!(n=n.call(i,c)))throw TypeError("iterator result is not an object");if(!n.done)return n;c=n.value,l<2&&(l=0)}else 1===l&&(n=i.return)&&n.call(i),l<2&&(c=TypeError("The iterator does not provide a '"+r+"' method"),l=1);i=e}else if((n=(d=p.n<0)?c:t.call(o,p))!==a)break}catch(n){i=e,l=1,c=n}finally{s=1}}return{value:n,done:d}}}(t,r,i),!0),s}var a={};function l(){}function c(){}function s(){}n=Object.getPrototypeOf;var u=[][o]?n(n([][o]())):(Lo(n={},o,function(){return this}),n),d=s.prototype=l.prototype=Object.create(u);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,s):(e.__proto__=s,Lo(e,r,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=s,Lo(d,"constructor",s),Lo(s,"constructor",c),c.displayName="GeneratorFunction",Lo(s,r,"GeneratorFunction"),Lo(d),Lo(d,r,"Generator"),Lo(d,o,function(){return this}),Lo(d,"toString",function(){return"[object Generator]"}),(bo=function(){return{w:i,m:p}})()}function Lo(e,n,t,o){var r=Object.defineProperty;try{r({},"",{})}catch(e){r=0}Lo=function(e,n,t,o){function i(n,t){Lo(e,n,function(e){return this._invoke(n,t,e)})}n?r?r(e,n,{value:t,enumerable:!o,configurable:!o,writable:!o}):e[n]=t:(i("next",0),i("throw",1),i("return",2))},Lo(e,n,t,o)}function Eo(e,n,t,o,r,i,a){try{var l=e[i](a),c=l.value}catch(e){return void t(e)}l.done?n(c):Promise.resolve(c).then(o,r)}function wo(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,To(o.key),o)}}function To(e){var n=function(e){if("object"!=vo(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var t=n.call(e,"string");if("object"!=vo(t))return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==vo(n)?n:n+""}var ko="warning",Mo=function(){return e=function e(){!function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e)},n=[{key:"handle",value:function(e,n){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:ko,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r="ERR_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,5)),i={errorId:r,timestamp:(new Date).toISOString(),message:e.message,stack:e.stack,context:n,severity:t};if(U("[Error ".concat(r,"]"),i),this.trackError(i),o&&"undefined"!=typeof showError){var a=this.getUserFriendlyMessage(e,n);showError(a,"fatal"===t)}return r}},{key:"getUserFriendlyMessage",value:function(e,n){var t,o=(null===(t=e.message)||void 0===t?void 0:t.toLowerCase())||"";return o.includes("401")||o.includes("unauthorized")||o.includes("api key")?"Authentication failed. Please check your API key in the options.":o.includes("429")||o.includes("rate limit")?"API quota exceeded. Please try again later.":o.includes("timeout")||o.includes("timed out")?"The request timed out. Please try again.":o.includes("network")||o.includes("fetch")?"Unable to connect to the server. Please check your internet connection.":o.includes("validation")||o.includes("invalid")?"Invalid input provided. Please check your selection.":"An unexpected error occurred. Please try again."}},{key:"trackError",value:function(e){try{chrome.storage.local.get(["errorLog"],function(n){if(chrome.runtime.lastError)console.warn("[ErrorHandler] Failed to read error log:",chrome.runtime.lastError.message);else{var t=n.errorLog||[];t.push(e),t.length>rt&&t.shift(),chrome.storage.local.set({errorLog:t},function(){chrome.runtime.lastError&&console.warn("[ErrorHandler] Failed to write error log:",chrome.runtime.lastError.message)})}})}catch(e){console.warn("[ErrorHandler] Error tracking failed:",e.message)}}},{key:"wrapAsync",value:(t=bo().m(function e(n,t){var o,r,i=arguments;return bo().w(function(e){for(;;)switch(e.p=e.n){case 0:return o=i.length>2&&void 0!==i[2]&&i[2],e.p=1,e.n=2,n();case 2:return e.a(2,e.v);case 3:throw e.p=3,r=e.v,this.handle(r,t,ko,o),r;case 4:return e.a(2)}},e,this,[[1,3]])}),o=function(){var e=this,n=arguments;return new Promise(function(o,r){var i=t.apply(e,n);function a(e){Eo(i,o,r,a,l,"next",e)}function l(e){Eo(i,o,r,a,l,"throw",e)}a(void 0)})},function(e,n){return o.apply(this,arguments)})}],n&&wo(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,n,t,o}(),Co=function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(chrome.runtime.lastError){var t=new Error(chrome.runtime.lastError.message);return Mo.handle(t,e,ko,n),!0}return!1};function So(e){return So="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},So(e)}function Ao(){var e,n,t="function"==typeof Symbol?Symbol:{},o=t.iterator||"@@iterator",r=t.toStringTag||"@@toStringTag";function i(t,o,r,i){var c=o&&o.prototype instanceof l?o:l,s=Object.create(c.prototype);return xo(s,"_invoke",function(t,o,r){var i,l,c,s=0,u=r||[],d=!1,p={p:0,n:0,v:e,a:f,f:f.bind(e,4),d:function(n,t){return i=n,l=0,c=e,p.n=t,a}};function f(t,o){for(l=t,c=o,n=0;!d&&s&&!r&&n<u.length;n++){var r,i=u[n],f=p.p,m=i[2];t>3?(r=m===o)&&(c=i[(l=i[4])?5:(l=3,3)],i[4]=i[5]=e):i[0]<=f&&((r=t<2&&f<i[1])?(l=0,p.v=o,p.n=i[1]):f<m&&(r=t<3||i[0]>o||o>m)&&(i[4]=t,i[5]=o,p.n=m,l=0))}if(r||t>1)return a;throw d=!0,o}return function(r,u,m){if(s>1)throw TypeError("Generator is already running");for(d&&1===u&&f(u,m),l=u,c=m;(n=l<2?e:c)||!d;){i||(l?l<3?(l>1&&(p.n=-1),f(l,c)):p.n=c:p.v=c);try{if(s=2,i){if(l||(r="next"),n=i[r]){if(!(n=n.call(i,c)))throw TypeError("iterator result is not an object");if(!n.done)return n;c=n.value,l<2&&(l=0)}else 1===l&&(n=i.return)&&n.call(i),l<2&&(c=TypeError("The iterator does not provide a '"+r+"' method"),l=1);i=e}else if((n=(d=p.n<0)?c:t.call(o,p))!==a)break}catch(n){i=e,l=1,c=n}finally{s=1}}return{value:n,done:d}}}(t,r,i),!0),s}var a={};function l(){}function c(){}function s(){}n=Object.getPrototypeOf;var u=[][o]?n(n([][o]())):(xo(n={},o,function(){return this}),n),d=s.prototype=l.prototype=Object.create(u);function p(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,s):(e.__proto__=s,xo(e,r,"GeneratorFunction")),e.prototype=Object.create(d),e}return c.prototype=s,xo(d,"constructor",s),xo(s,"constructor",c),c.displayName="GeneratorFunction",xo(s,r,"GeneratorFunction"),xo(d),xo(d,r,"Generator"),xo(d,o,function(){return this}),xo(d,"toString",function(){return"[object Generator]"}),(Ao=function(){return{w:i,m:p}})()}function xo(e,n,t,o){var r=Object.defineProperty;try{r({},"",{})}catch(e){r=0}xo=function(e,n,t,o){function i(n,t){xo(e,n,function(e){return this._invoke(n,t,e)})}n?r?r(e,n,{value:t,enumerable:!o,configurable:!o,writable:!o}):e[n]=t:(i("next",0),i("throw",1),i("return",2))},xo(e,n,t,o)}function Oo(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),t.push.apply(t,o)}return t}function No(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?Oo(Object(t),!0).forEach(function(n){_o(e,n,t[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Oo(Object(t)).forEach(function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})}return e}function _o(e,n,t){return(n=function(e){var n=function(e){if("object"!=So(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var t=n.call(e,"string");if("object"!=So(t))return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==So(n)?n:n+""}(n))in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function Ro(e,n){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=function(e,n){if(e){if("string"==typeof e)return Po(e,n);var t={}.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?Po(e,n):void 0}}(e))||n&&e&&"number"==typeof e.length){t&&(e=t);var o=0,r=function(){};return{s:r,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,l=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return a=e.done,e},e:function(e){l=!0,i=e},f:function(){try{a||null==t.return||t.return()}finally{if(l)throw i}}}}function Po(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,o=Array(n);t<n;t++)o[t]=e[t];return o}function Io(e,n,t,o,r,i,a){try{var l=e[i](a),c=l.value}catch(e){return void t(e)}l.done?n(c):Promise.resolve(c).then(o,r)}function Do(e){return function(){var n=this,t=arguments;return new Promise(function(o,r){var i=e.apply(n,t);function a(e){Io(i,o,r,a,l,"next",e)}function l(e){Io(i,o,r,a,l,"throw",e)}a(void 0)})}}console.log("[LLM Content] Script Start (v3.0.25 - Enhanced DOM Cleanup)");var Ho=G,zo=function(e){if("string"!=typeof e||!e.trim())return"";var n;if("undefined"!=typeof marked)try{n=marked.parse(e,{sanitize:!1})}catch(t){U("[LLM Utils]","Marked parse error:",t),n=e.replace(/\n/g,"<br>")}else n=e.replace(/\n/g,"<br>");return"undefined"!=typeof DOMPurify?DOMPurify.sanitize(n,{ALLOWED_TAGS:["b","i","em","strong","p","br","ul","ol","li","blockquote","pre","code","h1","h2","h3","h4","h5","h6"],ALLOWED_ATTR:["title","class"]}):n},Fo=!1,jo="",Uo="",Bo=null,Go=null,Jo=null,qo=[],Ko=!1;function Yo(){return Wo.apply(this,arguments)}function Wo(){return(Wo=Do(Ao().m(function e(){return Ao().w(function(e){for(;;)if(0===e.n)return e.a(2,new Promise(function(e){chrome.runtime.sendMessage({action:"getJoplinToken"},function(n){if(!Co("getJoplinToken",Fo))return n&&"success"===n.status?void e(n.token||null):(Fo&&console.warn("[LLM Content] Failed to load Joplin token from background:",(null==n?void 0:n.message)||"No response"),void e((null==n?void 0:n.token)||null));e(null)})}))},e)}))).apply(this,arguments)}var $o=function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(n>100)return n;var t,o=n,r=Ro(e.children);try{for(r.s();!(t=r.n()).done;){var i=t.value;o=Math.max(o,$o(i,n+1))}}catch(e){r.e(e)}finally{r.f()}return o},Xo=function(e){var n,t=1,o=Ro(e.children);try{for(o.s();!(n=o.n()).done;){var r=n.value;t+=Xo(r)}}catch(e){o.e(e)}finally{o.f()}return t};function Vo(){if(!(n&&se&&o&&Qe&&Ho&&z)){var e="Error: Core components (static imports) not properly loaded for processing.";return console.error("[LLM Content]",e,{Highlighter:n,SummaryPopup:o,showError:Ho,TurndownService:z}),void(Ho||console.error)(e)}var t=se();if(!t)return Fo&&console.warn("[LLM Content] processSelectedElement called but no element is selected."),void Ho("Error: No element selected to process.");var r=function(e,n){if(n.length>1048576)return{valid:!1,error:"Error: Selected content exceeds maximum size of ".concat(1024,"KB. Please select a smaller section.")};var t=$o(e);if(t>100)return{valid:!1,error:"Error: Selected content has excessive nesting depth (".concat(t,"). Please select a simpler section.")};var o=Xo(e);return o>1e4?{valid:!1,error:"Error: Selected content contains too many elements (".concat(o,"). Please select a smaller section.")}:{valid:!0}}(t,t.outerHTML);if(!r.valid)return Ho(r.error,!0,tt),void ce();ce();var i=t.outerHTML;if(Bo=i,!i||""===i.trim())return Fo&&console.warn("[LLM Content] Selected element has no HTML content to summarize."),void Ho("Error: Selected element has no content.");var a,l,c,s,u=t.innerHTML,d=ho(u,{debug:Fo});if(Fo&&(console.log("[LLM Content] HTML sanitization complete - Original Inner HTML:",u.length,"chars, Sanitized Inner HTML:",d.length,"chars"),console.log("[LLM Content] Checking for HTML tags in:",d.substring(0,100))),c=/<\s*(p|div|span|br|ul|ol|li|a|img|h[1-6]|pre|code|table|thead|tbody|tr|td|th|blockquote|strong|b|em|i|section|article|header|footer|nav|figure|figcaption|hr)\b/i.test(l="string"==typeof(a=d)?a:""),Fo&&console.log("[LLM Content] containsCommonHtmlTags:",{hasTags:c,sample:l.substring(0,120)}),!c)return Fo&&console.log("[LLM Content] Detected plain text snippet. Skipping HTMLâ†’Markdown conversion and sending raw text."),void er(Go=d);try{var p=new z({headingStyle:"atx",codeBlockStyle:"fenced",bulletListMarker:"-"});p.remove(["script","style","nav","aside","footer","header","form"]),p.addRule("removeEmptyElements",{filter:function(e){return!("DIV"!==e.nodeName&&"SPAN"!==e.nodeName||e.textContent.trim()||e.querySelector("img, video, audio, iframe"))},replacement:function(){return""}}),s=p.turndown(d),Fo&&console.log("[LLM Content] Successfully converted HTML to Markdown:",s.substring(0,200)+(s.length>200?"...":"")),Fo&&console.log("[LLM Content] Conversion Details - Sanitized Inner HTML Length: "+d.length+", Markdown Length: "+s.length)}catch(e){return console.error("[LLM Content] Error converting HTML to Markdown:",e),void Ho("Error processing content for summarization.")}Go=s;var f,m=gt||50;!s||s.length<m?(Fo&&console.warn("[LLM Content] Markdown output is empty or too short, falling back to raw HTML.","Markdown length: ".concat((null===(f=s)||void 0===f?void 0:f.length)||0)),Ho("Warning: Content processing incomplete, using raw data.",!1,nt),er(i)):er(s)}function Qo(){return(Qo=Do(Ao().m(function e(r){var i,a,l;return Ao().w(function(e){for(;;)switch(e.p=e.n){case 0:if(o&&t&&n&&Ho){e.n=1;break}return console.error("[LLM Content] validateAndSendToLLM called before essential modules loaded!"),e.a(2);case 1:return Fo&&console.log("[LLM Request] Validating cost before sending summarization request."),i="".concat(Date.now(),"-").concat(Math.floor(1e3*Math.random())),jo="Thinking...",a=document.title,e.p=2,e.n=3,Qe("Thinking...",{onCopy:function(){},onChat:sr,onClose:ur,onOptions:dr,onNewsblur:hr},null,null,a,!1,!1);case 3:Fo&&console.log("[LLM Content] Summary popup is now ready."),e.n=5;break;case 4:return e.p=4,l=e.v,console.error("[LLM Content] Error showing summary popup:",l),Ho("Error displaying summary popup."),ke(),ce(),jo="",Bo=null,e.a(2);case 5:nn(!1),chrome.runtime.sendMessage({action:"getSettings"},function(e){if(Co("getSettings",Fo)||!e){var n,t="Error getting settings: ".concat((null===(n=chrome.runtime.lastError)||void 0===n?void 0:n.message)||"No response");return Mo.handle(new Error(t),"validateAndSendToLLM",ko,!0),en(t,null,null,a,!0,!1),ke(),ce(),jo="",void(Bo=null)}if(Fo){var o=No({},e);o.apiKey&&(o.apiKey="[Hidden]"),o.newsblurToken&&(o.newsblurToken="[Hidden]"),console.log("[LLM Content] getSettings response received:",o)}var l=e.maxRequestPrice||Jn||.01,c=e.summaryModelId||"",s=!!e.newsblurToken;if(!c){var u="Error: No summary model selected.";return Ho(u),Fo&&console.error("[LLM Content] Critical: summaryModelId is empty after getSettings"),en(u,null,null,a,!0,!1),ke(),ce(),jo="",void(Bo=null)}var d=r.length,p=ht||227.56/1024,f=Math.ceil(d*p);Fo&&console.log("[LLM Content] Estimated tokens for content: ".concat(f)),chrome.runtime.sendMessage({action:"getModelPricing",modelId:c},function(e){if(Co("getModelPricing",Fo)||!e||"success"!==e.status){var n,t="Error fetching pricing data: ".concat((null===(n=chrome.runtime.lastError)||void 0===n?void 0:n.message)||(null==e?void 0:e.message)||"Unknown error");return Mo.handle(new Error(t),"validateAndSendToLLM",ko,!0),en(t,null,null,a,!0,s),ke(),ce(),jo="",void(Bo=null)}var o=e.pricePerToken||0;if(0===o)return Fo&&console.log("[LLM Content] Free model detected (".concat(c,"), skipping cost validation.")),void Zo(r,i,s);var u=f*o;if(Fo&&console.log("[LLM Content] Estimated cost: $".concat(u.toFixed(6)," (max allowed: $").concat(l.toFixed(3),")")),u>l){var d="Error: Request exceeds max price of $".concat(l.toFixed(3),". Estimated cost: $").concat(u.toFixed(6),".");return Ho(d),en(d,null,null,a,!0,s),ke(),ce(),jo="",void(Bo=null)}Zo(r,i,s)})});case 6:return e.a(2)}},e,null,[[2,4]])}))).apply(this,arguments)}function Zo(e,r,i){Fo&&console.log("[LLM Request] Sending summarization request to background."),chrome.runtime.sendMessage({action:"requestSummary",requestId:r,selectedHtml:e,hasNewsblurToken:i},function(e){if(Co("requestSummary",Fo)){var r="Error sending request: ".concat(chrome.runtime.lastError.message);return Mo.handle(new Error(r),"sendRequestToBackground",ko,!0),o&&en(r,null,null,!0,i),t&&ke(),n&&ce(),jo="",void(Bo=null)}if(e&&"error"===e.status){var a="Error: ".concat(e.message||"Background validation failed.");Ho(a),o&&en(a,null,null,!0,i),t&&ke(),n&&ce(),jo="",Bo=null}else if(e&&"processing"===e.status)Fo&&console.log("[LLM Content] Background acknowledged summary request processing.");else{var l="Error: Unexpected response from background.";Ho(l),o&&en(l,null,null,!0,i),t&&ke(),n&&ce(),jo="",Bo=null}})}function er(e){!function(e){Qo.apply(this,arguments)}(e)}function nr(e,n,o){t&&Te&&(Fo&&console.log("[LLM Content] handleElementSelected called for:",e),Te(n,o,or,rr,lr,!!Jo,ir,!0))}function tr(){Fo&&console.log("[LLM Content] handleElementDeselected called."),null!=o&&Ze&&Ze(),null!=t&&ke&&ke(),jo="",Uo="",Bo=null,Go=null}function or(){n&&t&&o&&r&&(Fo&&console.log("[LLM Content] handleIconClick called."),ke(),le(),Vo())}function rr(){n&&t&&o&&(Fo&&console.log("[LLM Content] handleIconDismiss called."),le(),ce(),jo="",Uo="",Bo=null,Go=null)}function ir(){return ar.apply(this,arguments)}function ar(){return ar=Do(Ao().m(function e(){var n,t,o,r,i,a,l,c;return Ao().w(function(e){for(;;)switch(e.p=e.n){case 0:if(Fo&&console.log("[LLM Content] handleCopyHtmlIconClick called."),n=se()){e.n=1;break}return Ho("No element selected to copy.",!1,et),Fo&&console.error("[LLM Content] No element selected for HTML copy."),e.a(2);case 1:if(e.p=1,t=n.outerHTML,(o=ho(t,{debug:Fo}))&&""!==o.trim()){e.n=2;break}return Ho("Element HTML became empty after cleaning.",!1,et),Fo&&console.error("[LLM Content] HTML sanitization resulted in empty content."),e.a(2);case 2:return r=n.textContent||n.innerText||"",i=new Blob([o],{type:"text/html"}),a=new Blob([r],{type:"text/plain"}),l=new ClipboardItem({"text/html":i,"text/plain":a}),e.n=3,navigator.clipboard.write([l]);case 3:Ho("Element HTML copied to clipboard.",!1,et),Fo&&console.log("[LLM Content] Element HTML copied successfully."),e.n=5;break;case 4:e.p=4,c=e.v,console.error("[LLM Content] Failed to copy element HTML:",c),Ho("Failed to copy element HTML to clipboard.",!1,nt);case 5:return e.p=5,ke(),ce(),e.f(5);case 6:return e.a(2)}},e,null,[[1,4,5,6]])})),ar.apply(this,arguments)}function lr(){return cr.apply(this,arguments)}function cr(){return(cr=Do(Ao().m(function e(){var n,t,o,r,i;return Ao().w(function(e){for(;;)switch(e.n){case 0:if(Fo&&console.log("[LLM Content] handleJoplinIconClick called."),t=null===(n=se())||void 0===n?void 0:n.outerHTML,ke(),ce(),le(),Jo){e.n=1;break}return Ho("Joplin API token is not set. Please go to extension options to set it.",!0,tt),Fo&&console.error("[LLM Content] Joplin token is missing, cannot proceed."),e.a(2);case 1:if(t&&""!==t.trim()){e.n=2;break}return Ho("No content available to send to Joplin.",!0,nt),Fo&&console.error("[LLM Content] No content (HTML) to send to Joplin."),e.a(2);case 2:if((o=ho(t,{debug:Fo}))&&""!==o.trim()&&"<div></div>"!==o.trim()){e.n=5;break}if(console.warn("[LLM Content] JOPLIN FALLBACK TRIGGERED - Sanitization removed all content"),console.log("[LLM Content] Original content length:",t.length),console.log("[LLM Content] Original content preview:",t.substring(0,300)),console.log("[LLM Content] Sanitized content:",o),console.log("[LLM Content] Sanitized content length:",o?o.length:0),(r=yo(t))&&""!==r.trim()){e.n=3;break}return Ho("Content became empty after cleaning. Cannot send to Joplin.",!0,nt),Fo&&console.error("[LLM Content] Even fallback cleaning resulted in empty content."),e.a(2);case 3:return e.n=4,co(Jo,r,i,!0);case 4:case 6:return e.a(2);case 5:return i=window.location.href,Fo&&console.log("[LLM Content] Initiating Joplin note creation with cleaned HTML content and URL:",o.substring(0,100),i),e.n=6,co(Jo,o,i,!0)}},e)}))).apply(this,arguments)}function sr(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;Fo&&console.log("[LLM Content] handlePopupChat called. Target Language: ".concat(e)),function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=Bo,t=Go;if(!n||""===n.trim())return Ho("Cannot open chat: No element content available."),void(Fo&&console.warn("[LLM Chat Context] Chat attempt failed: lastSelectedDomSnippet is null or empty."));if(!jo||"Thinking..."===jo||jo.startsWith("Error:")||"Error: Could not parse summary response."===jo)return Ho("Cannot open chat: No valid summary available."),void(Fo&&console.warn("[LLM Chat Context] Chat attempt failed: No valid summary found in lastSummary."));var r={domSnippet:n,summary:jo,chatTargetLanguage:e,modelUsedForSummary:Uo,processedMarkdown:t||""};Fo&&console.log("[LLM Chat Context] Preparing context payload for background:",r),chrome.runtime.sendMessage(No({action:"setChatContext"},r),function(e){Co("setChatContext",Fo)?Mo.handle(new Error(chrome.runtime.lastError.message),"openChatWithContext",ko,!0):e&&"ok"===e.status?(Fo&&console.log("[LLM Chat Context] Background confirmed context storage. Requesting tab open."),chrome.runtime.sendMessage({action:"openChatTab"},function(e){Co("openChatTab",Fo)?Mo.handle(new Error(chrome.runtime.lastError.message),"openChatWithContext",ko,!1):(Fo&&console.log("[LLM Chat Context] Background ack openChatTab:",e),o&&Ze(),jo="",Uo="",Bo=null,Go=null)})):(console.error("[LLM Chat Context] Background did not confirm context storage:",e),Ho("Failed to prepare chat context."))})}(e)}function ur(){o&&n&&t&&(Fo&&console.log("[LLM Content] handlePopupClose called."),Ze(),jo="",Uo="",Bo=null,Go=null)}function dr(){Fo&&console.log("[LLM Content] handlePopupOptions called."),chrome.runtime.sendMessage({action:"openOptionsPage"},function(e){Co("openOptionsPage",Fo)&&Mo.handle(new Error(chrome.runtime.lastError.message),"handlePopupOptions",ko,!0)}),o&&Ze(),n&&ce(),t&&ke(),jo="",Bo=null}var pr=function(){var e=Do(Ao().m(function e(t){var r;return Ao().w(function(e){for(;;)switch(e.p=e.n){case 0:if(null==n?void 0:se()){e.n=1;break}return console.warn("[LLM Content] Received processSelection but no element selected."),Ho("Error: No element selected. Use Alt+Click first."),o&&(Qe("Error: No element selected. Use Alt+Click first.",{onCopy:function(){},onChat:function(){},onClose:Ze,onNewsblur:hr},null,null,document.title,!0,!1),nn(!1),setTimeout(Ze,nt)),t({status:"error",message:"No element selected"}),e.a(2);case 1:return e.p=1,e.n=2,Vo();case 2:t({status:"processing"}),e.n=4;break;case 3:e.p=3,r=e.v,t({status:"error",message:r.message});case 4:return e.a(2)}},e,null,[[1,3]])}));return function(n){return e.apply(this,arguments)}}(),fr=function(){var e=Do(Ao().m(function e(n,t){return Ao().w(function(e){for(;;)switch(e.n){case 0:try{gr(n),t({status:"success"})}catch(e){t({status:"error",message:e.message})}case 1:return e.a(2)}},e)}));return function(n,t){return e.apply(this,arguments)}}(),mr=function(e,n,t){return Fo&&console.log("[LLM Content] Handling message:",e.action),Do(Ao().m(function n(){var o;return Ao().w(function(n){for(;;)switch(n.p=n.n){case 0:if(n.p=0,"processSelection"!==e.action){n.n=2;break}return n.n=1,pr(t);case 1:n.n=5;break;case 2:if("summaryResult"!==e.action){n.n=4;break}return n.n=3,fr(e,t);case 3:n.n=5;break;case 4:t({status:"error",message:"Unknown action: ".concat(e.action)});case 5:n.n=7;break;case 6:n.p=6,o=n.v,console.error("[LLM Content] Error handling message:",o),t({status:"error",message:o.message});case 7:return n.a(2)}},n,null,[[0,6]])}))(),!0};function gr(e){Fo&&console.log("[LLM Content] Received summary result from background:",e.requestId,"Raw Summary:",e.summary),Uo=e.model||"Unknown";var n=window.location.href,t=document.title,r=e.hasNewsblurToken||!1;if(!o)return console.error("[LLM Content] SummaryPopup not available for summaryResult"),void(jo="Error: UI components not ready.");if(e.error)jo="Error: ".concat(e.error),Ho("Error: ".concat(e.error)),en("Error: ".concat(e.error),null,n,t,!0,r),nn(!1);else if(e.summary&&"string"==typeof e.summary){var i=e.summary;if(!i||""===i.trim())return Ho("Error: No summary data received from the API."),void nn(!1);var a=i;jo=a,nn(!0),en(a,null,n,t,!1,r,Uo),Fo&&console.log("[LLM Content] Successfully processed HTML summary. Stored HTML for chat context:",jo.substring(0,100)+"...")}else jo="Error: No summary data received or invalid format.",Ho("Error: No summary data received or invalid format."),en("Error: No summary data received or invalid format.",null,n,t,!0,r),nn(!1)}function hr(e){if(Fo&&console.log("[LLM Content] handlePopupNewsblur called."),!e){var n="NewsBlur token is missing. Please set it in the options.";return console.error("[LLM Content] NewsBlur share failed: "+n),void Ho(n)}if(!jo||"Thinking..."===jo||jo.startsWith("Error:")){var t="No valid summary available to share.";return console.error("[LLM Content] Share failed: "+t),void Ho(t)}if(!Bo){var o="No original content selected to share.";return console.error("[LLM Content] Share failed: "+o),void Ho(o)}chrome.storage.sync.get([hn],function(e){var n;if(Co("getSettingsForShare",Fo))Mo.handle(new Error(chrome.runtime.lastError.message),"handlePopupNewsblur",ko,!0);else{var t=null!==(n=e[hn])&&void 0!==n&&n,o=jo,r=document.title,i=window.location.href,a=function(e){return ho(e,{debug:arguments.length>1&&void 0!==arguments[1]&&arguments[1]})}(Bo,Fo),l=a;try{if("undefined"!=typeof marked){var c=(new z).turndown(a);l=marked.parse(c),Fo&&(console.log("[LLM Content] Two-stage cleaning completed successfully"),console.log("[LLM Content] Original length:",Bo.length),console.log("[LLM Content] After sanitization:",a.length),console.log("[LLM Content] After standardization:",l.length))}else console.warn("[LLM Content] marked library not available, using sanitized HTML only"),Fo&&console.log("[LLM Content] Falling back to Stage 1 cleaning only")}catch(e){console.error("[LLM Content] Error during Stage 2 cleaning:",e),Fo&&console.log("[LLM Content] Falling back to Stage 1 cleaning due to error")}var s=o+"<hr>"+l;chrome.runtime.sendMessage({action:"shareToNewsblur",options:{title:r,story_url:i,content:s,comments:""}},function(e){Co("shareToNewsblur",Fo)?Mo.handle(new Error(chrome.runtime.lastError.message),"handlePopupNewsblur",ko,!0):"success"===e.status?(console.log("[LLM Content] Successfully sent NewsBlur share request:",e.result),Ho("Shared to NewsBlur successfully!",!1,nt)):(Ho("Failed to share to NewsBlur: ".concat(e.message||"Unknown error")),Fo&&console.error("[LLM Content] Failed to share to NewsBlur:",e))}),t&&Jo&&(Fo&&console.log("[LLM Content] Also sending content to Joplin."),co(Jo,s,i,!0)),Ze(),ce(),ke(),jo="",Uo="",Bo=null,Go=null}})}function yr(){return vr.apply(this,arguments)}function vr(){return(vr=Do(Ao().m(function e(){var i,a,l,c,s;return Ao().w(function(e){for(;;)switch(e.p=e.n){case 0:return e.p=0,e.n=1,chrome.storage.sync.get(["debug","joplinToken"]);case 1:if(i=e.v,Fo=!!i.debug,a=i.joplinToken||null){e.n=3;break}return e.n=2,Yo();case 2:a=e.v;case 3:Jo=a||null,Fo&&console.log("[LLM Content] Initial Debug mode:",Fo,"Joplin Token Loaded:",Jo?"Yes":"No");try{Fo&&console.log("[LLM Content] Checking for global 'marked' (should be pre-loaded via manifest)."),"undefined"==typeof marked?(console.warn("[LLM Content] Global 'marked' is not defined. Markdown rendering might be affected if utils.js relies on it solely."),Ho&&zo.toString().includes('typeof marked !== "undefined"')&&Ho("Warning: Markdown library (marked.js) not fully loaded. Some formatting may be basic.",!1,7e3)):Fo&&console.log("[LLM Content] Global 'marked' is available.")}catch(e){console.error("[LLM Content] Error during marked.min.js check:",e),Ho&&Ho("Error with Markdown library. Formatting may not work.",!1,7e3)}if(void 0!==z){e.n=4;break}throw new Error("TurndownService (static import) is undefined.");case 4:if(n){e.n=5;break}throw new Error("Highlighter module not correctly imported or initializeHighlighter is missing.");case 5:if(t){e.n=6;break}throw new Error("FloatingIcon module not correctly imported or initializeFloatingIcon is missing.");case 6:if(o){e.n=7;break}throw new Error("SummaryPopup module not correctly imported or initializePopupManager is missing.");case 7:if(r){e.n=8;break}throw new Error("constants module not correctly imported.");case 8:if("function"==typeof Ho){e.n=9;break}throw new Error("showError function not correctly imported from utils.");case 9:e.n=10;break;case 10:if(Fo&&console.log("[LLM Content] Statically imported modules appear to be available."),ue({onElementSelected:nr,onElementDeselected:tr,initialDebugState:Fo}),Me({initialDebugState:Fo}),tn(),ao({initialDebugState:Fo}),Ko=!0,Fo&&console.log("[LLM Content] Modules initialized flag set to true."),document.getElementById("llm-notification-container")||((l=document.createElement("div")).id="llm-notification-container",l.className="llm-notification-container",document.body.appendChild(l)),qo.length>0){for(Fo&&console.log("[LLM Content] Processing ".concat(qo.length," queued messages."));qo.length>0;)c=qo.shift(),mr(c.req,c.sender,c.sendResponse);Fo&&console.log("[LLM Content] Finished processing queued messages.")}console.log("[LLM Content] Script Initialized. Modules ready."),e.n=12;break;case 11:e.p=11,s=e.v,console.error("[LLM Content] CRITICAL: Failed to load/initialize components.",s),(Ho||console.error)("Error: OpenRouter Summarizer failed to load components (".concat(s.message,"). Please try reloading the page or reinstalling the extension.")),Ko=!1;case 12:return e.a(2)}},e,null,[[0,11]])}))).apply(this,arguments)}chrome.runtime.onMessage.addListener(function(e,n,t){return Ko?mr(e,0,t):(Fo&&console.warn("[LLM Content] Message received before modules initialized, queuing:",e.action,"Queue size:",qo.length+1),qo.push({req:e,sender:n,sendResponse:t}),!0)}),yr();var br=function(){null!=n&&pe&&pe(),null!=t&&Ce&&Ce(),null!=o&&on&&on(),Ko=!1};window.addEventListener("pagehide",function(){br()}),window.addEventListener("pageshow",function(e){e.persisted&&(br(),yr())})})();