/*! For license information please see pageInteraction.bundle.js.LICENSE.txt */
(()=>{"use strict";var e={d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{getSelectedElement:()=>ee,initializeHighlighter:()=>te,removeSelectionHighlight:()=>V,resetHighlightState:()=>Q});var n={};e.r(n),e.d(n,{createFloatingIcon:()=>ue,initializeFloatingIcon:()=>he,removeFloatingIcon:()=>pe});var r={};e.r(r),e.d(r,{enableChatButton:()=>Kt,hidePopup:()=>Gt,initializePopupManager:()=>Wt,showPopup:()=>Jt,updatePopupContent:()=>Yt});var o={};function i(e,t){return Array(t+1).join(e)}e.r(o),e.d(o,{CHAT_SYSTEM_PROMPT_TEMPLATE:()=>or,CHAT_TRANSLATION_REQUEST_TEMPLATE:()=>ar,CHAT_USER_CONTEXT_TEMPLATE:()=>ir,DEBOUNCE_DELAY:()=>vr,DEFAULT_BULLET_COUNT_NUM:()=>fr,DEFAULT_CACHE_EXPIRY_DAYS:()=>br,DEFAULT_DEBUG_MODE:()=>gr,DEFAULT_FORMAT_INSTRUCTIONS:()=>nr,DEFAULT_MAX_REQUEST_PRICE:()=>yr,DEFAULT_MODEL_OPTIONS:()=>sr,DEFAULT_POSTAMBLE_TEXT:()=>rr,DEFAULT_PREAMBLE_TEMPLATE:()=>tr,DEFAULT_PREPOPULATE_LANGUAGES:()=>lr,DEFAULT_SELECTED_CHAT_MODEL_ID:()=>dr,DEFAULT_SELECTED_SUMMARY_MODEL_ID:()=>hr,DEFAULT_SUMMARY_HISTORY_COUNT:()=>mr,ERROR_API_KEY_INVALID:()=>Rr,ERROR_BAD_REQUEST:()=>Nr,ERROR_CONTENT_FILTERED:()=>_r,ERROR_NETWORK:()=>Tr,ERROR_NO_API_KEY:()=>Er,ERROR_NO_MODEL:()=>Sr,ERROR_RATE_LIMIT:()=>Cr,ERROR_SERVER_ERROR:()=>Or,ERROR_TIMEOUT:()=>Mr,ERROR_UNKNOWN:()=>Ar,FALLBACK_SVG_PATH:()=>pr,JOPLIN_API_BASE_URL:()=>Kn,JOPLIN_API_FOLDERS_ENDPOINT:()=>Wn,JOPLIN_API_NOTES_ENDPOINT:()=>Xn,LANGUAGES_JSON_PATH:()=>cr,MAX_RETRIES:()=>wr,MIN_MARKDOWN_LENGTH:()=>Pr,OPENROUTER_API_URL:()=>kr,PROMPT_STORAGE_KEY_CUSTOM_FORMAT:()=>Zn,PROMPT_STORAGE_KEY_DEFAULT_FORMAT:()=>er,PROMPT_STORAGE_KEY_POSTAMBLE:()=>Vn,PROMPT_STORAGE_KEY_PREAMBLE:()=>Qn,REQUEST_TIMEOUT:()=>Lr,RETRY_DELAY:()=>xr,STORAGE_KEY_ALSO_SEND_TO_JOPLIN:()=>Yn,STORAGE_KEY_API_KEY:()=>In,STORAGE_KEY_BULLET_COUNT:()=>Bn,STORAGE_KEY_CHAT_MODEL_ID:()=>$n,STORAGE_KEY_DEBUG:()=>Hn,STORAGE_KEY_JOPLIN_TOKEN:()=>Gn,STORAGE_KEY_KNOWN_MODELS_AND_PRICES:()=>Un,STORAGE_KEY_LANGUAGE_INFO:()=>Fn,STORAGE_KEY_MAX_REQUEST_PRICE:()=>qn,STORAGE_KEY_MODELS:()=>Dn,STORAGE_KEY_NEWSBLUR_TOKEN:()=>Jn,STORAGE_KEY_SUMMARY_HISTORY:()=>jn,STORAGE_KEY_SUMMARY_MODEL_ID:()=>zn,SVG_PATH_PREFIX:()=>ur,TOKENS_PER_CHAR:()=>Ir});var a=["ADDRESS","ARTICLE","ASIDE","AUDIO","BLOCKQUOTE","BODY","CANVAS","CENTER","DD","DIR","DIV","DL","DT","FIELDSET","FIGCAPTION","FIGURE","FOOTER","FORM","FRAMESET","H1","H2","H3","H4","H5","H6","HEADER","HGROUP","HR","HTML","ISINDEX","LI","MAIN","MENU","NAV","NOFRAMES","NOSCRIPT","OL","OUTPUT","P","PRE","SECTION","TABLE","TBODY","TD","TFOOT","TH","THEAD","TR","UL"];function s(e){return p(e,a)}var l=["AREA","BASE","BR","COL","COMMAND","EMBED","HR","IMG","INPUT","KEYGEN","LINK","META","PARAM","SOURCE","TRACK","WBR"];function c(e){return p(e,l)}var u=["A","TABLE","THEAD","TBODY","TFOOT","TH","TD","IFRAME","SCRIPT","AUDIO","VIDEO"];function p(e,t){return t.indexOf(e.nodeName)>=0}function h(e,t){return e.getElementsByTagName&&t.some((function(t){return e.getElementsByTagName(t).length}))}var d={};function f(e){return e?e.replace(/(\n+\s*)+/g,"\n"):""}function g(e){for(var t in this.options=e,this._keep=[],this._remove=[],this.blankRule={replacement:e.blankReplacement},this.keepReplacement=e.keepReplacement,this.defaultRule={replacement:e.defaultReplacement},this.array=[],e.rules)this.array.push(e.rules[t])}function m(e,t,n){for(var r=0;r<e.length;r++){var o=e[r];if(y(o,t,n))return o}}function y(e,t,n){var r=e.filter;if("string"==typeof r){if(r===t.nodeName.toLowerCase())return!0}else if(Array.isArray(r)){if(r.indexOf(t.nodeName.toLowerCase())>-1)return!0}else{if("function"!=typeof r)throw new TypeError("`filter` needs to be a string, array, or function");if(r.call(e,t,n))return!0}}function b(e){var t=e.nextSibling||e.parentNode;return e.parentNode.removeChild(e),t}function k(e,t,n){return e&&e.parentNode===t||n(t)?t.nextSibling||t.parentNode:t.firstChild||t.nextSibling||t.parentNode}d.paragraph={filter:"p",replacement:function(e){return"\n\n"+e+"\n\n"}},d.lineBreak={filter:"br",replacement:function(e,t,n){return n.br+"\n"}},d.heading={filter:["h1","h2","h3","h4","h5","h6"],replacement:function(e,t,n){var r=Number(t.nodeName.charAt(1));return"setext"===n.headingStyle&&r<3?"\n\n"+e+"\n"+i(1===r?"=":"-",e.length)+"\n\n":"\n\n"+i("#",r)+" "+e+"\n\n"}},d.blockquote={filter:"blockquote",replacement:function(e){return"\n\n"+(e=(e=e.replace(/^\n+|\n+$/g,"")).replace(/^/gm,"> "))+"\n\n"}},d.list={filter:["ul","ol"],replacement:function(e,t){var n=t.parentNode;return"LI"===n.nodeName&&n.lastElementChild===t?"\n"+e:"\n\n"+e+"\n\n"}},d.listItem={filter:"li",replacement:function(e,t,n){e=e.replace(/^\n+/,"").replace(/\n+$/,"\n").replace(/\n/gm,"\n    ");var r=n.bulletListMarker+"   ",o=t.parentNode;if("OL"===o.nodeName){var i=o.getAttribute("start"),a=Array.prototype.indexOf.call(o.children,t);r=(i?Number(i)+a:a+1)+".  "}return r+e+(t.nextSibling&&!/\n$/.test(e)?"\n":"")}},d.indentedCodeBlock={filter:function(e,t){return"indented"===t.codeBlockStyle&&"PRE"===e.nodeName&&e.firstChild&&"CODE"===e.firstChild.nodeName},replacement:function(e,t,n){return"\n\n    "+t.firstChild.textContent.replace(/\n/g,"\n    ")+"\n\n"}},d.fencedCodeBlock={filter:function(e,t){return"fenced"===t.codeBlockStyle&&"PRE"===e.nodeName&&e.firstChild&&"CODE"===e.firstChild.nodeName},replacement:function(e,t,n){for(var r,o=((t.firstChild.getAttribute("class")||"").match(/language-(\S+)/)||[null,""])[1],a=t.firstChild.textContent,s=n.fence.charAt(0),l=3,c=new RegExp("^"+s+"{3,}","gm");r=c.exec(a);)r[0].length>=l&&(l=r[0].length+1);var u=i(s,l);return"\n\n"+u+o+"\n"+a.replace(/\n$/,"")+"\n"+u+"\n\n"}},d.horizontalRule={filter:"hr",replacement:function(e,t,n){return"\n\n"+n.hr+"\n\n"}},d.inlineLink={filter:function(e,t){return"inlined"===t.linkStyle&&"A"===e.nodeName&&e.getAttribute("href")},replacement:function(e,t){var n=t.getAttribute("href");n&&(n=n.replace(/([()])/g,"\\$1"));var r=f(t.getAttribute("title"));return r&&(r=' "'+r.replace(/"/g,'\\"')+'"'),"["+e+"]("+n+r+")"}},d.referenceLink={filter:function(e,t){return"referenced"===t.linkStyle&&"A"===e.nodeName&&e.getAttribute("href")},replacement:function(e,t,n){var r,o,i=t.getAttribute("href"),a=f(t.getAttribute("title"));switch(a&&(a=' "'+a+'"'),n.linkReferenceStyle){case"collapsed":r="["+e+"][]",o="["+e+"]: "+i+a;break;case"shortcut":r="["+e+"]",o="["+e+"]: "+i+a;break;default:var s=this.references.length+1;r="["+e+"]["+s+"]",o="["+s+"]: "+i+a}return this.references.push(o),r},references:[],append:function(e){var t="";return this.references.length&&(t="\n\n"+this.references.join("\n")+"\n\n",this.references=[]),t}},d.emphasis={filter:["em","i"],replacement:function(e,t,n){return e.trim()?n.emDelimiter+e+n.emDelimiter:""}},d.strong={filter:["strong","b"],replacement:function(e,t,n){return e.trim()?n.strongDelimiter+e+n.strongDelimiter:""}},d.code={filter:function(e){var t=e.previousSibling||e.nextSibling,n="PRE"===e.parentNode.nodeName&&!t;return"CODE"===e.nodeName&&!n},replacement:function(e){if(!e)return"";e=e.replace(/\r?\n|\r/g," ");for(var t=/^`|^ .*?[^ ].* $|`$/.test(e)?" ":"",n="`",r=e.match(/`+/gm)||[];-1!==r.indexOf(n);)n+="`";return n+t+e+t+n}},d.image={filter:"img",replacement:function(e,t){var n=f(t.getAttribute("alt")),r=t.getAttribute("src")||"",o=f(t.getAttribute("title"));return r?"!["+n+"]("+r+(o?' "'+o+'"':"")+")":""}},g.prototype={add:function(e,t){this.array.unshift(t)},keep:function(e){this._keep.unshift({filter:e,replacement:this.keepReplacement})},remove:function(e){this._remove.unshift({filter:e,replacement:function(){return""}})},forNode:function(e){return e.isBlank?this.blankRule:(t=m(this.array,e,this.options))||(t=m(this._keep,e,this.options))||(t=m(this._remove,e,this.options))?t:this.defaultRule;var t},forEach:function(e){for(var t=0;t<this.array.length;t++)e(this.array[t],t)}};var v,w,x="undefined"!=typeof window?window:{},L=function(){var e=x.DOMParser,t=!1;try{(new e).parseFromString("","text/html")&&(t=!0)}catch(e){}return t}()?x.DOMParser:(v=function(){},function(){var e=!1;try{document.implementation.createHTMLDocument("").open()}catch(t){x.ActiveXObject&&(e=!0)}return e}()?v.prototype.parseFromString=function(e){var t=new window.ActiveXObject("htmlfile");return t.designMode="on",t.open(),t.write(e),t.close(),t}:v.prototype.parseFromString=function(e){var t=document.implementation.createHTMLDocument("");return t.open(),t.write(e),t.close(),t},v);function E(e,t){var n;return function(e){var t=e.element,n=e.isBlock,r=e.isVoid,o=e.isPre||function(e){return"PRE"===e.nodeName};if(t.firstChild&&!o(t)){for(var i=null,a=!1,s=null,l=k(s,t,o);l!==t;){if(3===l.nodeType||4===l.nodeType){var c=l.data.replace(/[ \r\n\t]+/g," ");if(i&&!/ $/.test(i.data)||a||" "!==c[0]||(c=c.substr(1)),!c){l=b(l);continue}l.data=c,i=l}else{if(1!==l.nodeType){l=b(l);continue}n(l)||"BR"===l.nodeName?(i&&(i.data=i.data.replace(/ $/,"")),i=null,a=!1):r(l)||o(l)?(i=null,a=!0):i&&(a=!1)}var u=k(s,l,o);s=l,l=u}i&&(i.data=i.data.replace(/ $/,""),i.data||b(i))}}({element:n="string"==typeof e?(w=w||new L).parseFromString('<x-turndown id="turndown-root">'+e+"</x-turndown>","text/html").getElementById("turndown-root"):e.cloneNode(!0),isBlock:s,isVoid:c,isPre:t.preformattedCode?S:null}),n}function S(e){return"PRE"===e.nodeName||"CODE"===e.nodeName}function T(e,t){return e.isBlock=s(e),e.isCode="CODE"===e.nodeName||e.parentNode.isCode,e.isBlank=function(e){return!c(e)&&!function(e){return p(e,u)}(e)&&/^\s*$/i.test(e.textContent)&&!function(e){return h(e,l)}(e)&&!function(e){return h(e,u)}(e)}(e),e.flankingWhitespace=function(e,t){if(e.isBlock||t.preformattedCode&&e.isCode)return{leading:"",trailing:""};var n,r={leading:(n=e.textContent.match(/^(([ \t\r\n]*)(\s*))(?:(?=\S)[\s\S]*\S)?((\s*?)([ \t\r\n]*))$/))[1],leadingAscii:n[2],leadingNonAscii:n[3],trailing:n[4],trailingNonAscii:n[5],trailingAscii:n[6]};return r.leadingAscii&&M("left",e,t)&&(r.leading=r.leadingNonAscii),r.trailingAscii&&M("right",e,t)&&(r.trailing=r.trailingNonAscii),{leading:r.leading,trailing:r.trailing}}(e,t),e}function M(e,t,n){var r,o,i;return"left"===e?(r=t.previousSibling,o=/ $/):(r=t.nextSibling,o=/^ /),r&&(3===r.nodeType?i=o.test(r.nodeValue):n.preformattedCode&&"CODE"===r.nodeName?i=!1:1!==r.nodeType||s(r)||(i=o.test(r.textContent))),i}var C=Array.prototype.reduce,R=[[/\\/g,"\\\\"],[/\*/g,"\\*"],[/^-/g,"\\-"],[/^\+ /g,"\\+ "],[/^(=+)/g,"\\$1"],[/^(#{1,6}) /g,"\\$1 "],[/`/g,"\\`"],[/^~~~/g,"\\~~~"],[/\[/g,"\\["],[/\]/g,"\\]"],[/^>/g,"\\>"],[/_/g,"\\_"],[/^(\d+)\. /g,"$1\\. "]];function A(e){if(!(this instanceof A))return new A(e);var t={rules:d,headingStyle:"setext",hr:"* * *",bulletListMarker:"*",codeBlockStyle:"indented",fence:"```",emDelimiter:"_",strongDelimiter:"**",linkStyle:"inlined",linkReferenceStyle:"full",br:"  ",preformattedCode:!1,blankReplacement:function(e,t){return t.isBlock?"\n\n":""},keepReplacement:function(e,t){return t.isBlock?"\n\n"+t.outerHTML+"\n\n":t.outerHTML},defaultReplacement:function(e,t){return t.isBlock?"\n\n"+e+"\n\n":e}};this.options=function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)n.hasOwnProperty(r)&&(e[r]=n[r])}return e}({},t,e),this.rules=new g(this.options)}function _(e){var t=this;return C.call(e.childNodes,(function(e,n){var r="";return 3===(n=new T(n,t.options)).nodeType?r=n.isCode?n.nodeValue:t.escape(n.nodeValue):1===n.nodeType&&(r=O.call(t,n)),P(e,r)}),"")}function N(e){var t=this;return this.rules.forEach((function(n){"function"==typeof n.append&&(e=P(e,n.append(t.options)))})),e.replace(/^[\t\r\n]+/,"").replace(/[\t\r\n\s]+$/,"")}function O(e){var t=this.rules.forNode(e),n=_.call(this,e),r=e.flankingWhitespace;return(r.leading||r.trailing)&&(n=n.trim()),r.leading+t.replacement(n,e,this.options)+r.trailing}function P(e,t){var n=function(e){for(var t=e.length;t>0&&"\n"===e[t-1];)t--;return e.substring(0,t)}(e),r=t.replace(/^\n*/,""),o=Math.max(e.length-n.length,t.length-r.length);return n+"\n\n".substring(0,o)+r}A.prototype={turndown:function(e){if(!function(e){return null!=e&&("string"==typeof e||e.nodeType&&(1===e.nodeType||9===e.nodeType||11===e.nodeType))}(e))throw new TypeError(e+" is not a string, or an element/document/fragment node.");if(""===e)return"";var t=_.call(this,new E(e,this.options));return N.call(this,t)},use:function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)this.use(e[t]);else{if("function"!=typeof e)throw new TypeError("plugin must be a Function or an Array of Functions");e(this)}return this},addRule:function(e,t){return this.rules.add(e,t),this},keep:function(e){return this.rules.keep(e),this},remove:function(e){return this.rules.remove(e),this},escape:function(e){return R.reduce((function(e,t){return e.replace(t[0],t[1])}),e)}};const I=A;console.log("[LLM Utils] Loaded");var D=null;function z(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=document.getElementById("errorDisplay");if(!r){(r=document.createElement("div")).id="errorDisplay",r.style.display="none";var o=document.querySelector(".chat-container");o?o.insertBefore(r,o.firstChild):document.body.insertBefore(r,document.body.firstChild)}if(D&&(clearTimeout(D),D=null),r.textContent=e,r.style.cssText="display: block; color: red; background-color: #ffebee; padding: 10px; border: 1px solid red; border-radius: 4px; margin: 10px auto; width: 80vw; max-width: 800px;",t){var i=document.getElementById("chatInput"),a=document.querySelector('#chatForm button[type="submit"]');i&&(i.disabled=!0),a&&(a.disabled=!0)}D=n>0?setTimeout((function(){r.style.display="none",r.textContent="",D=null}),n):null}console.log("[LLM Highlighter] Script Loaded (v3.0.3)");var $="llm-highlight-preview",H="llm-highlight",B=!1,F=null,j=null,q=null,U=null,J=!1;function G(e){if("Alt"===e.key&&!B){var t=document.activeElement;if(t&&("INPUT"===t.tagName||"TEXTAREA"===t.tagName||t.isContentEditable))return void(J&&console.log("[LLM Highlighter] Ignoring Alt down in input/editable element."));B=!0,J&&console.log("[LLM Highlighter] Alt key down.")}}function Y(e){"Alt"===e.key&&(J&&console.log("[LLM Highlighter] Alt key up."),j||Q())}function K(e){if(B){var t=document.elementFromPoint(e.clientX,e.clientY);if(!t||t.closest(".summarizer-popup")||t.closest(".llm-floating-icon"))Z();else{if((t===document.body||t===document.documentElement)&&document.elementsFromPoint(e.clientX,e.clientY).length>1){var n=document.elementsFromPoint(e.clientX,e.clientY)[1];if(!n||n.closest(".summarizer-popup")||n.closest(".llm-floating-icon"))return void Z();t=n}t!==j?F!==t&&(Z(),(F=t)&&F.classList.add($)):Z()}}else Z()}function W(e){!e.relatedTarget&&F&&(J&&console.log("[LLM Highlighter] Mouse left window."),Z())}function X(e){if(e.target.closest(".llm-floating-icon")||e.target.closest(".summarizer-popup"))J&&console.log("[LLM Highlighter] Mousedown ignored on icon or popup.");else{if(e.altKey&&0===e.button){e.preventDefault(),e.stopPropagation();var t=e.target;return Z(),void(j===t?(J&&console.log("[LLM Highlighter] Deselecting element."),V(),Q(),U&&U()):t?(J&&console.log("[LLM Highlighter] Selecting element:",t),V(),(j=t).classList.add(H),Q(),q&&q(j,e.pageX,e.pageY)):(J&&console.warn("[LLM Highlighter] Alt+Click target invalid."),V(),Q()))}e.altKey||0!==e.button||j&&!j.contains(e.target)&&(J&&console.log("[LLM Highlighter] Click outside detected. Deselecting."),V(),Q(),U&&U())}}function Z(){F&&(document.body.contains(F)&&F.classList.remove($),F=null)}function Q(){J&&console.log("[LLM Highlighter] Resetting highlight state."),B=!1,Z()}function V(){j&&(document.body.contains(j)&&j.classList.remove(H),J&&console.log("[LLM Highlighter] Selection highlight removed."),j=null)}function ee(){return j}function te(e){e&&"function"==typeof e.onElementSelected&&"function"==typeof e.onElementDeselected?(q=e.onElementSelected,U=e.onElementDeselected,J=!!e.initialDebugState,window.addEventListener("keydown",G,!0),window.addEventListener("keyup",Y,!0),window.addEventListener("blur",Q),document.addEventListener("visibilitychange",(function(){"hidden"===document.visibilityState&&Q()})),document.addEventListener("mousemove",K,!0),window.addEventListener("mouseout",W),document.addEventListener("mousedown",X,!0),J&&console.log("[LLM Highlighter] Initialized.")):console.error("[LLM Highlighter] Initialization failed: Required callbacks missing.")}console.log("[LLM FloatingIcon] Script Loaded (v2.40.10)");var ne="llm-floating-icon",re="llm-fallback-icon",oe=null,ie=null,ae=null,se=!1;function le(e){e.stopPropagation(),e.preventDefault(),se&&console.log("[LLM FloatingIcon] Icon clicked."),ie&&ie()}function ce(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),se&&console.log("[LLM FloatingIcon] Icon activated via keyboard."),ie&&ie()),"Escape"===e.key&&(e.preventDefault(),e.stopPropagation(),se&&console.log("[LLM FloatingIcon] Icon dismissed via Escape."),pe(),ae&&ae())}function ue(e,t,n,r,o,i){if(pe(),"function"==typeof n&&"function"==typeof r&&"function"==typeof o){ie=n,(oe=document.createElement("div")).className=ne,oe.setAttribute("aria-label","Summarize this element"),oe.setAttribute("role","button"),oe.setAttribute("tabindex","0"),oe.title="Summarize this element (Click or press Enter)",oe.style.display="flex",oe.style.alignItems="center",oe.style.backgroundColor="rgba(255, 255, 255, 0.9)",oe.style.boxShadow="0 2px 5px rgba(0,0,0,0.2)",i?(oe.style.gap="8px",oe.style.borderRadius="30px",oe.style.padding="8px 16px"):(oe.style.gap="0px",oe.style.borderRadius="50%",oe.style.padding="8px");var a="";try{if("undefined"==typeof chrome||!chrome.runtime||"function"!=typeof chrome.runtime.getURL)throw new Error("chrome.runtime API not available");a=chrome.runtime.getURL("icons/icon32.png")}catch(e){console.warn("[LLM FloatingIcon] Could not get icon URL",e),a=""}var s=document.createElement("img");s.src=a,s.alt="Summarize",s.style.pointerEvents="none",s.style.width="32px",s.style.height="32px",s.onerror=function(){if(s.style.display="none",oe&&!oe.querySelector(".".concat(re))){var e=document.createElement("span");e.className=re,e.textContent="ðŸ’¡",e.style.pointerEvents="none",oe.appendChild(e),se&&console.warn("[LLM FloatingIcon] Failed to load icon image, using fallback.")}},a||s.onerror();var l=document.createElement("div");if(l.style.display="flex",l.style.alignItems="center",l.appendChild(s),oe.appendChild(l),i){var c=document.createElement("div");c.id="llm-joplin-icon-wrapper",c.className="llm-floating-icon-item",c.setAttribute("role","button"),c.setAttribute("tabindex","0"),c.title="Send to Joplin",c.style.cursor="pointer",c.style.backgroundColor="transparent",c.style.borderRadius="50%",c.style.width="32px",c.style.height="32px",c.style.display="flex",c.style.justifyContent="center",c.style.alignItems="center",c.style.boxShadow="none";var u=document.createElement("img");u.src=chrome.runtime.getURL("icons/scissors.svg"),u.alt="Joplin",u.style.width="24px",u.style.height="24px",u.style.pointerEvents="none",c.onclick=function(e){e.stopPropagation(),e.preventDefault(),se&&console.log("[LLM FloatingIcon] Joplin icon clicked."),o&&o()},c.onkeydown=function(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),e.stopPropagation(),se&&console.log("[LLM FloatingIcon] Joplin icon activated via keyboard."),o&&o())},c.appendChild(u),oe.appendChild(c)}oe.style.whiteSpace="nowrap";var p=48;i&&(p=104),oe.style.width="".concat(p,"px"),oe.style.height="".concat(48,"px"),document.body.appendChild(oe);var h=oe.getBoundingClientRect(),d=h.width,f=h.height,g=e-d/2,m=t-f/2;g=Math.max(window.scrollX+5,Math.min(g,window.scrollX+window.innerWidth-d-5)),m=Math.max(window.scrollY+5,Math.min(m,window.scrollY+window.innerHeight-f-5)),oe.style.left="".concat(g,"px"),oe.style.top="".concat(m,"px"),oe.style.pointerEvents="auto",oe.addEventListener("click",le),oe.addEventListener("keydown",ce),document.body.appendChild(oe),se&&console.log("[LLM FloatingIcon] Icon created at",g,m),oe.focus()}else console.error("[LLM FloatingIcon] createFloatingIcon failed: Required callbacks missing.")}function pe(){oe&&oe.parentNode&&(oe.removeEventListener("click",le),oe.removeEventListener("keydown",ce),oe.parentNode.removeChild(oe),se&&console.log("[LLM FloatingIcon] Icon removed.")),oe=null,ie=null,ae=null}function he(e){(se=!(null==e||!e.initialDebugState))&&console.log("[LLM FloatingIcon] Initialized.")}var de={async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null};function fe(e){de=e}var ge={exec:()=>null};function me(e,t=""){let n="string"==typeof e?e:e.source;const r={replace:(e,t)=>{let o="string"==typeof t?t:t.source;return o=o.replace(ye.caret,"$1"),n=n.replace(e,o),r},getRegex:()=>new RegExp(n,t)};return r}var ye={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] /,listReplaceTask:/^\[[ xX]\] +/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/gi,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:e=>new RegExp(`^( {0,3}${e})((?:[\t ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ \t][^\\n]*)?(?:\\n|$))`),hrRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}#`),htmlBeginRegex:e=>new RegExp(`^ {0,${Math.min(3,e-1)}}<(?:[a-z].*>|!--)`,"i")},be=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,ke=/(?:[*+-]|\d{1,9}[.)])/,ve=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,we=me(ve).replace(/bull/g,ke).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),xe=me(ve).replace(/bull/g,ke).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),Le=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,Ee=/(?!\s*\])(?:\\.|[^\[\]\\])+/,Se=me(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",Ee).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),Te=me(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,ke).getRegex(),Me="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",Ce=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,Re=me("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ \t]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ \t]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ \t]*)+\\n|$))","i").replace("comment",Ce).replace("tag",Me).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),Ae=me(Le).replace("hr",be).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Me).getRegex(),_e={blockquote:me(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",Ae).getRegex(),code:/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,def:Se,fences:/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,heading:/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,hr:be,html:Re,lheading:we,list:Te,newline:/^(?:[ \t]*(?:\n|$))+/,paragraph:Ae,table:ge,text:/^[^\n]+/},Ne=me("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",be).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}\t)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Me).getRegex(),Oe={..._e,lheading:xe,table:Ne,paragraph:me(Le).replace("hr",be).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",Ne).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",Me).getRegex()},Pe={..._e,html:me("^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:\"[^\"]*\"|'[^']*'|\\s[^'\"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))").replace("comment",Ce).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:ge,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:me(Le).replace("hr",be).replace("heading"," *#{1,6} *[^\n]").replace("lheading",we).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},Ie=/^( {2,}|\\)\n(?!\s*$)/,De=/[\p{P}\p{S}]/u,ze=/[\s\p{P}\p{S}]/u,$e=/[^\s\p{P}\p{S}]/u,He=me(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,ze).getRegex(),Be=/(?!~)[\p{P}\p{S}]/u,Fe=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,je=me(Fe,"u").replace(/punct/g,De).getRegex(),qe=me(Fe,"u").replace(/punct/g,Be).getRegex(),Ue="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",Je=me(Ue,"gu").replace(/notPunctSpace/g,$e).replace(/punctSpace/g,ze).replace(/punct/g,De).getRegex(),Ge=me(Ue,"gu").replace(/notPunctSpace/g,/(?:[^\s\p{P}\p{S}]|~)/u).replace(/punctSpace/g,/(?!~)[\s\p{P}\p{S}]/u).replace(/punct/g,Be).getRegex(),Ye=me("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,$e).replace(/punctSpace/g,ze).replace(/punct/g,De).getRegex(),Ke=me(/\\(punct)/,"gu").replace(/punct/g,De).getRegex(),We=me(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),Xe=me(Ce).replace("(?:--\x3e|$)","--\x3e").getRegex(),Ze=me("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",Xe).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),Qe=/(?:\[(?:\\.|[^\[\]\\])*\]|\\.|`[^`]*`|[^\[\]\\`])*?/,Ve=me(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",Qe).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),et=me(/^!?\[(label)\]\[(ref)\]/).replace("label",Qe).replace("ref",Ee).getRegex(),tt=me(/^!?\[(ref)\](?:\[\])?/).replace("ref",Ee).getRegex(),nt={_backpedal:ge,anyPunctuation:Ke,autolink:We,blockSkip:/\[[^[\]]*?\]\((?:\\.|[^\\\(\)]|\((?:\\.|[^\\\(\)])*\))*\)|`[^`]*?`|<[^<>]*?>/g,br:Ie,code:/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,del:ge,emStrongLDelim:je,emStrongRDelimAst:Je,emStrongRDelimUnd:Ye,escape:/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,link:Ve,nolink:tt,punctuation:He,reflink:et,reflinkSearch:me("reflink|nolink(?!\\()","g").replace("reflink",et).replace("nolink",tt).getRegex(),tag:Ze,text:/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,url:ge},rt={...nt,link:me(/^!?\[(label)\]\((.*?)\)/).replace("label",Qe).getRegex(),reflink:me(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",Qe).getRegex()},ot={...nt,emStrongRDelimAst:Ge,emStrongLDelim:qe,url:me(/^((?:ftp|https?):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/,"i").replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\.|[^\\])*?(?:\\.|[^\s~\\]))\1(?=[^~]|$)/,text:/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|https?:\/\/|ftp:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/},it={...ot,br:me(Ie).replace("{2,}","*").getRegex(),text:me(ot.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},at={normal:_e,gfm:Oe,pedantic:Pe},st={normal:nt,gfm:ot,breaks:it,pedantic:rt},lt={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},ct=e=>lt[e];function ut(e,t){if(t){if(ye.escapeTest.test(e))return e.replace(ye.escapeReplace,ct)}else if(ye.escapeTestNoEncode.test(e))return e.replace(ye.escapeReplaceNoEncode,ct);return e}function pt(e){try{e=encodeURI(e).replace(ye.percentDecode,"%")}catch{return null}return e}function ht(e,t){const n=e.replace(ye.findPipe,((e,t,n)=>{let r=!1,o=t;for(;--o>=0&&"\\"===n[o];)r=!r;return r?"|":" |"})).split(ye.splitPipe);let r=0;if(n[0].trim()||n.shift(),n.length>0&&!n.at(-1)?.trim()&&n.pop(),t)if(n.length>t)n.splice(t);else for(;n.length<t;)n.push("");for(;r<n.length;r++)n[r]=n[r].trim().replace(ye.slashPipe,"|");return n}function dt(e,t,n){const r=e.length;if(0===r)return"";let o=0;for(;o<r;){const i=e.charAt(r-o-1);if(i!==t||n){if(i===t||!n)break;o++}else o++}return e.slice(0,r-o)}function ft(e,t,n,r,o){const i=t.href,a=t.title||null,s=e[1].replace(o.other.outputLinkReplace,"$1");r.state.inLink=!0;const l={type:"!"===e[0].charAt(0)?"image":"link",raw:n,href:i,title:a,text:s,tokens:r.inlineTokens(s)};return r.state.inLink=!1,l}var gt=class{options;rules;lexer;constructor(e){this.options=e||de}space(e){const t=this.rules.block.newline.exec(e);if(t&&t[0].length>0)return{type:"space",raw:t[0]}}code(e){const t=this.rules.block.code.exec(e);if(t){const e=t[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?e:dt(e,"\n")}}}fences(e){const t=this.rules.block.fences.exec(e);if(t){const e=t[0],n=function(e,t,n){const r=e.match(n.other.indentCodeCompensation);if(null===r)return t;const o=r[1];return t.split("\n").map((e=>{const t=e.match(n.other.beginningSpace);if(null===t)return e;const[r]=t;return r.length>=o.length?e.slice(o.length):e})).join("\n")}(e,t[3]||"",this.rules);return{type:"code",raw:e,lang:t[2]?t[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):t[2],text:n}}}heading(e){const t=this.rules.block.heading.exec(e);if(t){let e=t[2].trim();if(this.rules.other.endingHash.test(e)){const t=dt(e,"#");this.options.pedantic?e=t.trim():t&&!this.rules.other.endingSpaceChar.test(t)||(e=t.trim())}return{type:"heading",raw:t[0],depth:t[1].length,text:e,tokens:this.lexer.inline(e)}}}hr(e){const t=this.rules.block.hr.exec(e);if(t)return{type:"hr",raw:dt(t[0],"\n")}}blockquote(e){const t=this.rules.block.blockquote.exec(e);if(t){let e=dt(t[0],"\n").split("\n"),n="",r="";const o=[];for(;e.length>0;){let t=!1;const i=[];let a;for(a=0;a<e.length;a++)if(this.rules.other.blockquoteStart.test(e[a]))i.push(e[a]),t=!0;else{if(t)break;i.push(e[a])}e=e.slice(a);const s=i.join("\n"),l=s.replace(this.rules.other.blockquoteSetextReplace,"\n    $1").replace(this.rules.other.blockquoteSetextReplace2,"");n=n?`${n}\n${s}`:s,r=r?`${r}\n${l}`:l;const c=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(l,o,!0),this.lexer.state.top=c,0===e.length)break;const u=o.at(-1);if("code"===u?.type)break;if("blockquote"===u?.type){const t=u,i=t.raw+"\n"+e.join("\n"),a=this.blockquote(i);o[o.length-1]=a,n=n.substring(0,n.length-t.raw.length)+a.raw,r=r.substring(0,r.length-t.text.length)+a.text;break}if("list"!==u?.type);else{const t=u,i=t.raw+"\n"+e.join("\n"),a=this.list(i);o[o.length-1]=a,n=n.substring(0,n.length-u.raw.length)+a.raw,r=r.substring(0,r.length-t.raw.length)+a.raw,e=i.substring(o.at(-1).raw.length).split("\n")}}return{type:"blockquote",raw:n,tokens:o,text:r}}}list(e){let t=this.rules.block.list.exec(e);if(t){let n=t[1].trim();const r=n.length>1,o={type:"list",raw:"",ordered:r,start:r?+n.slice(0,-1):"",loose:!1,items:[]};n=r?`\\d{1,9}\\${n.slice(-1)}`:`\\${n}`,this.options.pedantic&&(n=r?n:"[*+-]");const i=this.rules.other.listItemRegex(n);let a=!1;for(;e;){let n=!1,r="",s="";if(!(t=i.exec(e)))break;if(this.rules.block.hr.test(e))break;r=t[0],e=e.substring(r.length);let l=t[2].split("\n",1)[0].replace(this.rules.other.listReplaceTabs,(e=>" ".repeat(3*e.length))),c=e.split("\n",1)[0],u=!l.trim(),p=0;if(this.options.pedantic?(p=2,s=l.trimStart()):u?p=t[1].length+1:(p=t[2].search(this.rules.other.nonSpaceChar),p=p>4?1:p,s=l.slice(p),p+=t[1].length),u&&this.rules.other.blankLine.test(c)&&(r+=c+"\n",e=e.substring(c.length+1),n=!0),!n){const t=this.rules.other.nextBulletRegex(p),n=this.rules.other.hrRegex(p),o=this.rules.other.fencesBeginRegex(p),i=this.rules.other.headingBeginRegex(p),a=this.rules.other.htmlBeginRegex(p);for(;e;){const h=e.split("\n",1)[0];let d;if(c=h,this.options.pedantic?(c=c.replace(this.rules.other.listReplaceNesting,"  "),d=c):d=c.replace(this.rules.other.tabCharGlobal,"    "),o.test(c))break;if(i.test(c))break;if(a.test(c))break;if(t.test(c))break;if(n.test(c))break;if(d.search(this.rules.other.nonSpaceChar)>=p||!c.trim())s+="\n"+d.slice(p);else{if(u)break;if(l.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4)break;if(o.test(l))break;if(i.test(l))break;if(n.test(l))break;s+="\n"+c}u||c.trim()||(u=!0),r+=h+"\n",e=e.substring(h.length+1),l=d.slice(p)}}o.loose||(a?o.loose=!0:this.rules.other.doubleBlankLine.test(r)&&(a=!0));let h,d=null;this.options.gfm&&(d=this.rules.other.listIsTask.exec(s),d&&(h="[ ] "!==d[0],s=s.replace(this.rules.other.listReplaceTask,""))),o.items.push({type:"list_item",raw:r,task:!!d,checked:h,loose:!1,text:s,tokens:[]}),o.raw+=r}const s=o.items.at(-1);if(!s)return;s.raw=s.raw.trimEnd(),s.text=s.text.trimEnd(),o.raw=o.raw.trimEnd();for(let e=0;e<o.items.length;e++)if(this.lexer.state.top=!1,o.items[e].tokens=this.lexer.blockTokens(o.items[e].text,[]),!o.loose){const t=o.items[e].tokens.filter((e=>"space"===e.type)),n=t.length>0&&t.some((e=>this.rules.other.anyLine.test(e.raw)));o.loose=n}if(o.loose)for(let e=0;e<o.items.length;e++)o.items[e].loose=!0;return o}}html(e){const t=this.rules.block.html.exec(e);if(t)return{type:"html",block:!0,raw:t[0],pre:"pre"===t[1]||"script"===t[1]||"style"===t[1],text:t[0]}}def(e){const t=this.rules.block.def.exec(e);if(t){const e=t[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),n=t[2]?t[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",r=t[3]?t[3].substring(1,t[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):t[3];return{type:"def",tag:e,raw:t[0],href:n,title:r}}}table(e){const t=this.rules.block.table.exec(e);if(!t)return;if(!this.rules.other.tableDelimiter.test(t[2]))return;const n=ht(t[1]),r=t[2].replace(this.rules.other.tableAlignChars,"").split("|"),o=t[3]?.trim()?t[3].replace(this.rules.other.tableRowBlankLine,"").split("\n"):[],i={type:"table",raw:t[0],header:[],align:[],rows:[]};if(n.length===r.length){for(const e of r)this.rules.other.tableAlignRight.test(e)?i.align.push("right"):this.rules.other.tableAlignCenter.test(e)?i.align.push("center"):this.rules.other.tableAlignLeft.test(e)?i.align.push("left"):i.align.push(null);for(let e=0;e<n.length;e++)i.header.push({text:n[e],tokens:this.lexer.inline(n[e]),header:!0,align:i.align[e]});for(const e of o)i.rows.push(ht(e,i.header.length).map(((e,t)=>({text:e,tokens:this.lexer.inline(e),header:!1,align:i.align[t]}))));return i}}lheading(e){const t=this.rules.block.lheading.exec(e);if(t)return{type:"heading",raw:t[0],depth:"="===t[2].charAt(0)?1:2,text:t[1],tokens:this.lexer.inline(t[1])}}paragraph(e){const t=this.rules.block.paragraph.exec(e);if(t){const e="\n"===t[1].charAt(t[1].length-1)?t[1].slice(0,-1):t[1];return{type:"paragraph",raw:t[0],text:e,tokens:this.lexer.inline(e)}}}text(e){const t=this.rules.block.text.exec(e);if(t)return{type:"text",raw:t[0],text:t[0],tokens:this.lexer.inline(t[0])}}escape(e){const t=this.rules.inline.escape.exec(e);if(t)return{type:"escape",raw:t[0],text:t[1]}}tag(e){const t=this.rules.inline.tag.exec(e);if(t)return!this.lexer.state.inLink&&this.rules.other.startATag.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:t[0]}}link(e){const t=this.rules.inline.link.exec(e);if(t){const e=t[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(e)){if(!this.rules.other.endAngleBracket.test(e))return;const t=dt(e.slice(0,-1),"\\");if((e.length-t.length)%2==0)return}else{const e=function(e,t){if(-1===e.indexOf(t[1]))return-1;let n=0;for(let r=0;r<e.length;r++)if("\\"===e[r])r++;else if(e[r]===t[0])n++;else if(e[r]===t[1]&&(n--,n<0))return r;return n>0?-2:-1}(t[2],"()");if(-2===e)return;if(e>-1){const n=(0===t[0].indexOf("!")?5:4)+t[1].length+e;t[2]=t[2].substring(0,e),t[0]=t[0].substring(0,n).trim(),t[3]=""}}let n=t[2],r="";if(this.options.pedantic){const e=this.rules.other.pedanticHrefTitle.exec(n);e&&(n=e[1],r=e[3])}else r=t[3]?t[3].slice(1,-1):"";return n=n.trim(),this.rules.other.startAngleBracket.test(n)&&(n=this.options.pedantic&&!this.rules.other.endAngleBracket.test(e)?n.slice(1):n.slice(1,-1)),ft(t,{href:n?n.replace(this.rules.inline.anyPunctuation,"$1"):n,title:r?r.replace(this.rules.inline.anyPunctuation,"$1"):r},t[0],this.lexer,this.rules)}}reflink(e,t){let n;if((n=this.rules.inline.reflink.exec(e))||(n=this.rules.inline.nolink.exec(e))){const e=t[(n[2]||n[1]).replace(this.rules.other.multipleSpaceGlobal," ").toLowerCase()];if(!e){const e=n[0].charAt(0);return{type:"text",raw:e,text:e}}return ft(n,e,n[0],this.lexer,this.rules)}}emStrong(e,t,n=""){let r=this.rules.inline.emStrongLDelim.exec(e);if(r&&(!r[3]||!n.match(this.rules.other.unicodeAlphaNumeric))&&(!r[1]&&!r[2]||!n||this.rules.inline.punctuation.exec(n))){const n=[...r[0]].length-1;let o,i,a=n,s=0;const l="*"===r[0][0]?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(l.lastIndex=0,t=t.slice(-1*e.length+n);null!=(r=l.exec(t));){if(o=r[1]||r[2]||r[3]||r[4]||r[5]||r[6],!o)continue;if(i=[...o].length,r[3]||r[4]){a+=i;continue}if((r[5]||r[6])&&n%3&&!((n+i)%3)){s+=i;continue}if(a-=i,a>0)continue;i=Math.min(i,i+a+s);const t=[...r[0]][0].length,l=e.slice(0,n+r.index+t+i);if(Math.min(n,i)%2){const e=l.slice(1,-1);return{type:"em",raw:l,text:e,tokens:this.lexer.inlineTokens(e)}}const c=l.slice(2,-2);return{type:"strong",raw:l,text:c,tokens:this.lexer.inlineTokens(c)}}}}codespan(e){const t=this.rules.inline.code.exec(e);if(t){let e=t[2].replace(this.rules.other.newLineCharGlobal," ");const n=this.rules.other.nonSpaceChar.test(e),r=this.rules.other.startingSpaceChar.test(e)&&this.rules.other.endingSpaceChar.test(e);return n&&r&&(e=e.substring(1,e.length-1)),{type:"codespan",raw:t[0],text:e}}}br(e){const t=this.rules.inline.br.exec(e);if(t)return{type:"br",raw:t[0]}}del(e){const t=this.rules.inline.del.exec(e);if(t)return{type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2])}}autolink(e){const t=this.rules.inline.autolink.exec(e);if(t){let e,n;return"@"===t[2]?(e=t[1],n="mailto:"+e):(e=t[1],n=e),{type:"link",raw:t[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}url(e){let t;if(t=this.rules.inline.url.exec(e)){let e,n;if("@"===t[2])e=t[0],n="mailto:"+e;else{let r;do{r=t[0],t[0]=this.rules.inline._backpedal.exec(t[0])?.[0]??""}while(r!==t[0]);e=t[0],n="www."===t[1]?"http://"+t[0]:t[0]}return{type:"link",raw:t[0],text:e,href:n,tokens:[{type:"text",raw:e,text:e}]}}}inlineText(e){const t=this.rules.inline.text.exec(e);if(t){const e=this.lexer.state.inRawBlock;return{type:"text",raw:t[0],text:t[0],escaped:e}}}},mt=class e{tokens;options;state;tokenizer;inlineQueue;constructor(e){this.tokens=[],this.tokens.links=Object.create(null),this.options=e||de,this.options.tokenizer=this.options.tokenizer||new gt,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};const t={other:ye,block:at.normal,inline:st.normal};this.options.pedantic?(t.block=at.pedantic,t.inline=st.pedantic):this.options.gfm&&(t.block=at.gfm,this.options.breaks?t.inline=st.breaks:t.inline=st.gfm),this.tokenizer.rules=t}static get rules(){return{block:at,inline:st}}static lex(t,n){return new e(n).lex(t)}static lexInline(t,n){return new e(n).inlineTokens(t)}lex(e){e=e.replace(ye.carriageReturn,"\n"),this.blockTokens(e,this.tokens);for(let e=0;e<this.inlineQueue.length;e++){const t=this.inlineQueue[e];this.inlineTokens(t.src,t.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(e,t=[],n=!1){for(this.options.pedantic&&(e=e.replace(ye.tabCharGlobal,"    ").replace(ye.spaceLine,""));e;){let r;if(this.options.extensions?.block?.some((n=>!!(r=n.call({lexer:this},e,t))&&(e=e.substring(r.raw.length),t.push(r),!0))))continue;if(r=this.tokenizer.space(e)){e=e.substring(r.raw.length);const n=t.at(-1);1===r.raw.length&&void 0!==n?n.raw+="\n":t.push(r);continue}if(r=this.tokenizer.code(e)){e=e.substring(r.raw.length);const n=t.at(-1);"paragraph"===n?.type||"text"===n?.type?(n.raw+="\n"+r.raw,n.text+="\n"+r.text,this.inlineQueue.at(-1).src=n.text):t.push(r);continue}if(r=this.tokenizer.fences(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.heading(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.hr(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.blockquote(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.list(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.html(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.def(e)){e=e.substring(r.raw.length);const n=t.at(-1);"paragraph"===n?.type||"text"===n?.type?(n.raw+="\n"+r.raw,n.text+="\n"+r.raw,this.inlineQueue.at(-1).src=n.text):this.tokens.links[r.tag]||(this.tokens.links[r.tag]={href:r.href,title:r.title});continue}if(r=this.tokenizer.table(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.lheading(e)){e=e.substring(r.raw.length),t.push(r);continue}let o=e;if(this.options.extensions?.startBlock){let t=1/0;const n=e.slice(1);let r;this.options.extensions.startBlock.forEach((e=>{r=e.call({lexer:this},n),"number"==typeof r&&r>=0&&(t=Math.min(t,r))})),t<1/0&&t>=0&&(o=e.substring(0,t+1))}if(this.state.top&&(r=this.tokenizer.paragraph(o))){const i=t.at(-1);n&&"paragraph"===i?.type?(i.raw+="\n"+r.raw,i.text+="\n"+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=i.text):t.push(r),n=o.length!==e.length,e=e.substring(r.raw.length)}else if(r=this.tokenizer.text(e)){e=e.substring(r.raw.length);const n=t.at(-1);"text"===n?.type?(n.raw+="\n"+r.raw,n.text+="\n"+r.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=n.text):t.push(r)}else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}return this.state.top=!0,t}inline(e,t=[]){return this.inlineQueue.push({src:e,tokens:t}),t}inlineTokens(e,t=[]){let n=e,r=null;if(this.tokens.links){const e=Object.keys(this.tokens.links);if(e.length>0)for(;null!=(r=this.tokenizer.rules.inline.reflinkSearch.exec(n));)e.includes(r[0].slice(r[0].lastIndexOf("[")+1,-1))&&(n=n.slice(0,r.index)+"["+"a".repeat(r[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;null!=(r=this.tokenizer.rules.inline.anyPunctuation.exec(n));)n=n.slice(0,r.index)+"++"+n.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);for(;null!=(r=this.tokenizer.rules.inline.blockSkip.exec(n));)n=n.slice(0,r.index)+"["+"a".repeat(r[0].length-2)+"]"+n.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);let o=!1,i="";for(;e;){let r;if(o||(i=""),o=!1,this.options.extensions?.inline?.some((n=>!!(r=n.call({lexer:this},e,t))&&(e=e.substring(r.raw.length),t.push(r),!0))))continue;if(r=this.tokenizer.escape(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.tag(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.link(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.reflink(e,this.tokens.links)){e=e.substring(r.raw.length);const n=t.at(-1);"text"===r.type&&"text"===n?.type?(n.raw+=r.raw,n.text+=r.text):t.push(r);continue}if(r=this.tokenizer.emStrong(e,n,i)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.codespan(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.br(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.del(e)){e=e.substring(r.raw.length),t.push(r);continue}if(r=this.tokenizer.autolink(e)){e=e.substring(r.raw.length),t.push(r);continue}if(!this.state.inLink&&(r=this.tokenizer.url(e))){e=e.substring(r.raw.length),t.push(r);continue}let a=e;if(this.options.extensions?.startInline){let t=1/0;const n=e.slice(1);let r;this.options.extensions.startInline.forEach((e=>{r=e.call({lexer:this},n),"number"==typeof r&&r>=0&&(t=Math.min(t,r))})),t<1/0&&t>=0&&(a=e.substring(0,t+1))}if(r=this.tokenizer.inlineText(a)){e=e.substring(r.raw.length),"_"!==r.raw.slice(-1)&&(i=r.raw.slice(-1)),o=!0;const n=t.at(-1);"text"===n?.type?(n.raw+=r.raw,n.text+=r.text):t.push(r)}else if(e){const t="Infinite loop on byte: "+e.charCodeAt(0);if(this.options.silent){console.error(t);break}throw new Error(t)}}return t}},yt=class{options;parser;constructor(e){this.options=e||de}space(e){return""}code({text:e,lang:t,escaped:n}){const r=(t||"").match(ye.notSpaceStart)?.[0],o=e.replace(ye.endingNewline,"")+"\n";return r?'<pre><code class="language-'+ut(r)+'">'+(n?o:ut(o,!0))+"</code></pre>\n":"<pre><code>"+(n?o:ut(o,!0))+"</code></pre>\n"}blockquote({tokens:e}){return`<blockquote>\n${this.parser.parse(e)}</blockquote>\n`}html({text:e}){return e}heading({tokens:e,depth:t}){return`<h${t}>${this.parser.parseInline(e)}</h${t}>\n`}hr(e){return"<hr>\n"}list(e){const t=e.ordered,n=e.start;let r="";for(let t=0;t<e.items.length;t++){const n=e.items[t];r+=this.listitem(n)}const o=t?"ol":"ul";return"<"+o+(t&&1!==n?' start="'+n+'"':"")+">\n"+r+"</"+o+">\n"}listitem(e){let t="";if(e.task){const n=this.checkbox({checked:!!e.checked});e.loose?"paragraph"===e.tokens[0]?.type?(e.tokens[0].text=n+" "+e.tokens[0].text,e.tokens[0].tokens&&e.tokens[0].tokens.length>0&&"text"===e.tokens[0].tokens[0].type&&(e.tokens[0].tokens[0].text=n+" "+ut(e.tokens[0].tokens[0].text),e.tokens[0].tokens[0].escaped=!0)):e.tokens.unshift({type:"text",raw:n+" ",text:n+" ",escaped:!0}):t+=n+" "}return t+=this.parser.parse(e.tokens,!!e.loose),`<li>${t}</li>\n`}checkbox({checked:e}){return"<input "+(e?'checked="" ':"")+'disabled="" type="checkbox">'}paragraph({tokens:e}){return`<p>${this.parser.parseInline(e)}</p>\n`}table(e){let t="",n="";for(let t=0;t<e.header.length;t++)n+=this.tablecell(e.header[t]);t+=this.tablerow({text:n});let r="";for(let t=0;t<e.rows.length;t++){const o=e.rows[t];n="";for(let e=0;e<o.length;e++)n+=this.tablecell(o[e]);r+=this.tablerow({text:n})}return r&&(r=`<tbody>${r}</tbody>`),"<table>\n<thead>\n"+t+"</thead>\n"+r+"</table>\n"}tablerow({text:e}){return`<tr>\n${e}</tr>\n`}tablecell(e){const t=this.parser.parseInline(e.tokens),n=e.header?"th":"td";return(e.align?`<${n} align="${e.align}">`:`<${n}>`)+t+`</${n}>\n`}strong({tokens:e}){return`<strong>${this.parser.parseInline(e)}</strong>`}em({tokens:e}){return`<em>${this.parser.parseInline(e)}</em>`}codespan({text:e}){return`<code>${ut(e,!0)}</code>`}br(e){return"<br>"}del({tokens:e}){return`<del>${this.parser.parseInline(e)}</del>`}link({href:e,title:t,tokens:n}){const r=this.parser.parseInline(n),o=pt(e);if(null===o)return r;let i='<a href="'+(e=o)+'"';return t&&(i+=' title="'+ut(t)+'"'),i+=">"+r+"</a>",i}image({href:e,title:t,text:n,tokens:r}){r&&(n=this.parser.parseInline(r,this.parser.textRenderer));const o=pt(e);if(null===o)return ut(n);let i=`<img src="${e=o}" alt="${n}"`;return t&&(i+=` title="${ut(t)}"`),i+=">",i}text(e){return"tokens"in e&&e.tokens?this.parser.parseInline(e.tokens):"escaped"in e&&e.escaped?e.text:ut(e.text)}},bt=class{strong({text:e}){return e}em({text:e}){return e}codespan({text:e}){return e}del({text:e}){return e}html({text:e}){return e}text({text:e}){return e}link({text:e}){return""+e}image({text:e}){return""+e}br(){return""}},kt=class e{options;renderer;textRenderer;constructor(e){this.options=e||de,this.options.renderer=this.options.renderer||new yt,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new bt}static parse(t,n){return new e(n).parse(t)}static parseInline(t,n){return new e(n).parseInline(t)}parse(e,t=!0){let n="";for(let r=0;r<e.length;r++){const o=e[r];if(this.options.extensions?.renderers?.[o.type]){const e=o,t=this.options.extensions.renderers[e.type].call({parser:this},e);if(!1!==t||!["space","hr","heading","code","table","blockquote","list","html","paragraph","text"].includes(e.type)){n+=t||"";continue}}const i=o;switch(i.type){case"space":n+=this.renderer.space(i);continue;case"hr":n+=this.renderer.hr(i);continue;case"heading":n+=this.renderer.heading(i);continue;case"code":n+=this.renderer.code(i);continue;case"table":n+=this.renderer.table(i);continue;case"blockquote":n+=this.renderer.blockquote(i);continue;case"list":n+=this.renderer.list(i);continue;case"html":n+=this.renderer.html(i);continue;case"paragraph":n+=this.renderer.paragraph(i);continue;case"text":{let o=i,a=this.renderer.text(o);for(;r+1<e.length&&"text"===e[r+1].type;)o=e[++r],a+="\n"+this.renderer.text(o);n+=t?this.renderer.paragraph({type:"paragraph",raw:a,text:a,tokens:[{type:"text",raw:a,text:a,escaped:!0}]}):a;continue}default:{const e='Token with "'+i.type+'" type was not found.';if(this.options.silent)return console.error(e),"";throw new Error(e)}}}return n}parseInline(e,t=this.renderer){let n="";for(let r=0;r<e.length;r++){const o=e[r];if(this.options.extensions?.renderers?.[o.type]){const e=this.options.extensions.renderers[o.type].call({parser:this},o);if(!1!==e||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(o.type)){n+=e||"";continue}}const i=o;switch(i.type){case"escape":case"text":n+=t.text(i);break;case"html":n+=t.html(i);break;case"link":n+=t.link(i);break;case"image":n+=t.image(i);break;case"strong":n+=t.strong(i);break;case"em":n+=t.em(i);break;case"codespan":n+=t.codespan(i);break;case"br":n+=t.br(i);break;case"del":n+=t.del(i);break;default:{const e='Token with "'+i.type+'" type was not found.';if(this.options.silent)return console.error(e),"";throw new Error(e)}}}return n}},vt=class{options;block;constructor(e){this.options=e||de}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(e){return e}postprocess(e){return e}processAllTokens(e){return e}provideLexer(){return this.block?mt.lex:mt.lexInline}provideParser(){return this.block?kt.parse:kt.parseInline}},wt=new class{defaults={async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null};options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=kt;Renderer=yt;TextRenderer=bt;Lexer=mt;Tokenizer=gt;Hooks=vt;constructor(...e){this.use(...e)}walkTokens(e,t){let n=[];for(const r of e)switch(n=n.concat(t.call(this,r)),r.type){case"table":{const e=r;for(const r of e.header)n=n.concat(this.walkTokens(r.tokens,t));for(const r of e.rows)for(const e of r)n=n.concat(this.walkTokens(e.tokens,t));break}case"list":{const e=r;n=n.concat(this.walkTokens(e.items,t));break}default:{const e=r;this.defaults.extensions?.childTokens?.[e.type]?this.defaults.extensions.childTokens[e.type].forEach((r=>{const o=e[r].flat(1/0);n=n.concat(this.walkTokens(o,t))})):e.tokens&&(n=n.concat(this.walkTokens(e.tokens,t)))}}return n}use(...e){const t=this.defaults.extensions||{renderers:{},childTokens:{}};return e.forEach((e=>{const n={...e};if(n.async=this.defaults.async||n.async||!1,e.extensions&&(e.extensions.forEach((e=>{if(!e.name)throw new Error("extension name required");if("renderer"in e){const n=t.renderers[e.name];t.renderers[e.name]=n?function(...t){let r=e.renderer.apply(this,t);return!1===r&&(r=n.apply(this,t)),r}:e.renderer}if("tokenizer"in e){if(!e.level||"block"!==e.level&&"inline"!==e.level)throw new Error("extension level must be 'block' or 'inline'");const n=t[e.level];n?n.unshift(e.tokenizer):t[e.level]=[e.tokenizer],e.start&&("block"===e.level?t.startBlock?t.startBlock.push(e.start):t.startBlock=[e.start]:"inline"===e.level&&(t.startInline?t.startInline.push(e.start):t.startInline=[e.start]))}"childTokens"in e&&e.childTokens&&(t.childTokens[e.name]=e.childTokens)})),n.extensions=t),e.renderer){const t=this.defaults.renderer||new yt(this.defaults);for(const n in e.renderer){if(!(n in t))throw new Error(`renderer '${n}' does not exist`);if(["options","parser"].includes(n))continue;const r=n,o=e.renderer[r],i=t[r];t[r]=(...e)=>{let n=o.apply(t,e);return!1===n&&(n=i.apply(t,e)),n||""}}n.renderer=t}if(e.tokenizer){const t=this.defaults.tokenizer||new gt(this.defaults);for(const n in e.tokenizer){if(!(n in t))throw new Error(`tokenizer '${n}' does not exist`);if(["options","rules","lexer"].includes(n))continue;const r=n,o=e.tokenizer[r],i=t[r];t[r]=(...e)=>{let n=o.apply(t,e);return!1===n&&(n=i.apply(t,e)),n}}n.tokenizer=t}if(e.hooks){const t=this.defaults.hooks||new vt;for(const n in e.hooks){if(!(n in t))throw new Error(`hook '${n}' does not exist`);if(["options","block"].includes(n))continue;const r=n,o=e.hooks[r],i=t[r];vt.passThroughHooks.has(n)?t[r]=e=>{if(this.defaults.async)return Promise.resolve(o.call(t,e)).then((e=>i.call(t,e)));const n=o.call(t,e);return i.call(t,n)}:t[r]=(...e)=>{let n=o.apply(t,e);return!1===n&&(n=i.apply(t,e)),n}}n.hooks=t}if(e.walkTokens){const t=this.defaults.walkTokens,r=e.walkTokens;n.walkTokens=function(e){let n=[];return n.push(r.call(this,e)),t&&(n=n.concat(t.call(this,e))),n}}this.defaults={...this.defaults,...n}})),this}setOptions(e){return this.defaults={...this.defaults,...e},this}lexer(e,t){return mt.lex(e,t??this.defaults)}parser(e,t){return kt.parse(e,t??this.defaults)}parseMarkdown(e){return(t,n)=>{const r={...n},o={...this.defaults,...r},i=this.onError(!!o.silent,!!o.async);if(!0===this.defaults.async&&!1===r.async)return i(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(null==t)return i(new Error("marked(): input parameter is undefined or null"));if("string"!=typeof t)return i(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(t)+", string expected"));o.hooks&&(o.hooks.options=o,o.hooks.block=e);const a=o.hooks?o.hooks.provideLexer():e?mt.lex:mt.lexInline,s=o.hooks?o.hooks.provideParser():e?kt.parse:kt.parseInline;if(o.async)return Promise.resolve(o.hooks?o.hooks.preprocess(t):t).then((e=>a(e,o))).then((e=>o.hooks?o.hooks.processAllTokens(e):e)).then((e=>o.walkTokens?Promise.all(this.walkTokens(e,o.walkTokens)).then((()=>e)):e)).then((e=>s(e,o))).then((e=>o.hooks?o.hooks.postprocess(e):e)).catch(i);try{o.hooks&&(t=o.hooks.preprocess(t));let e=a(t,o);o.hooks&&(e=o.hooks.processAllTokens(e)),o.walkTokens&&this.walkTokens(e,o.walkTokens);let n=s(e,o);return o.hooks&&(n=o.hooks.postprocess(n)),n}catch(e){return i(e)}}}onError(e,t){return n=>{if(n.message+="\nPlease report this to https://github.com/markedjs/marked.",e){const e="<p>An error occurred:</p><pre>"+ut(n.message+"",!0)+"</pre>";return t?Promise.resolve(e):e}if(t)return Promise.reject(n);throw n}}};function xt(e,t){return wt.parse(e,t)}function Lt(e){return Lt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Lt(e)}function Et(){Et=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",a=o.asyncIterator||"@@asyncIterator",s=o.toStringTag||"@@toStringTag";function l(e,t,n,r){Object.defineProperty(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r})}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function c(t,n,r,o){var i=n&&n.prototype instanceof h?n:h,a=Object.create(i.prototype);return l(a,"_invoke",function(t,n,r){var o=1;return function(i,a){if(3===o)throw Error("Generator is already running");if(4===o){if("throw"===i)throw a;return{value:e,done:!0}}for(r.method=i,r.arg=a;;){var s=r.delegate;if(s){var l=w(s,r);if(l){if(l===p)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(1===o)throw o=4,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=3;var c=u(t,n,r);if("normal"===c.type){if(o=r.done?4:2,c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(o=4,r.method="throw",r.arg=c.arg)}}}(t,r,new E(o||[])),!0),a}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=c;var p={};function h(){}function d(){}function f(){}var g={};l(g,i,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(S([])));y&&y!==n&&r.call(y,i)&&(g=y);var b=f.prototype=h.prototype=Object.create(g);function k(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function v(e,t){function n(o,i,a,s){var l=u(e[o],e,i);if("throw"!==l.type){var c=l.arg,p=c.value;return p&&"object"==Lt(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(p).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,s)}))}s(l.arg)}var o;l(this,"_invoke",(function(e,r){function i(){return new t((function(t,o){n(e,r,t,o)}))}return o=o?o.then(i,i):i()}),!0)}function w(t,n){var r=n.method,o=t.i[r];if(o===e)return n.delegate=null,"throw"===r&&t.i.return&&(n.method="return",n.arg=e,w(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),p;var i=u(o,t.i,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,p;var a=i.arg;return a?a.done?(n[t.r]=a.value,n.next=t.n,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,p):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,p)}function x(e){this.tryEntries.push(e)}function L(t){var n=t[4]||{};n.type="normal",n.arg=e,t[4]=n}function E(e){this.tryEntries=[[-1]],e.forEach(x,this),this.reset(!0)}function S(t){if(null!=t){var n=t[i];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(Lt(t)+" is not iterable")}return d.prototype=f,l(b,"constructor",f),l(f,"constructor",d),l(f,s,d.displayName="GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===d||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,l(e,s,"GeneratorFunction")),e.prototype=Object.create(b),e},t.awrap=function(e){return{__await:e}},k(v.prototype),l(v.prototype,a,(function(){return this})),t.AsyncIterator=v,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var a=new v(c(e,n,r,o),i);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},k(b),l(b,s,"Generator"),l(b,i,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.unshift(r);return function e(){for(;n.length;)if((r=n.pop())in t)return e.value=r,e.done=!1,e;return e.done=!0,e}},t.values=S,E.prototype={constructor:E,reset:function(t){if(this.prev=this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(L),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0][4];if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(e){a.type="throw",a.arg=t,n.next=e}for(var o=n.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i[4],s=this.prev,l=i[1],c=i[2];if(-1===i[0])return r("end"),!1;if(!l&&!c)throw Error("try statement without catch or finally");if(null!=i[0]&&i[0]<=s){if(s<l)return this.method="next",this.arg=e,r(l),!0;if(s<c)return r(c),!1}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r[0]>-1&&r[0]<=this.prev&&this.prev<r[2]){var o=r;break}}o&&("break"===e||"continue"===e)&&o[0]<=t&&t<=o[2]&&(o=null);var i=o?o[4]:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o[2],p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[2]===e)return this.complete(n[4],n[3]),L(n),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[0]===e){var r=n[4];if("throw"===r.type){var o=r.arg;L(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={i:S(t),r:n,n:r},"next"===this.method&&(this.arg=e),p}},t}function St(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}xt.options=xt.setOptions=function(e){return wt.setOptions(e),xt.defaults=wt.defaults,fe(xt.defaults),xt},xt.getDefaults=function(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}},xt.defaults=de,xt.use=function(...e){return wt.use(...e),xt.defaults=wt.defaults,fe(xt.defaults),xt},xt.walkTokens=function(e,t){return wt.walkTokens(e,t)},xt.parseInline=wt.parseInline,xt.Parser=kt,xt.parser=kt.parse,xt.Renderer=yt,xt.TextRenderer=bt,xt.Lexer=mt,xt.lexer=mt.lex,xt.Tokenizer=gt,xt.Hooks=vt,xt.parse=xt,xt.options,xt.setOptions,xt.use,xt.walkTokens,xt.parseInline,kt.parse,mt.lex,console.log("[LLM Popup] Script Loaded (v3.0.18)");var Tt="summarizer-body",Mt="summarizer-btn",Ct="copy-btn",Rt="chat-btn",At="newsblur-btn",_t="close-btn",Nt='\n<div class="'.concat("summarizer-popup",'" style="display: none;">\n    <div class="').concat("summarizer-header-container",'">\n        <div class="').concat("summarizer-header",'">Summary</div>\n    </div>\n    <div class="').concat(Tt,'"></div>\n    <div class="').concat("summarizer-actions",'">\n        <button class="').concat(Mt," ").concat(Ct,'">Copy</button>\n        \x3c!-- Single Chat Button --\x3e\n        <button class="').concat(Mt," ").concat(Rt,'">Chat</button>\n        \x3c!-- New: NewsBlur Button --\x3e\n        <button class="').concat(Mt," ").concat(At,'">â†” NewsBlur</button>\n        \x3c!-- End NewsBlur Button --\x3e\n        \x3c!-- End Single Chat Button --\x3e\n        <button class="').concat(Mt," ").concat(_t,'">Close</button>\n    </div>\n</div>\n'),Ot=null,Pt="",It={onCopy:null,onChat:null,onClose:null,onOptions:null,onNewsblur:null},Dt=null,zt=!1,$t=null,Ht=null,Bt=null,Ft=!1,jt=null;function qt(e){if("string"!=typeof e)return"";var t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML}function Ut(){var e;return e=Et().mark((function e(t,n){var r,o,i,a,s,l,c;return Et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=2;break}return e.abrupt("return");case 2:if(Dt&&clearTimeout(Dt),r="",o="",$t&&$t.length>0?(r="<ul>",$t.forEach((function(e){r+="<li>".concat(xt.parseInline(e),"</li>")})),r+="</ul>",o=$t.map((function(e){return"* ".concat(e)})).join("\n"),Ht&&(i=qt(Bt||Ht),r+='<br><p>Source: <a href="'.concat(qt(Ht),'">').concat(i,"</a></p>"),o+="\n\nSource: ".concat(Ht),Bt&&(o+=" (".concat(Bt,")"))),zt&&console.log("[LLM Popup] Preparing rich text and plain text from original markdown array.")):t&&""!==t.innerHTML.trim()?(r=t.innerHTML,o=t.textContent.replace(/\u00A0/g," ").trim()||"",(a=t.querySelectorAll("li")).length>0&&!o.includes("\n")&&(o=Array.from(a).map((function(e){return"* ".concat(e.textContent.replace(/\u00A0/g," ").trim())})).join("\n")),zt&&console.log("[LLM Popup] Fallback: Preparing rich/plain text from visible popup content.")):"string"!=typeof Pt||Pt.startsWith("<")||(r="<p>".concat(qt(Pt.trim()),"</p>"),o=Pt.trim(),zt&&console.log("[LLM Popup] Fallback: Preparing rich/plain text from currentContent string.")),!r||!o){e.next=33;break}return e.prev=7,s=new Blob([r],{type:"text/html"}),l=new Blob([o],{type:"text/plain"}),c=new ClipboardItem({"text/html":s,"text/plain":l}),e.next=13,navigator.clipboard.write([c]);case 13:n.textContent="Copied!",zt&&console.log("[LLM Popup] Rich text copied successfully."),e.next=31;break;case 17:return e.prev=17,e.t0=e.catch(7),console.error("[LLM Popup] Failed to copy rich text: ",e.t0),e.prev=20,e.next=23,navigator.clipboard.writeText(o);case 23:n.textContent="Copied (Text)!",zt&&console.log("[LLM Popup] Rich text failed, plain text copied as fallback."),e.next=31;break;case 27:e.prev=27,e.t1=e.catch(20),console.error("[LLM Popup] Failed to copy plain text as fallback: ",e.t1),n.textContent="Error";case 31:e.next=35;break;case 33:zt&&console.warn("[LLM Popup] Nothing to copy (HTML or Text)."),n.textContent="Empty";case 35:Dt=setTimeout((function(){n.textContent="Copy",Dt=null}),1500);case 36:case"end":return e.stop()}}),e,null,[[7,17],[20,27]])})),Ut=function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){St(i,r,o,a,s,"next",e)}function s(e){St(i,r,o,a,s,"throw",e)}a(void 0)}))},Ut.apply(this,arguments)}function Jt(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=arguments.length>5&&void 0!==arguments[5]&&arguments[5],a=arguments.length>6&&void 0!==arguments[6]&&arguments[6];return new Promise((function(s){if(Gt(),!t||"function"!=typeof t.onCopy||"function"!=typeof t.onChat||"function"!=typeof t.onClose||"function"!=typeof t.onOptions||"function"!=typeof t.onNewsblur)return console.error("[LLM Popup] showPopup failed: Required callbacks missing."),void s();It=t,Pt=e,$t=n,Ht=r,Bt=o,Ft=i;try{var l=document.createElement("template");l.innerHTML=Nt.trim(),Ot=l.content.firstChild.cloneNode(!0)}catch(e){return console.error("[LLM Popup] Error parsing or cloning popup template:",e),Ot=null,void s()}var c=Ot.querySelector(".".concat(Tt)),u=Ot.querySelector(".".concat(Ct)),p=Ot.querySelector(".".concat(Rt)),h=Ot.querySelector(".".concat(At)),d=Ot.querySelector(".".concat(_t));c?"string"==typeof e?e.startsWith("<ul>")?c.innerHTML=e:c.textContent=e:(c.textContent="Error: Invalid content type.",console.error("[LLM Popup] Invalid content type passed to showPopup:",e)):console.error("[LLM Popup] Cannot set initial content: Popup body div not found."),u?u.onclick=function(){return function(e,t){return Ut.apply(this,arguments)}(c,u)}:console.error("[LLM Popup] Could not attach copy listener: Button missing."),p?Ft?(p.textContent="Options",p.title="Open options to adjust settings",p.onclick=function(){return It.onOptions()},p.disabled=!1,zt&&console.log("[LLM Popup] Button set to 'Options' due to error state.")):(p.textContent="Chat",p.title="Open chat with summary context",p.onclick=function(){return It.onChat(null)},p.disabled=!0,zt&&console.log("[LLM Popup] Button set to 'Chat' for normal state.")):console.error("[LLM Popup] Could not attach chat/options listener: Button missing."),h?(h.onclick=function(){return It.onNewsblur(a)},h.style.display=a?"inline-block":"none"):console.error("[LLM Popup] Could not attach NewsBlur listener: Button missing."),d?d.onclick=function(){return It.onClose()}:console.error("[LLM Popup] Could not attach close listener: Button missing."),document.body.appendChild(Ot),zt&&console.log("[LLM Popup] Popup added to page from template."),jt=function(e){"Escape"===e.key&&(e.preventDefault(),It.onClose&&It.onClose())},document.addEventListener("keydown",jt),Ot.style.display="flex",requestAnimationFrame((function(){Ot?(Ot.classList.add("visible"),zt&&console.log("[LLM Popup] Popup visibility transition started."),s()):s()}))}))}function Gt(){if(Ot){var e=Ot;Ot=null,It={onCopy:null,onChat:null,onClose:null,onOptions:null,onNewsblur:null},Pt="",$t=null,Ht=null,Bt=null,Dt&&clearTimeout(Dt),Dt=null,Ft=!1,jt&&(document.removeEventListener("keydown",jt),jt=null),e.classList.remove("visible");var t=window.getComputedStyle(e),n=1e3*parseFloat(t.transitionDuration);setTimeout((function(){null!=e&&e.parentNode&&(e.parentNode.removeChild(e),zt&&console.log("[LLM Popup] Popup hidden and removed."))}),n>0?n+50:10)}}function Yt(e){var t=arguments.length>5&&void 0!==arguments[5]&&arguments[5];if(Ot){Pt=e,$t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,Ht=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,Bt=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,Ft=arguments.length>4&&void 0!==arguments[4]&&arguments[4];var n=Ot.querySelector(".".concat(Tt)),r=Ot.querySelector(".".concat(Rt)),o=Ot.querySelector(".".concat(At));n?"string"==typeof e?(e.startsWith("<ul>")?n.innerHTML=e:n.textContent=e,zt&&console.log("[LLM Popup] Popup content updated.")):(n.textContent="Error: Invalid content type.",console.error("[LLM Popup] Invalid content type passed to updatePopupContent:",e)):console.error("[LLM Popup] Cannot update content: Popup body div not found."),r&&(Ft?(r.textContent="Options",r.title="Open options to adjust settings",r.onclick=function(){return It.onOptions()},r.disabled=!1,zt&&console.log("[LLM Popup] Button updated to 'Options' due to error state in updatePopupContent.")):(r.textContent="Chat",r.title="Open chat with summary context",r.onclick=function(){return It.onChat(null)},zt&&console.log("[LLM Popup] Button updated to 'Chat' for normal state in updatePopupContent."))),o&&(o.onclick=function(){return It.onNewsblur(t)},o.style.display=t?"inline-block":"none")}else zt&&console.warn("[LLM Popup] updatePopupContent called but popup doesn't exist.")}function Kt(e){if(Ot){var t=Ot.querySelector(".".concat(Rt));t&&(Ft&&"Options"===t.textContent||(t.disabled=!e)),zt&&console.log("[LLM Popup] Chat button ".concat(e?"enabled":"disabled (or kept as Options)","."))}}function Wt(e){(zt=!(null==e||!e.initialDebugState))&&console.log("[LLM Popup] Initialized.")}function Xt(e){return Xt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Xt(e)}function Zt(e,t,n){return(t=function(e){var t=function(e){if("object"!=Xt(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=Xt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Xt(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Qt(){Qt=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",a=o.asyncIterator||"@@asyncIterator",s=o.toStringTag||"@@toStringTag";function l(e,t,n,r){Object.defineProperty(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r})}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function c(t,n,r,o){var i=n&&n.prototype instanceof h?n:h,a=Object.create(i.prototype);return l(a,"_invoke",function(t,n,r){var o=1;return function(i,a){if(3===o)throw Error("Generator is already running");if(4===o){if("throw"===i)throw a;return{value:e,done:!0}}for(r.method=i,r.arg=a;;){var s=r.delegate;if(s){var l=w(s,r);if(l){if(l===p)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(1===o)throw o=4,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=3;var c=u(t,n,r);if("normal"===c.type){if(o=r.done?4:2,c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(o=4,r.method="throw",r.arg=c.arg)}}}(t,r,new E(o||[])),!0),a}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=c;var p={};function h(){}function d(){}function f(){}var g={};l(g,i,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(S([])));y&&y!==n&&r.call(y,i)&&(g=y);var b=f.prototype=h.prototype=Object.create(g);function k(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function v(e,t){function n(o,i,a,s){var l=u(e[o],e,i);if("throw"!==l.type){var c=l.arg,p=c.value;return p&&"object"==Xt(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(p).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,s)}))}s(l.arg)}var o;l(this,"_invoke",(function(e,r){function i(){return new t((function(t,o){n(e,r,t,o)}))}return o=o?o.then(i,i):i()}),!0)}function w(t,n){var r=n.method,o=t.i[r];if(o===e)return n.delegate=null,"throw"===r&&t.i.return&&(n.method="return",n.arg=e,w(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),p;var i=u(o,t.i,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,p;var a=i.arg;return a?a.done?(n[t.r]=a.value,n.next=t.n,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,p):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,p)}function x(e){this.tryEntries.push(e)}function L(t){var n=t[4]||{};n.type="normal",n.arg=e,t[4]=n}function E(e){this.tryEntries=[[-1]],e.forEach(x,this),this.reset(!0)}function S(t){if(null!=t){var n=t[i];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(Xt(t)+" is not iterable")}return d.prototype=f,l(b,"constructor",f),l(f,"constructor",d),l(f,s,d.displayName="GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===d||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,l(e,s,"GeneratorFunction")),e.prototype=Object.create(b),e},t.awrap=function(e){return{__await:e}},k(v.prototype),l(v.prototype,a,(function(){return this})),t.AsyncIterator=v,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var a=new v(c(e,n,r,o),i);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},k(b),l(b,s,"Generator"),l(b,i,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.unshift(r);return function e(){for(;n.length;)if((r=n.pop())in t)return e.value=r,e.done=!1,e;return e.done=!0,e}},t.values=S,E.prototype={constructor:E,reset:function(t){if(this.prev=this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(L),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0][4];if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(e){a.type="throw",a.arg=t,n.next=e}for(var o=n.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i[4],s=this.prev,l=i[1],c=i[2];if(-1===i[0])return r("end"),!1;if(!l&&!c)throw Error("try statement without catch or finally");if(null!=i[0]&&i[0]<=s){if(s<l)return this.method="next",this.arg=e,r(l),!0;if(s<c)return r(c),!1}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r[0]>-1&&r[0]<=this.prev&&this.prev<r[2]){var o=r;break}}o&&("break"===e||"continue"===e)&&o[0]<=t&&t<=o[2]&&(o=null);var i=o?o[4]:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o[2],p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[2]===e)return this.complete(n[4],n[3]),L(n),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[0]===e){var r=n[4];if("throw"===r.type){var o=r.arg;L(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={i:S(t),r:n,n:r},"next"===this.method&&(this.arg=e),p}},t}function Vt(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function en(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){Vt(i,r,o,a,s,"next",e)}function s(e){Vt(i,r,o,a,s,"throw",e)}a(void 0)}))}}console.log("[LLM JoplinManager] Script Loaded");var tn="joplin-popup-body",nn="joplin-btn",rn="joplin-save-btn",on="joplin-cancel-btn",an=null,sn=!1,ln=null,cn=null,un=null,pn=null,hn="lastUsedJoplinNotebookId",dn="lastUsedJoplinNotebookName",fn=null,gn=-1,mn=null,yn=null,bn='\n<div class="'.concat("joplin-popup",'" style="display: none;">\n    <div class="').concat("joplin-popup-header-container",'"> \x3c!-- New: Header container --\x3e\n        <div class="').concat("joplin-popup-header",'">Select Joplin Notebook</div>\n    </div>\n    <div class="').concat(tn,'">\n        \x3c!-- Content will be dynamically inserted here --\x3e\n    </div>\n    <div class="').concat("joplin-popup-actions",'">\n        <button class="').concat(nn," ").concat(rn,'" disabled>Save Note</button>\n        <button class="').concat(nn," ").concat(on,'">Cancel</button>\n    </div>\n</div>\n');function kn(){an&&Cn();var e=document.createElement("template");return e.innerHTML=bn.trim(),an=e.content.firstChild.cloneNode(!0),document.body.appendChild(an),sn&&console.log("[LLM JoplinManager] Joplin popup base created and added to DOM."),an}function vn(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(an){var n=an.querySelector(".".concat(tn));n&&(n.innerHTML=e,n.classList.toggle("placeholder-content",t),sn&&console.log("[LLM JoplinManager] Joplin popup body content updated."))}}function wn(e){if(an){var t=an.querySelector(".".concat(rn)),n=an.querySelector(".".concat(on));t&&(t.disabled=!e),n&&(n.disabled=!1),sn&&console.log("[LLM JoplinManager] Joplin buttons enabled: save=".concat(e))}}function xn(e,t){var n=e.toLowerCase().trim();return n&&0!==t.length?t.filter((function(e){return e.title.toLowerCase().includes(n)})).slice(0,10):[]}function Ln(e,t){if(fn||((fn=document.createElement("div")).className="joplin-autocomplete-dropdown",document.body.appendChild(fn),document.addEventListener("click",Mn)),fn.innerHTML="",gn=-1,0!==t.length){t.forEach((function(t,n){var r=document.createElement("div");r.className="joplin-autocomplete-item",r.dataset.index=n,r.dataset.notebookId=t.id,r.textContent=t.title,r.addEventListener("click",(function(){return Sn(r,e)})),fn.appendChild(r)}));var n=e.getBoundingClientRect();fn.style.position="absolute",fn.style.top="".concat(n.bottom+window.scrollY+4,"px"),fn.style.left="".concat(n.left+window.scrollX,"px"),fn.style.width="".concat(n.width,"px"),fn.style.display="block",mn=e}else fn.style.display="none"}function En(){fn&&(fn.style.display="none",gn=-1),mn=null}function Sn(e,t){t.value=e.textContent,yn=e.dataset.notebookId,wn(!0),En(),sn&&console.log("[LLM JoplinManager] Notebook selected:",e.textContent,"ID:",yn)}function Tn(e){e.forEach((function(e,t){e.classList.toggle("selected",t===gn),t===gn&&e.scrollIntoView({block:"nearest"})}))}function Mn(e){var t=an&&an.contains(e.target),n=fn&&fn.contains(e.target);t||n?!mn||mn.contains(e.target)||n||(En(),sn&&console.log("[LLM JoplinManager] Hidden autocomplete via outside click (inside popup, not input or dropdown)")):(En(),sn&&console.log("[LLM JoplinManager] Hidden autocomplete via outside click (outside popup)"))}function Cn(){if(mn&&(mn.value=""),an&&an.parentNode){an.classList.remove("visible");var e=window.getComputedStyle(an),t=1e3*parseFloat(e.transitionDuration);setTimeout((function(){an&&an.parentNode&&an.parentNode.removeChild(an),an=null,ln=null,cn=null,yn=null,En(),sn&&console.log("[LLM JoplinManager] Joplin popup hidden and removed.")}),t>0?t+50:10)}}function Rn(e,t,n){return An.apply(this,arguments)}function An(){return An=en(Qt().mark((function e(t,n,r){var o,i,a,s;return Qt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=4;break}return z("Joplin API token not found. Please set it in extension options.",!0,5e3),sn&&console.error("[LLM JoplinManager] Fetch failed: Joplin token missing."),e.abrupt("return");case 4:return ln=n,cn=r,yn=null,(o=kn()).style.display="flex",o.classList.add("visible"),vn("<p>Fetching notebooks from Joplin...</p>",!0),wn(!1),(i=o.querySelector(".".concat(on)))&&(i.onclick=function(){return Cn()}),e.prev=14,e.next=17,chrome.runtime.sendMessage({action:"fetchJoplinNotebooks",joplinToken:t});case 17:if(a=e.sent,!chrome.runtime.lastError){e.next=20;break}throw new Error("Background script error: ".concat(chrome.runtime.lastError.message));case 20:if(!("success"===a.status&&a.folders&&a.folders.length>0)){e.next=25;break}s=a.folders.sort((function(e,t){return e.title.localeCompare(t.title)})),_n(t,s),e.next=32;break;case 25:if("success"!==a.status||0!==a.folders.length){e.next=31;break}vn("<p>No Joplin notebooks found. Please create one in Joplin.</p>",!0),wn(!1),sn&&console.log("[LLM JoplinManager] No Joplin notebooks returned."),e.next=32;break;case 31:throw new Error(a.message||"Failed to fetch Joplin notebooks.");case 32:e.next=40;break;case 34:e.prev=34,e.t0=e.catch(14),console.error("[LLM JoplinManager] Error fetching Joplin notebooks:",e.t0),z("Error fetching Joplin notebooks: ".concat(e.t0.message),!0,5e3),vn("<p>Error: ".concat(e.t0.message,"</p>"),!0),wn(!1);case 40:case"end":return e.stop()}}),e,null,[[14,34]])}))),An.apply(this,arguments)}function _n(e,t){if(an){vn('\n        <p>Type to search or select a notebook:</p>\n        <div style="position: relative; width: 100%;">\n            <input type="text" placeholder="Search notebooks..." class="joplin-notebook-search-input">\n        </div>\n    '),wn(!1);var n=an.querySelector(".joplin-notebook-search-input"),r=an.querySelector(".".concat(rn)),o=an.querySelector(".".concat(on));if(t.length>0){var i=null;un&&(i=t.find((function(e){return e.id===un})))&&sn&&console.log("[LLM JoplinManager] Using last used notebook:",i.title),i||(i=t[0],sn&&un&&console.log("[LLM JoplinManager] Last used notebook not found, using first notebook:",i.title)),yn=i.id,n.value=i.title,wn(!0)}else vn("<p>No Joplin notebooks found. Please create one in Joplin, or click 'Cancel'.</p>",!0),n.disabled=!0,r.disabled=!0;n&&(n.addEventListener("input",(function(e){var r,o=e.target.value;yn&&(null===(r=t.find((function(e){return e.id===yn})))||void 0===r?void 0:r.title)!==o&&(yn=null,wn(!1));var i=xn(o,t);Ln(n,i)})),n.addEventListener("keydown",(function(r){return function(e,t,n,r){var o,i=(null===(o=fn)||void 0===o?void 0:o.querySelectorAll(".joplin-autocomplete-item"))||[];if(fn&&"none"!==fn.style.display&&0!==i.length)if("ArrowDown"===e.key)e.preventDefault(),gn=(gn+1)%i.length,Tn(i),t.value=i[gn].textContent;else if("ArrowUp"===e.key)e.preventDefault(),gn=(gn-1+i.length)%i.length,Tn(i),t.value=i[gn].textContent;else if("Enter"===e.key)if(e.preventDefault(),gn>-1)Sn(i[gn],t),Nn(r,yn,t.value.trim());else{var a=t.value.trim(),s=n.find((function(e){return e.title.toLowerCase()===a.toLowerCase()}));s?(yn=s.id,wn(!0),En(),sn&&console.log("[LLM JoplinManager] Notebook immediately selected on Enter (exact match) with suggestions visible but none highlighted:",s.title,"ID:",yn),Nn(r,yn,s.title)):(z("No matching notebook found. Please select from the list.",!1,2e3),yn=null,wn(!1),En())}else"Escape"===e.key&&(e.preventDefault(),Cn());else if("Enter"===e.key)if(yn)e.preventDefault(),Nn(r,yn,t.value.trim());else{var l=t.value.trim(),c=n.find((function(e){return e.title.toLowerCase()===l.toLowerCase()}));c?(yn=c.id,wn(!0),e.preventDefault(),Nn(r,yn,c.title)):(e.preventDefault(),z("No matching notebook found. Please select from the list.",!1,2e3),yn=null,wn(!1))}else"Escape"===e.key&&(e.preventDefault(),Cn())}(r,n,t,e)})),n.addEventListener("focus",(function(){var e=xn(n.value,t);Ln(n,e)})),n.addEventListener("blur",(function(){setTimeout((function(){En();var e=n.value.trim(),r=t.find((function(t){return t.title.toLowerCase()===e.toLowerCase()}));r?r.id!==yn&&(yn=r.id,wn(!0)):(null!==yn&&(yn=null),wn(!1))}),100)}))),r&&(r.onclick=en(Qt().mark((function r(){var o,i,a;return Qt().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!yn){r.next=18;break}if(o=n.value.trim(),!(i=t.find((function(e){return e.id===yn&&e.title===o})))){r.next=8;break}return r.next=6,Nn(e,yn,i.title);case 6:r.next=16;break;case 8:if(!(a=t.find((function(e){return e.title.toLowerCase()===o.toLowerCase()})))){r.next=15;break}return yn=a.id,r.next=13,Nn(e,yn,a.title);case 13:r.next=16;break;case 15:z("Please select a valid notebook from the list.",!0,3e3);case 16:r.next=19;break;case 18:z("Please select a notebook first.",!0,3e3);case 19:case"end":return r.stop()}}),r)})))),o&&(o.onclick=function(){return Cn()}),an.style.display="flex",an.classList.add("visible"),n.focus(),n.select()}else sn&&console.warn("[LLM JoplinManager] Popup element not found for rendering selection.")}function Nn(e,t){return On.apply(this,arguments)}function On(){return On=en(Qt().mark((function e(t,n){var r,o,i,a,s,l=arguments;return Qt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=l.length>2&&void 0!==l[2]?l[2]:"",t&&n&&ln){e.next=6;break}return z("Invalid data for sending note to Joplin.",!0,5e3),sn&&console.error("[LLM JoplinManager] Create note failed: Missing token, parentId, or content."),Cn(),e.abrupt("return");case 6:return z("Sending note to Joplin...",!1,0),wn(!1),o=document.title,i=ln,a="<h1>".concat(Pn(o),'</h1>\n<p><a href="').concat(Pn(cn),'">Original Source</a></p>'),i=a+i,e.prev=12,e.next=15,chrome.runtime.sendMessage({action:"createJoplinNote",joplinToken:t,title:o,source_url:cn,parent_id:n,body_html:i});case 15:if(s=e.sent,!chrome.runtime.lastError){e.next=18;break}throw new Error("Background script error: ".concat(chrome.runtime.lastError.message));case 18:if("success"!==s.status){e.next=24;break}z("Note sent to Joplin successfully!",!1,3e3),sn&&console.log("[LLM JoplinManager] Note created successfully:",s.result),r&&(un=n,pn=r,chrome.storage.local.set(Zt(Zt({},hn,n),dn,r)),sn&&console.log("[LLM JoplinManager] Saved last used notebook:",r,"ID:",n)),e.next=25;break;case 24:throw new Error(s.message||"Failed to create Joplin note.");case 25:e.next=31;break;case 27:e.prev=27,e.t0=e.catch(12),console.error("[LLM JoplinManager] Error sending note to Joplin:",e.t0),z("Error sending note to Joplin: ".concat(e.t0.message),!0,5e3);case 31:return e.prev=31,Cn(),e.finish(31);case 34:case"end":return e.stop()}}),e,null,[[12,27,31,34]])}))),On.apply(this,arguments)}function Pn(e){var t=document.createElement("div");return t.appendChild(document.createTextNode(e)),t.innerHTML}console.log("[LLM Constants] Loaded");var In="apiKey",Dn="models",zn="summaryModelId",$n="chatModelId",Hn="debug",Bn="bulletCount",Fn="language_info",jn="summaryHistory",qn="maxRequestPrice",Un="knownModelsAndPrices",Jn="newsblurToken",Gn="joplinToken",Yn="alsoSendToJoplin",Kn="http://localhost:41184",Wn="/folders",Xn="/notes",Zn="prompt_custom_format_instructions",Qn="prompt_preamble_template",Vn="prompt_postamble_text",er="prompt_default_format_instructions",tr="\nTreat input as Markdown text.\nFirst, determine the language the input is written in.\nSecond, prepare a summary of input containing no more than ${bulletWord} points\nin the language you determined.\nThird, use a JSON array of strings to return the summary.\nEach JSON array element, which is a string, should represent a single bullet point.\n ",nr='Each bullet point should be a concise markdown string,\nstarting with a bold tag-like marker and a colon,\nand followed by description.\n\nAfter providing bullet points for article summary,\nadd a bonus bullet point - your insights, assessment and comments,\nand what should a mindful reader notice about this.\nCall it **Summarizer Insight:**\n\nDo not use phrases "The article discusses", just exlain.\nDo not comment on authors\' attitudes! Just relay the summaries.\nDo not editorialize!\n',rr='\nEnsure the response is ONLY the JSON array.\nDo not include any other text or formatting outside the JSON array.\nYou may use ONLY markdown for emphasis.\nFor example: "**Some bold text:** The market showed **significant** growth in Q3."\n',or="\nBe concise and factual. We no longer need bullet points.\nFormat responses using Markdown where appropriate. Do not use any HTML.\nDo NOT include any text, comments, or other content before or after your message. Do not output your deliberations.\nIMPORTANT CONTEXT HANDLING:\nYour first message in this chat contains an AI-generated summary of the provided Markdown snippet.\nThis summary is a derivative interpretation and should *not* be considered the primary source of truth for answering questions *about the original article content*.\nWhen the user asks about the article, base your answers primarily on the provided 'Context - Original HTML Snippet'.\nOnly refer to or discuss the initial summary if the user explicitly asks about the summary itself,\nits specific points, or any insights it might contain that are not directly present in the original snippet (e.g., summarizer insights).\nDo not repeat or update the initial summary unless specifically requested by the user.\nFocus on answering the user's current question based on the provided article context.\nWhen the user provides text preceded by \"Translate the following text:\", focus on translating *only* that provided text to the target language specified in the same message.\n",ir="Context - Original HTML Snippet:\n```html\n${domSnippet}\n```\n\nInitial Summary:\n${summary}",ar="Translate the following text to ${targetLanguage} and let's continue our conversation in that language: \n\n${textToTranslate}",sr=[{id:"google/gemini-2.0-flash-lite-001"},{id:"anthropic/claude-sonnet-4"},{id:"deepseek/deepseek-r1"},{id:"openai/gpt-4.1-nano"},{id:"x-ai/grok-3-mini-beta"},{id:"google/gemini-2.5-flash-preview"}],lr=["English","Spanish","Hebrew","French"],cr="country-flags/languages.json",ur="country-flags/svg/",pr="country-flags/svg/un.svg",hr=sr.length>0?sr[0].id:"",dr=sr.length>0?sr[0].id:"",fr=5,gr=!1,mr=20,yr=.001,br=7,kr="https://openrouter.ai/api/v1/chat/completions",vr=300,wr=2,xr=1e3,Lr=45e3,Er="API key is missing. Please set it in the extension options.",Sr="No model selected or specified. Please check extension options.",Tr="Network error. Please check your connection and OpenRouter status.",Mr="Request timed out. The model might be taking too long.",Cr="Rate limit exceeded. Please try again later or check your OpenRouter plan.",Rr="Invalid API key. Please verify your OpenRouter key in the options.",Ar="An unknown error occurred.",_r="Content filtered by API provider.",Nr="Bad request. Check model ID and parameters.",Or="OpenRouter server error. Please try again later.",Pr=50,Ir=227.56/1024,Dr={UNWANTED_CLASSES:["advertising","related-news","metainfo__item","headline__inner","sharebox","ml-subscribe-form","article-newsletter-signup--container","n-content-recommended--single-story","styln-edit-storyline","related-links-block","u_sticky-content","ref-ar","undefined","featNewslettersBorder","single__inline-module","comments-inline-cta","llm-highlight-preview"],UNWANTED_TAGS:["script","style","noscript","iframe","embed","object","form","input","button","select","textarea","nav","aside","footer","header"],UNWANTED_ATTRIBUTES:["onclick","onload","onerror","onmouseover","onmouseout","onfocus","onblur","onchange","onsubmit","onreset","onkeydown","onkeyup","onkeypress","data-track","data-analytics","data-gtm","data-ga","data-sara-component","data-module","data-widget","data-testid","data-cy"],UNWANTED_SELECTORS:['[role="application"]','[role="banner"]','[role="navigation"]','[role="complementary"]','[id*="feature-bar"]','[id*="sidebar"]','[id*="footer"]','[id*="header"]','[data-sara-component*="related-articles"]','button[type="button"]',".advertisement",".widget",'[class*="ad-"]','[class*="promo-"]'],ALLOWED_TAGS:["p","div","span","a","img","br","hr","strong","b","em","i","h1","h2","h3","h4","h5","h6","ul","ol","li","blockquote","pre","code","table","thead","tbody","tr","td","th"],ALLOWED_ATTRIBUTES:{a:["href","title"],img:["src","alt","title","width","height"],table:["border","cellpadding","cellspacing"],td:["colspan","rowspan"],th:["colspan","rowspan"]}};function zr(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).debug,n=void 0!==t&&t;if(!e||"string"!=typeof e)return n&&console.warn("[HTML Sanitizer] Invalid HTML input for sanitization"),"";try{var r=document.createElement("div");r.innerHTML=e;var o=n?performance.now():0,i=e.length;n&&(console.log("[HTML Sanitizer] Starting sanitization"),console.log("[HTML Sanitizer] Original HTML length:",i));var a=Dr.UNWANTED_CLASSES;Dr.UNWANTED_TAGS.forEach((function(e){r.querySelectorAll(e).forEach((function(e){e.parentNode&&e.parentNode.removeChild(e)}))})),a.map((function(e){return'//*[contains(@class, "'.concat(e,'")]')})).forEach((function(e){try{for(var t=document.evaluate(e,r,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null),o=0;o<t.snapshotLength;o++){var i=t.snapshotItem(o);i&&i.parentNode&&i.parentNode.removeChild(i)}}catch(t){n&&console.warn("[HTML Sanitizer] XPath selector error: ".concat(e),t)}})),Dr.UNWANTED_SELECTORS.forEach((function(e){try{r.querySelectorAll(e).forEach((function(e){e.parentNode&&e.parentNode.removeChild(e)}))}catch(t){n&&console.warn("[HTML Sanitizer] Invalid selector: ".concat(e),t)}})),r.querySelectorAll("*").forEach((function(e){Dr.UNWANTED_ATTRIBUTES.forEach((function(t){e.hasAttribute(t)&&e.removeAttribute(t)})),Array.from(e.attributes).forEach((function(t){t.name.startsWith("data-")&&(t.name.includes("track")||t.name.includes("analytics")||t.name.includes("gtm")||t.name.includes("ga-"))&&e.removeAttribute(t.name)}))})),r.querySelectorAll("div:empty, span:empty, p:empty").forEach((function(e){e.parentNode&&!e.hasChildNodes()&&e.parentNode.removeChild(e)}));var s=r.innerHTML,l=r.textContent||r.innerText||"",c=r.querySelectorAll("img").length>0,u=r.querySelectorAll("a").length>0;if(n){var p=performance.now(),h=s.length,d=((i-h)/i*100).toFixed(1);console.log("[HTML Sanitizer] Sanitization complete"),console.log("[HTML Sanitizer] Final HTML length:",h),console.log("[HTML Sanitizer] Text content length:",l.trim().length),console.log("[HTML Sanitizer] Has images:",c),console.log("[HTML Sanitizer] Has links:",u),console.log("[HTML Sanitizer] Size reduction:",d+"%"),console.log("[HTML Sanitizer] Processing time:",(p-o).toFixed(2)+"ms"),0!==l.trim().length||c||u||(console.warn("[HTML Sanitizer] WARNING: Sanitization may have removed all meaningful content!"),console.log("[HTML Sanitizer] Original HTML preview:",e.substring(0,200)),console.log("[HTML Sanitizer] Cleaned HTML:",s))}return s}catch(t){return console.error("[HTML Sanitizer] Error during HTML sanitization:",t),e}}function $r(e){return $r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$r(e)}function Hr(){Hr=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",a=o.asyncIterator||"@@asyncIterator",s=o.toStringTag||"@@toStringTag";function l(e,t,n,r){Object.defineProperty(e,t,{value:n,enumerable:!r,configurable:!r,writable:!r})}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function c(t,n,r,o){var i=n&&n.prototype instanceof h?n:h,a=Object.create(i.prototype);return l(a,"_invoke",function(t,n,r){var o=1;return function(i,a){if(3===o)throw Error("Generator is already running");if(4===o){if("throw"===i)throw a;return{value:e,done:!0}}for(r.method=i,r.arg=a;;){var s=r.delegate;if(s){var l=w(s,r);if(l){if(l===p)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(1===o)throw o=4,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=3;var c=u(t,n,r);if("normal"===c.type){if(o=r.done?4:2,c.arg===p)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(o=4,r.method="throw",r.arg=c.arg)}}}(t,r,new E(o||[])),!0),a}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=c;var p={};function h(){}function d(){}function f(){}var g={};l(g,i,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(S([])));y&&y!==n&&r.call(y,i)&&(g=y);var b=f.prototype=h.prototype=Object.create(g);function k(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function v(e,t){function n(o,i,a,s){var l=u(e[o],e,i);if("throw"!==l.type){var c=l.arg,p=c.value;return p&&"object"==$r(p)&&r.call(p,"__await")?t.resolve(p.__await).then((function(e){n("next",e,a,s)}),(function(e){n("throw",e,a,s)})):t.resolve(p).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,s)}))}s(l.arg)}var o;l(this,"_invoke",(function(e,r){function i(){return new t((function(t,o){n(e,r,t,o)}))}return o=o?o.then(i,i):i()}),!0)}function w(t,n){var r=n.method,o=t.i[r];if(o===e)return n.delegate=null,"throw"===r&&t.i.return&&(n.method="return",n.arg=e,w(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),p;var i=u(o,t.i,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,p;var a=i.arg;return a?a.done?(n[t.r]=a.value,n.next=t.n,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,p):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,p)}function x(e){this.tryEntries.push(e)}function L(t){var n=t[4]||{};n.type="normal",n.arg=e,t[4]=n}function E(e){this.tryEntries=[[-1]],e.forEach(x,this),this.reset(!0)}function S(t){if(null!=t){var n=t[i];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError($r(t)+" is not iterable")}return d.prototype=f,l(b,"constructor",f),l(f,"constructor",d),l(f,s,d.displayName="GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===d||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,l(e,s,"GeneratorFunction")),e.prototype=Object.create(b),e},t.awrap=function(e){return{__await:e}},k(v.prototype),l(v.prototype,a,(function(){return this})),t.AsyncIterator=v,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var a=new v(c(e,n,r,o),i);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},k(b),l(b,s,"Generator"),l(b,i,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.unshift(r);return function e(){for(;n.length;)if((r=n.pop())in t)return e.value=r,e.done=!1,e;return e.done=!0,e}},t.values=S,E.prototype={constructor:E,reset:function(t){if(this.prev=this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(L),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0][4];if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(e){a.type="throw",a.arg=t,n.next=e}for(var o=n.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i[4],s=this.prev,l=i[1],c=i[2];if(-1===i[0])return r("end"),!1;if(!l&&!c)throw Error("try statement without catch or finally");if(null!=i[0]&&i[0]<=s){if(s<l)return this.method="next",this.arg=e,r(l),!0;if(s<c)return r(c),!1}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r[0]>-1&&r[0]<=this.prev&&this.prev<r[2]){var o=r;break}}o&&("break"===e||"continue"===e)&&o[0]<=t&&t<=o[2]&&(o=null);var i=o?o[4]:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o[2],p):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),p},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[2]===e)return this.complete(n[4],n[3]),L(n),p}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n[0]===e){var r=n[4];if("throw"===r.type){var o=r.arg;L(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={i:S(t),r:n,n:r},"next"===this.method&&(this.arg=e),p}},t}function Br(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Fr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Br(Object(n),!0).forEach((function(t){jr(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Br(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function jr(e,t,n){return(t=function(e){var t=function(e){if("object"!=$r(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=$r(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==$r(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function qr(e,t,n,r,o,i,a){try{var s=e[i](a),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(r,o)}function Ur(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){qr(i,r,o,a,s,"next",e)}function s(e){qr(i,r,o,a,s,"throw",e)}a(void 0)}))}}console.log("[LLM Content] Script Start (v3.0.25 - Enhanced DOM Cleanup)");var Jr=z,Gr=function(e){if("string"!=typeof e||!e.trim())return"";if("undefined"==typeof marked)return e.replace(/\n/g,"<br>");try{return marked.parse(e,{sanitize:!0})}catch(t){return console.error("[LLM Utils] Marked parse error:",t),e.replace(/\n/g,"<br>")}},Yr=!1,Kr="",Wr="",Xr=null,Zr=null,Qr=null,Vr=[],eo=!1;function to(){if(!(t&&ee&&r&&Jt&&Jr&&I)){var e="Error: Core components (static imports) not properly loaded for processing.";return console.error("[LLM Content]",e,{Highlighter:t,SummaryPopup:r,showError:Jr,TurndownService:I}),void(Jr||console.error)(e)}var n=ee();if(!n)return Yr&&console.warn("[LLM Content] processSelectedElement called but no element is selected."),void Jr("Error: No element selected to process.");Xr=n.outerHTML,Yr&&console.log("[LLM Content] Stored selected element snippet for chat context:",Xr.substring(0,200)+(Xr.length>200?"...":"")),V();var o=n.outerHTML;if(!o||""===o.trim())return Yr&&console.warn("[LLM Content] Selected element has no HTML content to summarize."),void Jr("Error: Selected element has no content.");var i,a=zr(o,{debug:Yr});Yr&&console.log("[LLM Content] HTML sanitization complete - Original:",o.length,"chars, Sanitized:",a.length,"chars");try{var s=new I({headingStyle:"atx",codeBlockStyle:"fenced",bulletListMarker:"-"});s.remove(["script","style","nav","aside","footer","header","form"]),s.addRule("removeEmptyElements",{filter:function(e){return!("DIV"!==e.nodeName&&"SPAN"!==e.nodeName||e.textContent.trim()||e.querySelector("img, video, audio, iframe"))},replacement:function(){return""}}),i=s.turndown(a),Yr&&console.log("[LLM Content] Successfully converted HTML to Markdown:",i.substring(0,200)+(i.length>200?"...":"")),Yr&&console.log("[LLM Content] Conversion Details - Sanitized HTML Length: "+a.length+", Markdown Length: "+i.length)}catch(e){return console.error("[LLM Content] Error converting HTML to Markdown:",e),void Jr("Error processing content for summarization.")}Zr=i;var l,c=Pr||50;!i||i.length<c?(Yr&&console.warn("[LLM Content] Markdown output is empty or too short, falling back to raw HTML.","Markdown length: ".concat((null===(l=i)||void 0===l?void 0:l.length)||0)),Jr("Warning: Content processing incomplete, using raw data.",!1,3e3),oo(selectedHtml)):oo(i)}function no(){return(no=Ur(Hr().mark((function e(o){var i,a;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r&&n&&t&&Jr){e.next=3;break}return console.error("[LLM Content] validateAndSendToLLM called before essential modules loaded!"),e.abrupt("return");case 3:return Yr&&console.log("[LLM Request] Validating cost before sending summarization request."),i="".concat(Date.now(),"-").concat(Math.floor(1e3*Math.random())),Kr="Thinking...",a=document.title,e.prev=7,e.next=10,Jt("Thinking...",{onCopy:function(){},onChat:po,onClose:ho,onOptions:fo,onNewsblur:mo},null,null,a,!1,!1);case 10:Yr&&console.log("[LLM Content] Summary popup is now ready."),e.next=22;break;case 13:return e.prev=13,e.t0=e.catch(7),console.error("[LLM Content] Error showing summary popup:",e.t0),Jr("Error displaying summary popup."),pe(),V(),Kr="",Xr=null,e.abrupt("return");case 22:Kt(!1),chrome.runtime.sendMessage({action:"getSettings"},(function(e){if(chrome.runtime.lastError||!e){var t;Yr&&console.error("[LLM Content] getSettings message response error:",chrome.runtime.lastError,e);var n="Error getting settings: ".concat((null===(t=chrome.runtime.lastError)||void 0===t?void 0:t.message)||"No response");return Jr(n),Yt(n,null,null,a,!0,!1),pe(),V(),Kr="",void(Xr=null)}if(Yr){var r=Fr({},e);r.apiKey&&(r.apiKey="[Hidden]"),r.newsblurToken&&(r.newsblurToken="[Hidden]"),console.log("[LLM Content] getSettings response received:",r)}var s=e.maxRequestPrice||yr||.01,l=e.summaryModelId||"",c=!!e.newsblurToken;if(!l){var u="Error: No summary model selected.";return Jr(u),Yr&&console.error("[LLM Content] Critical: summaryModelId is empty after getSettings"),Yt(u,null,null,a,!0,!1),pe(),V(),Kr="",void(Xr=null)}var p=o.length,h=Ir||227.56/1024,d=Math.ceil(p*h);Yr&&console.log("[LLM Content] Estimated tokens for content: ".concat(d)),chrome.runtime.sendMessage({action:"getModelPricing",modelId:l},(function(e){if(chrome.runtime.lastError||!e||"success"!==e.status){var t,n="Error fetching pricing data: ".concat((null===(t=chrome.runtime.lastError)||void 0===t?void 0:t.message)||(null==e?void 0:e.message)||"Unknown error");return Jr(n),Yt(n,null,null,a,!0,c),pe(),V(),Kr="",void(Xr=null)}var r=e.pricePerToken||0;if(0===r)return Yr&&console.log("[LLM Content] Free model detected (".concat(l,"), skipping cost validation.")),void ro(o,i,c);var u=d*r;if(Yr&&console.log("[LLM Content] Estimated cost: $".concat(u.toFixed(6)," (max allowed: $").concat(s.toFixed(3),")")),u>s){var p="Error: Request exceeds max price of $".concat(s.toFixed(3),". Estimated cost: $").concat(u.toFixed(6),".");return Jr(p),Yt(p,null,null,a,!0,c),pe(),V(),Kr="",void(Xr=null)}ro(o,i,c)}))}));case 24:case"end":return e.stop()}}),e,null,[[7,13]])})))).apply(this,arguments)}function ro(e,o,i){Yr&&console.log("[LLM Request] Sending summarization request to background."),chrome.runtime.sendMessage({action:"requestSummary",requestId:o,selectedHtml:e,hasNewsblurToken:i},(function(e){if(chrome.runtime.lastError){var o="Error sending request: ".concat(chrome.runtime.lastError.message);return Jr(o),r&&Yt(o,null,null,!0,i),n&&pe(),t&&V(),Kr="",void(Xr=null)}if(e&&"error"===e.status){var a="Error: ".concat(e.message||"Background validation failed.");Jr(a),r&&Yt(a,null,null,!0,i),n&&pe(),t&&V(),Kr="",Xr=null}else if(e&&"processing"===e.status)Yr&&console.log("[LLM Content] Background acknowledged summary request processing.");else{var s="Error: Unexpected response from background.";Jr(s),r&&Yt(s,null,null,!0,i),n&&pe(),t&&V(),Kr="",Xr=null}}))}function oo(e){!function(e){no.apply(this,arguments)}(e)}function io(e,t,r){n&&ue&&(Yr&&console.log("[LLM Content] handleElementSelected called for:",e),ue(t,r,so,lo,co,!!Qr))}function ao(){r&&Gt&&(Yr&&console.log("[LLM Content] handleElementDeselected called."),Gt(),Kr="",Wr="",Xr=null,Zr=null)}function so(){t&&n&&r&&o&&(Yr&&console.log("[LLM Content] handleIconClick called."),pe(),Q(),to())}function lo(){t&&n&&r&&(Yr&&console.log("[LLM Content] handleIconDismiss called."),Q(),V(),Kr="",Wr="",Xr=null,Zr=null)}function co(){return uo.apply(this,arguments)}function uo(){return(uo=Ur(Hr().mark((function e(){var t,n,r,o,i;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Yr&&console.log("[LLM Content] handleJoplinIconClick called."),pe(),Qr){e.next=6;break}return Jr("Joplin API token is not set. Please go to extension options to set it.",!0,5e3),Yr&&console.error("[LLM Content] Joplin token is missing, cannot proceed."),e.abrupt("return");case 6:if((n=(null===(t=ee())||void 0===t?void 0:t.outerHTML)||Xr)&&""!==n.trim()){e.next=11;break}return Jr("No content available to send to Joplin.",!0,3e3),Yr&&console.error("[LLM Content] No content (HTML) to send to Joplin."),e.abrupt("return");case 11:if((r=zr(n,{debug:Yr}))&&""!==r.trim()&&"<div></div>"!==r.trim()){e.next=26;break}if(console.warn("[LLM Content] JOPLIN FALLBACK TRIGGERED - Sanitization removed all content"),console.log("[LLM Content] Original content length:",n.length),console.log("[LLM Content] Original content preview:",n.substring(0,300)),console.log("[LLM Content] Sanitized content:",r),console.log("[LLM Content] Sanitized content length:",r?r.length:0),(o=(a=n)&&"string"==typeof a?a:"")&&""!==o.trim()){e.next=23;break}return Jr("Content became empty after cleaning. Cannot send to Joplin.",!0,3e3),Yr&&console.error("[LLM Content] Even fallback cleaning resulted in empty content."),e.abrupt("return");case 23:return e.next=25,Rn(Qr,o,i,!0);case 25:return e.abrupt("return");case 26:return i=window.location.href,Yr&&console.log("[LLM Content] Initiating Joplin note creation with cleaned HTML content and URL:",r.substring(0,100),i),e.next=31,Rn(Qr,r,i,!0);case 31:case"end":return e.stop()}var a}),e)})))).apply(this,arguments)}function po(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;Yr&&console.log("[LLM Content] handlePopupChat called. Target Language: ".concat(e)),function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=Xr,n=Zr;if(!t||""===t.trim())return Jr("Cannot open chat: No element content available."),void(Yr&&console.warn("[LLM Chat Context] Chat attempt failed: lastSelectedDomSnippet is null or empty."));if(!Kr||"Thinking..."===Kr||Kr.startsWith("Error:")||"Error: Could not parse summary response."===Kr)return Jr("Cannot open chat: No valid summary available."),void(Yr&&console.warn("[LLM Chat Context] Chat attempt failed: No valid summary found in lastSummary."));var o={domSnippet:t,summary:Kr,chatTargetLanguage:e,modelUsedForSummary:Wr,processedMarkdown:n||""};Yr&&console.log("[LLM Chat Context] Preparing context payload for background:",o),chrome.runtime.sendMessage(Fr({action:"setChatContext"},o),(function(e){if(chrome.runtime.lastError)return console.error("[LLM Chat Context] Error sending context:",chrome.runtime.lastError),void Jr("Error preparing chat: ".concat(chrome.runtime.lastError.message));e&&"ok"===e.status?(Yr&&console.log("[LLM Chat Context] Background confirmed context storage. Requesting tab open."),chrome.runtime.sendMessage({action:"openChatTab"},(function(e){chrome.runtime.lastError?console.error("[LLM Chat Context] Error requesting tab open:",chrome.runtime.lastError):(Yr&&console.log("[LLM Chat Context] Background ack openChatTab:",e),r&&Gt(),Kr="",Wr="",Xr=null,Zr=null)}))):(console.error("[LLM Chat Context] Background did not confirm context storage:",e),Jr("Failed to prepare chat context."))}))}(e)}function ho(){r&&t&&n&&(Yr&&console.log("[LLM Content] handlePopupClose called."),Gt(),Kr="",Wr="",Xr=null,Zr=null)}function fo(){Yr&&console.log("[LLM Content] handlePopupOptions called."),chrome.runtime.sendMessage({action:"openOptionsPage"},(function(e){chrome.runtime.lastError&&(console.error("[LLM Content] Error opening options page:",chrome.runtime.lastError),Jr("Error opening options page."))})),r&&Gt(),t&&V(),n&&pe(),Kr="",Xr=null}function go(e,n,o){if(Yr&&console.log("[LLM Content] Handling message:",e.action),"processSelection"===e.action)return Yr&&console.log("[LLM Content] Received processSelection command."),t&&ee()?(to(),o({status:"processing started"}),!0):(console.warn("[LLM Content] Received processSelection but no element is selected."),Jr("Error: No element selected. Use Alt+Click first."),r&&(Jt("Error: No element selected. Use Alt+Click first.",{onCopy:function(){},onChat:function(){},onClose:Gt,onNewsblur:mo},null,null,document.title,!0,!1),Kt(!1),setTimeout(Gt,3e3)),o({status:"no element selected"}),!1);if("summaryResult"===e.action){Yr&&console.log("[LLM Content] Received summary result from background:",e.requestId,"Raw Summary:",e.summary),Wr=e.model||"Unknown";var i=window.location.href,a=document.title,s=e.hasNewsblurToken||!1;if(!r||!Gr)return console.error("[LLM Content] SummaryPopup or renderTextAsHtml not available for summaryResult"),Kr="Error: UI components not ready.",!0;if(e.error)Kr="Error: ".concat(e.error),Jr("Error: ".concat(e.error)),Yt("Error: ".concat(e.error),null,i,a,!0,s),Kt(!1);else if(e.summary&&"string"==typeof e.summary){var l=e.summary,c=[],u="";try{var p=JSON.parse(l);if(!Array.isArray(p))throw new Error("Response is not an array.");if(!((c=p.map(String)).length>0))throw new Error("No valid JSON arrays found or parsed from summary string.");u="<ul>"+c.map((function(e){return"<li>".concat(Gr(e),"</li>")})).join("")+"</ul>",Kr=JSON.stringify(c),Yt(u,c,i,a,!1,s),Kt(!0),Yr&&console.log("[LLM Content] Successfully processed summary. Stored valid JSON string for chat context:",Kr)}catch(e){console.error("[LLM Content] Error processing summary string: ".concat(e.message,". Raw: ").concat(l.substring(0,100))),Jr("Error processing summary: ".concat(e.message)),Yt((u=Gr(l))+"<br><small>(Raw response shown due to parsing error)</small>",null,i,a,!0,s),Kr="Error: Could not parse summary response.",Kt(!1)}}else Kr="Error: No summary data received or invalid format.",Jr("Error: No summary data received or invalid format."),Yt("Error: No summary data received or invalid format.",null,i,a,!0,s),Kt(!1);return!0}return!1}function mo(e){if(Yr&&console.log("[LLM Content] handlePopupNewsblur called."),!e){var t="NewsBlur token is missing. Please set it in the options.";return console.error("[LLM Content] NewsBlur share failed: "+t),void Jr(t)}if(!Kr||"Thinking..."===Kr||Kr.startsWith("Error:")){var n="No valid summary available to share.";return console.error("[LLM Content] Share failed: "+n),void Jr(n)}if(!Xr){var r="No original content selected to share.";return console.error("[LLM Content] Share failed: "+r),void Jr(r)}chrome.storage.sync.get([Yn],(function(e){var t;if(chrome.runtime.lastError)return Jr("Could not retrieve settings for sharing."),void console.error("[LLM Content] Error getting settings for share:",chrome.runtime.lastError);var n=null!==(t=e[Yn])&&void 0!==t&&t,r=[];try{if(r=JSON.parse(Kr),!Array.isArray(r))throw new Error("Last summary is not a valid JSON array.")}catch(e){return console.error("[LLM Content] Error parsing lastSummary for sharing:",e),void Jr("Failed to prepare summary for sharing.")}var o=document.title,i=window.location.href,a="<ul>"+r.map((function(e){return"<li>".concat(Gr(e),"</li>")})).join("")+"</ul>",s=function(e){return zr(e,{debug:arguments.length>1&&void 0!==arguments[1]&&arguments[1]})}(Xr,Yr),l=a+"<hr>"+s;chrome.runtime.sendMessage({action:"shareToNewsblur",options:{title:o,story_url:i,content:l,comments:""}},(function(e){if(chrome.runtime.lastError)return console.error("[LLM Content] Error sending shareToNewsblur message:",chrome.runtime.lastError),void Jr("Error sharing to NewsBlur: "+chrome.runtime.lastError.message);"success"===e.status?(console.log("[LLM Content] Successfully sent NewsBlur share request:",e.result),Jr("Shared to NewsBlur successfully!",!1,3e3)):(Jr("Failed to share to NewsBlur: ".concat(e.message||"Unknown error")),Yr&&console.error("[LLM Content] Failed to share to NewsBlur:",e))})),n&&Qr&&(Yr&&console.log("[LLM Content] Also sending content to Joplin."),Rn(Qr,l,i,!0)),Gt(),V(),pe(),Kr="",Wr="",Xr=null,Zr=null}))}function yo(){return(yo=Ur(Hr().mark((function e(){var i,a;return Hr().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,chrome.storage.sync.get(["debug","joplinToken"]);case 3:i=e.sent,Yr=!!i.debug,Qr=i.joplinToken||null,Yr&&console.log("[LLM Content] Initial Debug mode:",Yr,"Joplin Token Loaded:",Qr?"Yes":"No");try{Yr&&console.log("[LLM Content] Checking for global 'marked' (should be pre-loaded via manifest)."),"undefined"==typeof marked?(console.warn("[LLM Content] Global 'marked' is not defined. Markdown rendering might be affected if utils.js relies on it solely."),Jr&&Gr.toString().includes('typeof marked !== "undefined"')&&Jr("Warning: Markdown library (marked.js) not fully loaded. Some formatting may be basic.",!1,7e3)):Yr&&console.log("[LLM Content] Global 'marked' is available.")}catch(e){console.error("[LLM Content] Error during marked.min.js check:",e),Jr&&Jr("Error with Markdown library. Formatting may not work.",!1,7e3)}if(void 0!==I){e.next=10;break}throw new Error("TurndownService (static import) is undefined.");case 10:if(t){e.next=12;break}throw new Error("Highlighter module not correctly imported or initializeHighlighter is missing.");case 12:if(n){e.next=14;break}throw new Error("FloatingIcon module not correctly imported or initializeFloatingIcon is missing.");case 14:if(r){e.next=16;break}throw new Error("SummaryPopup module not correctly imported or initializePopupManager is missing.");case 16:if(o){e.next=18;break}throw new Error("constants module not correctly imported.");case 18:if("function"==typeof Jr){e.next=20;break}throw new Error("showError function not correctly imported from utils.");case 20:e.next=22;break;case 22:if(Yr&&console.log("[LLM Content] Statically imported modules appear to be available."),te({onElementSelected:io,onElementDeselected:ao,initialDebugState:Yr}),he({initialDebugState:Yr}),Wt({initialDebugState:Yr}),sn=!(null==(s={initialDebugState:Yr})||!s.initialDebugState),chrome.storage.local.get([hn,dn],(function(e){un=e[hn],pn=e[dn],sn&&un&&console.log("[LLM JoplinManager] Loaded last used notebook:",pn,"ID:",un)})),sn&&console.log("[LLM JoplinManager] Initialized."),eo=!0,Yr&&console.log("[LLM Content] Modules initialized flag set to true."),Vr.length>0){for(Yr&&console.log("[LLM Content] Processing ".concat(Vr.length," queued messages."));Vr.length>0;)go((a=Vr.shift()).req,a.sender,a.sendResponse);Yr&&console.log("[LLM Content] Finished processing queued messages.")}console.log("[LLM Content] Script Initialized. Modules ready."),e.next=39;break;case 33:e.prev=33,e.t0=e.catch(0),console.error("[LLM Content] CRITICAL: Failed to load/initialize components.",e.t0),(Jr||console.error)("Error: OpenRouter Summarizer failed to load components (".concat(e.t0.message,"). Please try reloading the page or reinstalling the extension.")),eo=!1;case 39:case"end":return e.stop()}var s}),e,null,[[0,33]])})))).apply(this,arguments)}chrome.runtime.onMessage.addListener((function(e,t,n){return eo?go(e,0,n):(Yr&&console.warn("[LLM Content] Message received before modules initialized, queuing:",e.action,"Queue size:",Vr.length+1),Vr.push({req:e,sender:t,sendResponse:n}),!0)})),function(){yo.apply(this,arguments)}()})();